{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Raspberry Pi Controlled Experiment (PiE) A manuscript describing the PiE system is now on bioRxiv !!! Benedict J and Cudmore RH (2023) PiE: An open source pipeline for home cage behavioral analysis. bioRxiv 2023.05.05.539097; doi: https://doi.org/10.1101/2023.05.05.539097 Getting started Follow the install instruction and then control the PiE server with the web interface . Use the commander to control any number of behavior boxes. Use the VideoAnnotate desktop application to score the recorded videos with an easy to use GUI. Build Options Video recording. Use the PiE server to record video. All that is needed is a Raspberry Pi and a Pi camera. Behavior Box . Use the PiE server to record video, control IR and white lights, control a fan, and log the temperature/humidity. Getting in touch Please email rhcudmore [at] ucdavis.edu with questions or open a GitHub issue . If you are interested in customizing the PiE system for a particular experiment, contact us and we can get you started. The Cudmore lab is actively improving and expanding the PiE system and is dedicated to its maintenance into the future. Future directions On the scope video recording . Use the PiE server to trigger video recording on a microscope and to log events (including microscope frame) to a file . Full treadmill system . Use the PiE server to record synchronized video on a scope while controlling a motorized treadmill.","title":"Home"},{"location":"#raspberry-pi-controlled-experiment-pie","text":"A manuscript describing the PiE system is now on bioRxiv !!! Benedict J and Cudmore RH (2023) PiE: An open source pipeline for home cage behavioral analysis. bioRxiv 2023.05.05.539097; doi: https://doi.org/10.1101/2023.05.05.539097","title":"Raspberry Pi Controlled Experiment (PiE)"},{"location":"#getting-started","text":"Follow the install instruction and then control the PiE server with the web interface . Use the commander to control any number of behavior boxes. Use the VideoAnnotate desktop application to score the recorded videos with an easy to use GUI.","title":"Getting started"},{"location":"#build-options","text":"Video recording. Use the PiE server to record video. All that is needed is a Raspberry Pi and a Pi camera. Behavior Box . Use the PiE server to record video, control IR and white lights, control a fan, and log the temperature/humidity.","title":"Build Options"},{"location":"#getting-in-touch","text":"Please email rhcudmore [at] ucdavis.edu with questions or open a GitHub issue . If you are interested in customizing the PiE system for a particular experiment, contact us and we can get you started. The Cudmore lab is actively improving and expanding the PiE system and is dedicated to its maintenance into the future.","title":"Getting in touch"},{"location":"#future-directions","text":"On the scope video recording . Use the PiE server to trigger video recording on a microscope and to log events (including microscope frame) to a file . Full treadmill system . Use the PiE server to record synchronized video on a scope while controlling a motorized treadmill.","title":"Future directions"},{"location":"about/","text":"The PiE server and the behavior boxes were designed in collaboration with Jessie Benedict at JHMI. All code is maintained by Robert Cudmore . History This project is evolving from 2016 to present. It began as more than three different projects, one for video recording , one for the home-cage/behavior box , and another for the treadmill . The functionality of all these projects have been merged into the current PiE server. Open Source The PiE server only exists because of the massive amount of hard-work, creativity, and expertise that has been put in to creating and maintaining a multiplicity of open-source software projects. Raspberry Pi Raspberry Pi Foundation - Design, manufacture, and distribute the Raspberry Pi Raspian - The operating system that runs on the Raspberry Pi Raspberry GPIO - To control and interact with the real world Pigpio - A more precise deamon based GPIO interface PiCamera - Python package to control the Raspberry Pi camera Server Debian - Operating system NGINX - Web server for load balancing, microservices, and API gateways uwsgi - Web standard for NGINX to talk to Python Python (back-end) Flask - Web microframework Socketio - Bidirectional communication between web browser and Python SciPy - Scientific computing ecosystem NumPy - Scientific computing for Python Pandas - Data analysis library Matplotlib - Plotting Tifffile - General purpose Tiff file library Redis - Database Celery - Distributed task queue Javascript (front-end) Angular - Superheroic Javascript framework JQuery - Fast, small, and feature-rich JavaScript library D3 - Data driven documents Leaflet - Interactive maps Plotly - Modern analytics for the data era Bootstrap - Worlds most popular HTML/CSS/JS Toolkit Containers Docker - Software containers are the future Programming microcontrollers PlatformIO - An open source ecosystem for IoT development Documentation Jekyll - Static site generator (Main Map Manager documentation) mkDocs - Static site generator (This Website) using the Material theme. Sphinx - To create documentation ( PyMapManager API Documentation ) Distribution Git - Fast version control Github - Software development platform for online storage/sharing/computation PyPi - Python package index for online distribution Travis - Test and Deploy with Confidence Online help Stack Overflow - Where Developers Learn, Share, & Build","title":"About"},{"location":"about/#history","text":"This project is evolving from 2016 to present. It began as more than three different projects, one for video recording , one for the home-cage/behavior box , and another for the treadmill . The functionality of all these projects have been merged into the current PiE server.","title":"History"},{"location":"about/#open-source","text":"The PiE server only exists because of the massive amount of hard-work, creativity, and expertise that has been put in to creating and maintaining a multiplicity of open-source software projects.","title":"Open Source"},{"location":"about/#raspberry-pi","text":"Raspberry Pi Foundation - Design, manufacture, and distribute the Raspberry Pi Raspian - The operating system that runs on the Raspberry Pi Raspberry GPIO - To control and interact with the real world Pigpio - A more precise deamon based GPIO interface PiCamera - Python package to control the Raspberry Pi camera","title":"Raspberry Pi"},{"location":"about/#server","text":"Debian - Operating system NGINX - Web server for load balancing, microservices, and API gateways uwsgi - Web standard for NGINX to talk to Python","title":"Server"},{"location":"about/#python-back-end","text":"Flask - Web microframework Socketio - Bidirectional communication between web browser and Python SciPy - Scientific computing ecosystem NumPy - Scientific computing for Python Pandas - Data analysis library Matplotlib - Plotting Tifffile - General purpose Tiff file library Redis - Database Celery - Distributed task queue","title":"Python (back-end)"},{"location":"about/#javascript-front-end","text":"Angular - Superheroic Javascript framework JQuery - Fast, small, and feature-rich JavaScript library D3 - Data driven documents Leaflet - Interactive maps Plotly - Modern analytics for the data era Bootstrap - Worlds most popular HTML/CSS/JS Toolkit","title":"Javascript (front-end)"},{"location":"about/#containers","text":"Docker - Software containers are the future","title":"Containers"},{"location":"about/#programming-microcontrollers","text":"PlatformIO - An open source ecosystem for IoT development","title":"Programming microcontrollers"},{"location":"about/#documentation","text":"Jekyll - Static site generator (Main Map Manager documentation) mkDocs - Static site generator (This Website) using the Material theme. Sphinx - To create documentation ( PyMapManager API Documentation )","title":"Documentation"},{"location":"about/#distribution","text":"Git - Fast version control Github - Software development platform for online storage/sharing/computation PyPi - Python package index for online distribution Travis - Test and Deploy with Confidence","title":"Distribution"},{"location":"about/#online-help","text":"Stack Overflow - Where Developers Learn, Share, & Build","title":"Online help"},{"location":"commander/","text":"Commander is a web server to control any number of PiE servers running on different computers. The commander can be run on Linux, macOS, and Microsoft windows. Requirements Commander requires Python 3.8 or greater. Install Clone the source git clone https://github.com/cudmore/pie Make a virtual envirnment named commander_env . python -m venv commander_env source commander_env/bin/activate Install required packages cd pie cd commander_app pip install -r requirements.txt Run the commander ./commander run Browse Once installed and running and assuming there are no errors, the commander interface can be browsed at http://[IP]:8000 where [IP] is the IP address of your computer. http://[IP]:8000 When running locally, use 'localhost' in place of [IP], like this http://localhost:8000 Starting and stopping commander server (Linux only) The commander server is designed to run in the background and can be controlled using the ~/pie/commander_app/commander command. cd ~/pie/commander_app ./commander start - start the background commander server ./commander stop - stop the backgorund commander server ./commander restart - restart the background commander server ./commander status - get the status of the background commander server ./commander enable - start the background commander server at boot ./commander disable - do not start the background commander server at boot ==================== ./commander run - run commander on command line If you run into trouble with the commander, run it on the command line to see the output with ./commander run . Web interface Editing IP addresses In the config section, turn on 'edit ip' checkbox. Enter a valid IP and hit enter. If the IP is for a running PiE server (no port number needed), the red (bad connection) will be replaced with the current status of the specified PiE server. See 'Server Swarm' below. Warnings and errors When a PiE server is connected, the corresponding row in 'Server Swarm' will be filled in and active. When there is a connection error, the first column will appear red and all other controls will be inactive. When the drive space remaining goes below 5 GB, the 'File' column will be displayed in red. Currently, there is no interface to set this trip-point, 5 GB is hard-coded in the commander index.html. Feel free to change it yourself. Server swarm Here, the commander is controlling 8 PiE servers. Server 3 (hc3) is recording, server 7 has a connection error, and server 8 (hc8) is streaming. Click image to enlarge. Swarm status The swarm status is a clearinghouse of information for each PiE server. This includes buttons to restart the PiE server and reboot the raspberry Pi. Click image to enlarge. Video wall Commander sync The commander sync will sychronize files from any number of PiE servers to the computer running the commander. todo: ADD IMAGE Advanced usage When the commander is run it will create a 'commander_config' folder in your User folder. In this configuration folder is a configuration json file to control the commander. Here, you can control the PiE servers in the commander (can also be set in the web interface). You can also control the destination folder for downloaded files by specifying 'localFolder'. Make sure 'localFolder' is a full path to a folder on your computer. Something like '/Users/cudmore/commander_data'. Finally, make sure the download folder actually exists! Once this json configuration file is changed, restart the commander and reload the web-page with 'ctrl+r' for a full refresh. If you make errors in editing the json file, you will see them in the commander logs on the command prompt or in 'commander_config/commander.log'. { \"localFolder\": \"\", \"serverList\": [ { \"ip\": \"192.168.1.4\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"192.168.1.15\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"192.168.1.3\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.33\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.34\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.35\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.36\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.37\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.38\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.39\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.41\", \"password\": \"\", \"username\": \"\" } ], \"sshTimeout\": 2 } Troubleshooting Run the commander manually ./install-commander installs a python virtual env in ~/pie/commander_app/commander_env. The commander server needs to be run in this environment. # activate virtual environment in commander_env cd ~/pie/commander_app source commander_env/bin/activate # command prompt should now start with '(commander_env)'. # run the commander server manually python commander.py","title":"Commander"},{"location":"commander/#requirements","text":"Commander requires Python 3.8 or greater.","title":"Requirements"},{"location":"commander/#install","text":"Clone the source git clone https://github.com/cudmore/pie Make a virtual envirnment named commander_env . python -m venv commander_env source commander_env/bin/activate Install required packages cd pie cd commander_app pip install -r requirements.txt Run the commander ./commander run","title":"Install"},{"location":"commander/#browse","text":"Once installed and running and assuming there are no errors, the commander interface can be browsed at http://[IP]:8000 where [IP] is the IP address of your computer. http://[IP]:8000 When running locally, use 'localhost' in place of [IP], like this http://localhost:8000","title":"Browse"},{"location":"commander/#starting-and-stopping-commander-server-linux-only","text":"The commander server is designed to run in the background and can be controlled using the ~/pie/commander_app/commander command. cd ~/pie/commander_app ./commander start - start the background commander server ./commander stop - stop the backgorund commander server ./commander restart - restart the background commander server ./commander status - get the status of the background commander server ./commander enable - start the background commander server at boot ./commander disable - do not start the background commander server at boot ==================== ./commander run - run commander on command line If you run into trouble with the commander, run it on the command line to see the output with ./commander run .","title":"Starting and stopping commander server (Linux only)"},{"location":"commander/#web-interface","text":"","title":"Web interface"},{"location":"commander/#editing-ip-addresses","text":"In the config section, turn on 'edit ip' checkbox. Enter a valid IP and hit enter. If the IP is for a running PiE server (no port number needed), the red (bad connection) will be replaced with the current status of the specified PiE server. See 'Server Swarm' below.","title":"Editing IP addresses"},{"location":"commander/#warnings-and-errors","text":"When a PiE server is connected, the corresponding row in 'Server Swarm' will be filled in and active. When there is a connection error, the first column will appear red and all other controls will be inactive. When the drive space remaining goes below 5 GB, the 'File' column will be displayed in red. Currently, there is no interface to set this trip-point, 5 GB is hard-coded in the commander index.html. Feel free to change it yourself.","title":"Warnings and errors"},{"location":"commander/#server-swarm","text":"Here, the commander is controlling 8 PiE servers. Server 3 (hc3) is recording, server 7 has a connection error, and server 8 (hc8) is streaming. Click image to enlarge.","title":"Server swarm"},{"location":"commander/#swarm-status","text":"The swarm status is a clearinghouse of information for each PiE server. This includes buttons to restart the PiE server and reboot the raspberry Pi. Click image to enlarge.","title":"Swarm status"},{"location":"commander/#video-wall","text":"","title":"Video wall"},{"location":"commander/#commander-sync","text":"The commander sync will sychronize files from any number of PiE servers to the computer running the commander. todo: ADD IMAGE","title":"Commander sync"},{"location":"commander/#advanced-usage","text":"When the commander is run it will create a 'commander_config' folder in your User folder. In this configuration folder is a configuration json file to control the commander. Here, you can control the PiE servers in the commander (can also be set in the web interface). You can also control the destination folder for downloaded files by specifying 'localFolder'. Make sure 'localFolder' is a full path to a folder on your computer. Something like '/Users/cudmore/commander_data'. Finally, make sure the download folder actually exists! Once this json configuration file is changed, restart the commander and reload the web-page with 'ctrl+r' for a full refresh. If you make errors in editing the json file, you will see them in the commander logs on the command prompt or in 'commander_config/commander.log'. { \"localFolder\": \"\", \"serverList\": [ { \"ip\": \"192.168.1.4\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"192.168.1.15\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"192.168.1.3\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.33\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.34\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.35\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.36\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.37\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.38\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.39\", \"password\": \"\", \"username\": \"\" }, { \"ip\": \"10.16.81.41\", \"password\": \"\", \"username\": \"\" } ], \"sshTimeout\": 2 }","title":"Advanced usage"},{"location":"commander/#troubleshooting","text":"","title":"Troubleshooting"},{"location":"commander/#run-the-commander-manually","text":"./install-commander installs a python virtual env in ~/pie/commander_app/commander_env. The commander server needs to be run in this environment. # activate virtual environment in commander_env cd ~/pie/commander_app source commander_env/bin/activate # command prompt should now start with '(commander_env)'. # run the commander server manually python commander.py","title":"Run the commander manually"},{"location":"file-server/","text":"This is a recipe for configuring a Raspberry Pi as a file-server. Once configured as a file-server, files on the Raspberry Pi can be easily opened/edited/copied from a remote computer. This is useful for copying recorded video off the Raspberry Pi to another (remote) computer for archiving and analysis. If you are working on a Windows machine, you need to use Samba . If you are working on macOS you want to use AFP but can also use Samba . 2023 Install netatalk (AFP) Following this tutorial . Install netatalk sudo apt install netatalk Then configure netatalk. The nano command will run a little text editor inside the terminal. Use the up/down arrows to position the cursor (not the mouse) sudo nano /etc/netatalk/afp.conf and copy/paste this at the end of the file [$h] path = /home home name = $h Exit nano with keyboard ctrl x Restart netatalk with sudo systemctl restart netatalk To test this out, on a macOS computer select the main menu Go ... Connect to server ... and type afp:\\\\ followed by the IP address of your PI. In this example we are using 192.168.1.17 but your IP is most probably different. afp:\\\\192.168.1.17 You should see your Pi mount onto your desktop or finder and you can start browsing files. 2023 Install SAMBA (SMB) Following this tutorial . Install samba sudo apt-get install samba samba-common-bin Make a folder to hold video (the PiE server requires this) mkdir /home/pi/shared Edit the smb configuration file with nano . You can move the cursor with up/down arow keys (not the mouse) sudo nano /etc/samba/smb.conf Copy and paste the following to the end of the file [video] path = /home/pi/video writeable=Yes create mask=0777 directory mask=0777 public=no Set a samba password sudo smbpasswd -a pi Restart samba sudo systemctl restart smbd To test this out, on a macOS computer select the main menu Go ... Connect to server ... and type smb:\\\\ followed by the IP address of your PI. In this example we are using 192.168.1.17 but your IP is most probably different. smb:\\\\192.168.1.17 Your Pi is now a samba file server !!! You could put your IT department out of business... Old, Samba (SMB) This is a recipe to make a Raspberry Pi a Samba (SMB) file-server that can be accessed from both Windows and macOS. 1) Install Samba sudo apt-get install samba samba-common-bin 2) Edit /etc/samba/smb.conf sudo pico /etc/samba/smb.conf When using the pico editor, ctrl+x to save and quit, ctrl+w to search, ctrl+v to page down. Remember, the pico editor does not respond to mouse clicks, you need to move the cursor around with arrow keys. 3) Add the following to the end of the smb.conf file. In the Pico editor, move the cursor to the end of the file and copy and paste the following. [video] Comment = Pi video shared folder Path = /home/pi/video Browseable = yes Writeable = yes only guest = no create mask = 0777 directory mask = 0777 Public = yes Guest ok = no [home] Comment = Pi shared folder Path = /home/pi Browseable = yes Writeable = yes only guest = no create mask = 0777 directory mask = 0777 Public = yes Guest ok = no 4) Create a Samba password sudo smbpasswd -a pi 5) Restart Samba sudo /etc/init.d/samba restart 6) Test the server from another machine on the network. On a Windows machine, mount the Raspberry Pi Samba file-server with smb:\\\\[piIP] where [piIP] is the IP address of your pi. Do this by clicking the 'Start' menu and then typing smb:\\\\[piIP] . Old, Apple-File-Protocol (AFP) This is a recipe to make a Raspberry Pi an Apple-File-Protocol (AFP) file-server that can be accessed from macOS. 1) Install netatalk sudo apt-get install netatalk Once netatalk is installed, the Raspberry Pi will show up in the macOS Finder 'Shared' section. The Pi can be mounted in the macOS Finder by going to Go - Connect To Server... and entering afp://[piIP] where [piIP] is the IP address of your Pi. 2) Changing the default name of a Pi in netatalk When a Pi is mounted in macOS using AFP, it will mount as Home Directory . If you have multiple Raspberry Pi computers they all mount with the same 'Home Directory' name which can be confusing. Thus, you want to change the 'mount point' name of each Raspberry Pi. For more information, see this blog post to change the name of the mount point from 'Home Directory'. Or just follow along ... Stop netatalk sudo /etc/init.d/netatalk stop Edit the netatalk config file sudo pico /etc/netatalk/AppleVolumes.default When using the pico editor, ctrl+x to save and quit, ctrl+w to search, ctrl+v to page down. Remember, the pico editor does not respond to mouse clicks, you need to move the cursor around with arrow keys. Scroll to the bottom of the file and change this one line where 'the_name_you_want' should be the name you want the given Raspberry Pi to mount as. The '#' is used as a comment and is ignored. # By default all users have access to their home directories. #~/ \"Home Directory\" ~/ \"the_name_you_want\" 3) Restart netatalk sudo /etc/init.d/netatalk start 4) Test the server from another machine on the network. In the macOS Finder, go to Go - Connect To Server... and enter afp://[piIP] where [piIP] is the IP address of your Pi.","title":"File Server"},{"location":"file-server/#2023-install-netatalk-afp","text":"Following this tutorial . Install netatalk sudo apt install netatalk Then configure netatalk. The nano command will run a little text editor inside the terminal. Use the up/down arrows to position the cursor (not the mouse) sudo nano /etc/netatalk/afp.conf and copy/paste this at the end of the file [$h] path = /home home name = $h Exit nano with keyboard ctrl x Restart netatalk with sudo systemctl restart netatalk To test this out, on a macOS computer select the main menu Go ... Connect to server ... and type afp:\\\\ followed by the IP address of your PI. In this example we are using 192.168.1.17 but your IP is most probably different. afp:\\\\192.168.1.17 You should see your Pi mount onto your desktop or finder and you can start browsing files.","title":"2023 Install netatalk (AFP)"},{"location":"file-server/#2023-install-samba-smb","text":"Following this tutorial . Install samba sudo apt-get install samba samba-common-bin Make a folder to hold video (the PiE server requires this) mkdir /home/pi/shared Edit the smb configuration file with nano . You can move the cursor with up/down arow keys (not the mouse) sudo nano /etc/samba/smb.conf Copy and paste the following to the end of the file [video] path = /home/pi/video writeable=Yes create mask=0777 directory mask=0777 public=no Set a samba password sudo smbpasswd -a pi Restart samba sudo systemctl restart smbd To test this out, on a macOS computer select the main menu Go ... Connect to server ... and type smb:\\\\ followed by the IP address of your PI. In this example we are using 192.168.1.17 but your IP is most probably different. smb:\\\\192.168.1.17 Your Pi is now a samba file server !!! You could put your IT department out of business...","title":"2023 Install SAMBA (SMB)"},{"location":"file-server/#old-samba-smb","text":"This is a recipe to make a Raspberry Pi a Samba (SMB) file-server that can be accessed from both Windows and macOS.","title":"Old, Samba (SMB)"},{"location":"file-server/#1-install-samba","text":"sudo apt-get install samba samba-common-bin","title":"1) Install Samba"},{"location":"file-server/#2-edit-etcsambasmbconf","text":"sudo pico /etc/samba/smb.conf When using the pico editor, ctrl+x to save and quit, ctrl+w to search, ctrl+v to page down. Remember, the pico editor does not respond to mouse clicks, you need to move the cursor around with arrow keys.","title":"2) Edit /etc/samba/smb.conf"},{"location":"file-server/#3-add-the-following-to-the-end-of-the-smbconf-file","text":"In the Pico editor, move the cursor to the end of the file and copy and paste the following. [video] Comment = Pi video shared folder Path = /home/pi/video Browseable = yes Writeable = yes only guest = no create mask = 0777 directory mask = 0777 Public = yes Guest ok = no [home] Comment = Pi shared folder Path = /home/pi Browseable = yes Writeable = yes only guest = no create mask = 0777 directory mask = 0777 Public = yes Guest ok = no","title":"3) Add the following to the end of the smb.conf file."},{"location":"file-server/#4-create-a-samba-password","text":"sudo smbpasswd -a pi","title":"4) Create a Samba password"},{"location":"file-server/#5-restart-samba","text":"sudo /etc/init.d/samba restart","title":"5) Restart Samba"},{"location":"file-server/#6-test-the-server-from-another-machine-on-the-network","text":"On a Windows machine, mount the Raspberry Pi Samba file-server with smb:\\\\[piIP] where [piIP] is the IP address of your pi. Do this by clicking the 'Start' menu and then typing smb:\\\\[piIP] .","title":"6) Test the server from another machine on the network."},{"location":"file-server/#old-apple-file-protocol-afp","text":"This is a recipe to make a Raspberry Pi an Apple-File-Protocol (AFP) file-server that can be accessed from macOS.","title":"Old, Apple-File-Protocol (AFP)"},{"location":"file-server/#1-install-netatalk","text":"sudo apt-get install netatalk Once netatalk is installed, the Raspberry Pi will show up in the macOS Finder 'Shared' section. The Pi can be mounted in the macOS Finder by going to Go - Connect To Server... and entering afp://[piIP] where [piIP] is the IP address of your Pi.","title":"1) Install netatalk"},{"location":"file-server/#2-changing-the-default-name-of-a-pi-in-netatalk","text":"When a Pi is mounted in macOS using AFP, it will mount as Home Directory . If you have multiple Raspberry Pi computers they all mount with the same 'Home Directory' name which can be confusing. Thus, you want to change the 'mount point' name of each Raspberry Pi. For more information, see this blog post to change the name of the mount point from 'Home Directory'. Or just follow along ... Stop netatalk sudo /etc/init.d/netatalk stop Edit the netatalk config file sudo pico /etc/netatalk/AppleVolumes.default When using the pico editor, ctrl+x to save and quit, ctrl+w to search, ctrl+v to page down. Remember, the pico editor does not respond to mouse clicks, you need to move the cursor around with arrow keys. Scroll to the bottom of the file and change this one line where 'the_name_you_want' should be the name you want the given Raspberry Pi to mount as. The '#' is used as a comment and is ignored. # By default all users have access to their home directories. #~/ \"Home Directory\" ~/ \"the_name_you_want\"","title":"2) Changing the default name of a Pi in netatalk"},{"location":"file-server/#3-restart-netatalk","text":"sudo /etc/init.d/netatalk start","title":"3) Restart netatalk"},{"location":"file-server/#4-test-the-server-from-another-machine-on-the-network","text":"In the macOS Finder, go to Go - Connect To Server... and enter afp://[piIP] where [piIP] is the IP address of your Pi.","title":"4) Test the server from another machine on the network."},{"location":"gpio-timing/","text":"The Raspberry Pi is running a fully functional operating system which provides many features including USB, ethernet, and HDMI. Thus, there will be unpredictable delays in receiving and generating general purpose input and output (GPIO). The PiE server uses the Raspberry GPIO python package by default and will use the pigpio daemon if it is installed and running. The GPIO package has a jitter of approximately +/- 2 ms for all DIO with occasional, < 1%, events having absurd jitter on the order of 100-200 ms. This includes trigger in, frame in, and any output. If you are using the PiE server to record video this should be fine. If you want more precision, either offload your timing critical tasks on a Teensy or use the Raspberry pigpiod daemon. See the Jupyter notebooks in the pie/analysis/ folder for a comparising of frame arrival times using GPIO versus pigpio. Download and install pigpio cd rm pigpio.zip sudo rm -rf PIGPIO wget abyz.me.uk/rpi/pigpio/pigpio.zip unzip pigpio.zip cd PIGPIO make sudo make install To start the pigpio daemon sudo pigpiod To stop the pigpio daemon sudo killall pigpiod","title":"GPIO Timing"},{"location":"gpio-timing/#download-and-install-pigpio","text":"cd rm pigpio.zip sudo rm -rf PIGPIO wget abyz.me.uk/rpi/pigpio/pigpio.zip unzip pigpio.zip cd PIGPIO make sudo make install","title":"Download and install pigpio"},{"location":"gpio-timing/#to-start-the-pigpio-daemon","text":"sudo pigpiod","title":"To start the pigpio daemon"},{"location":"gpio-timing/#to-stop-the-pigpio-daemon","text":"sudo killall pigpiod","title":"To stop the pigpio daemon"},{"location":"images/","text":"table, td, th { border: 0px solid #ddd; text-align: left; } table { border-collapse: collapse; width: 100%; } th, td { padding: 15px; } The PiE server can be used in different configurations depending on your needs. This currently includes a behavior box for remote (web based) home cage video monitoring and recording, environmental control, and offline video analysis. In the future, we will provide on the scope video recording and control of a motorized treadmill. Behavior Box v2.0 Eight boxes running experiments. Each one can be controlled independently with the simple web interface or all can be monitored and controlled using the commander web interface. View inside one box with a mouse cage with clear plexiglass lid, a water preference experiment, computer controlled lights, temperatures/humidity sensor, fan, and a video camera (just beyond the top of the photo). View of organized electronics on the back of two boxes. Detailed view of electronics on the back of one box. Behavior Box v0.1 Just for a historical note, here was our first prototype of thebehavior box. We have come a long way! Overview Lights and camera Rats nest Future - Treadmill Detailed view of circular treadmill including 10\" acrylic disk (top) Actobotics frame (horizontal aluminum arm) Stepper motor (bottom) Rotary encoder (left) Gears to couple the motor and disk to the rotary encoder Future - Treadmill on the scope","title":"Image Gallery"},{"location":"images/#behavior-box-v20","text":"Eight boxes running experiments. Each one can be controlled independently with the simple web interface or all can be monitored and controlled using the commander web interface. View inside one box with a mouse cage with clear plexiglass lid, a water preference experiment, computer controlled lights, temperatures/humidity sensor, fan, and a video camera (just beyond the top of the photo). View of organized electronics on the back of two boxes. Detailed view of electronics on the back of one box.","title":"Behavior Box v2.0"},{"location":"images/#behavior-box-v01","text":"Just for a historical note, here was our first prototype of thebehavior box. We have come a long way! Overview Lights and camera Rats nest","title":"Behavior Box v0.1"},{"location":"images/#future-treadmill","text":"Detailed view of circular treadmill including 10\" acrylic disk (top) Actobotics frame (horizontal aluminum arm) Stepper motor (bottom) Rotary encoder (left) Gears to couple the motor and disk to the rotary encoder","title":"Future - Treadmill"},{"location":"images/#future-treadmill-on-the-scope","text":"","title":"Future - Treadmill on the scope"},{"location":"implementation-details/","text":"Once running, the PiE server should be simple to use and only requires interaction with its web interface . Yet, for this simple system to work, a number of independent components must each work and must communicate with each other. As is often the case, the details in creating a simple system is complex. What follows is a description of the different pieces of the PiE server with links to the source code and the components that are used. Raspberry Pi At its core, this system requires a functioning Raspberry Pi running the Raspbian operating system. Because this is an intentionally stripped down system, some things are not installed out of the box like mounting a USB drive . On the other hand, this is a full-fledged Debian Linux system so you can activate powerful features such as a file-server . Back End Web server pie_app/treadmill_app.py - This code creates the main PiE web server (running on port 5010) using Flask and is the main starting point to run the PiE server. It acts as a connection between web requests (URLs) and the backend by processing each incoming URL and calling the appropriate backend code in pie_app/treadmill.py . Python class library pie_app/treadmill.py - Wrapper class around pie_app/bTrial.py to implement specifics of the PiE server beyond what bTrial provides. This mainly includes some logic using web sockets, in particular flask-socketio , for bi-directional communication from the browser to the backend and from the backend to the browser. pie_app/bTrial.py - Main catch-all class that implements the logic of a trial based experiment. When it is instantiated, it creates a number of background threads to control independent processes including: GPIO pins, the timing of automatic lights, temperature/humidity readings, and serial communication with a Teensy. The use of background threads is important, they are run in parallel to the main code (utilizing the Raspberry Pis 4-core CPU) and allow everything to run smoothly with minimal blocking . Once running, bTrial receives commands from the web interface in treadmill_app.py to take actions like: changing/loading/saving user configurations, starting/stopping video recording and streaming, setting GPIO pins, and performing serial communication with a Teensy. pie_app/bCamera.py - Code to control a Raspberry Pi camera using the piCamera Python library. This is where both video recording and streaming with uv4l is started and stopped. This also contains a background thread that uses avconv to convert .h264 video saved by the camera into .mp4. pie_app/bPins.py - Code to control the Raspberry Pi GPIO pins using either RPi.GPIO or the pigpio daemon. This is where the PiE server can change GPIO pins and where code is triggered when a pin changes from an external source like a microscope. pie_app/bSerial.py - Code to communicate with an Arduino/Teensy microcontroller over a serial connection (via a USB cable). This is basically to get and set parameters as well as starting/stopping a trial on the Teensy. It works as a background thread instantiated by bTrial and then sits silently waiting for commands to be inserted into a queue. This is not used to program the Teensy, that is handled by platformio pie_app/bUtil.py - Implements basic utility functions like fetching the system date/time, determining the amount of drive space remaining, and getting the IP address and hostname. pie_app/config - Text files written in json that provides human editable configuration options for the server. These json files are loaded when the server starts and are saved when the user saves from the web interface. These json files contain all the configurable options provided by the PiE server, things like the default state of GPIO pins and configurations like the video recording duration and number of repeats. Front End The backend web server in pie_app/treadmill_app.py delivers .html pages which have logic driven by Javascript (.js) and formatted with .css. pie_app/templates/index.html - Main web interface written in html , uses Javascript and the Javascript Angular library to provide dynamic and real-time content. pie_app/static/treadmill.js - Javascript code that implementes the logic of the web interface. Has functions that get called when user is clicking or entering parameter values. Also has function to talk to treadmill_app.py web server via a REST interface. This is not standard Javascript but is using the Angular library. pie_app/static/treadmill.css - A Cascading Style Sheet (css) text file that describes the precise visual layout of the web pages. Miscellaneous - Each webpage served by the PiE server needs a .html file and often uses a Javascript .js file to control the logic of user interaction. This includes videolist.html which serves a list of video files saved on the Pi and environment.html along with environment.js which controls the web based plotting of temperature and humidity. Admin server The admin_app contains a second web server (running on port 5011) allowing the main PiE server (running on port 5010) to be restarted and the Raspberry Pi to be rebooted. This is necessary to allow all this to happen from the PiE web interface . This admin app is automatically installed when the PiE server is installed with ./install-pie and should not need further tweaking. Commander server The commander_app creates a web interface (running on port 8000) to control any number of PiE servers (on port 5010) running on different Raspberry Pis. The commander server runs completely independent of the PiE server and can be installed on its own dedicated Raspberry Pi or one that is already running the PiE server. See the commander documentation for more details. Note.. In a near future version, the commander will be able to run on any other machine including macOS and Microsoft Windows computers. Components uv4l The uv4l system is used to streaming video from the camera to a web browser. This is a system wide program and is controlled from bCamera using bash script in pie_app/bin . avconv The avconv package (also known as libav) is used to convert .h264 files saved by the camera to .mp4. This is a system wide program and is controlled from bCamera using bash script in pie_app/bin . DHT sensors Readings from AM2302 and DHT22 temperature/humidity sensors requires the Adafruit Python library Adafruit_Python_DHT . Readings are implemented in a background task in bTrial. Documentation Last but not least, this website is written in markdown . The markdown and a description of the contents using yaml are brought together, compiled, and a static site is generated by mkdocs . The final layout is controlled by an mkdocs theme called material . All of this is then pushed to Github which serves this website fast and reliable.","title":"Implementation details"},{"location":"implementation-details/#raspberry-pi","text":"At its core, this system requires a functioning Raspberry Pi running the Raspbian operating system. Because this is an intentionally stripped down system, some things are not installed out of the box like mounting a USB drive . On the other hand, this is a full-fledged Debian Linux system so you can activate powerful features such as a file-server .","title":"Raspberry Pi"},{"location":"implementation-details/#back-end","text":"","title":"Back End"},{"location":"implementation-details/#web-server","text":"pie_app/treadmill_app.py - This code creates the main PiE web server (running on port 5010) using Flask and is the main starting point to run the PiE server. It acts as a connection between web requests (URLs) and the backend by processing each incoming URL and calling the appropriate backend code in pie_app/treadmill.py .","title":"Web server"},{"location":"implementation-details/#python-class-library","text":"pie_app/treadmill.py - Wrapper class around pie_app/bTrial.py to implement specifics of the PiE server beyond what bTrial provides. This mainly includes some logic using web sockets, in particular flask-socketio , for bi-directional communication from the browser to the backend and from the backend to the browser. pie_app/bTrial.py - Main catch-all class that implements the logic of a trial based experiment. When it is instantiated, it creates a number of background threads to control independent processes including: GPIO pins, the timing of automatic lights, temperature/humidity readings, and serial communication with a Teensy. The use of background threads is important, they are run in parallel to the main code (utilizing the Raspberry Pis 4-core CPU) and allow everything to run smoothly with minimal blocking . Once running, bTrial receives commands from the web interface in treadmill_app.py to take actions like: changing/loading/saving user configurations, starting/stopping video recording and streaming, setting GPIO pins, and performing serial communication with a Teensy. pie_app/bCamera.py - Code to control a Raspberry Pi camera using the piCamera Python library. This is where both video recording and streaming with uv4l is started and stopped. This also contains a background thread that uses avconv to convert .h264 video saved by the camera into .mp4. pie_app/bPins.py - Code to control the Raspberry Pi GPIO pins using either RPi.GPIO or the pigpio daemon. This is where the PiE server can change GPIO pins and where code is triggered when a pin changes from an external source like a microscope. pie_app/bSerial.py - Code to communicate with an Arduino/Teensy microcontroller over a serial connection (via a USB cable). This is basically to get and set parameters as well as starting/stopping a trial on the Teensy. It works as a background thread instantiated by bTrial and then sits silently waiting for commands to be inserted into a queue. This is not used to program the Teensy, that is handled by platformio pie_app/bUtil.py - Implements basic utility functions like fetching the system date/time, determining the amount of drive space remaining, and getting the IP address and hostname. pie_app/config - Text files written in json that provides human editable configuration options for the server. These json files are loaded when the server starts and are saved when the user saves from the web interface. These json files contain all the configurable options provided by the PiE server, things like the default state of GPIO pins and configurations like the video recording duration and number of repeats.","title":"Python class library"},{"location":"implementation-details/#front-end","text":"The backend web server in pie_app/treadmill_app.py delivers .html pages which have logic driven by Javascript (.js) and formatted with .css. pie_app/templates/index.html - Main web interface written in html , uses Javascript and the Javascript Angular library to provide dynamic and real-time content. pie_app/static/treadmill.js - Javascript code that implementes the logic of the web interface. Has functions that get called when user is clicking or entering parameter values. Also has function to talk to treadmill_app.py web server via a REST interface. This is not standard Javascript but is using the Angular library. pie_app/static/treadmill.css - A Cascading Style Sheet (css) text file that describes the precise visual layout of the web pages. Miscellaneous - Each webpage served by the PiE server needs a .html file and often uses a Javascript .js file to control the logic of user interaction. This includes videolist.html which serves a list of video files saved on the Pi and environment.html along with environment.js which controls the web based plotting of temperature and humidity.","title":"Front End"},{"location":"implementation-details/#admin-server","text":"The admin_app contains a second web server (running on port 5011) allowing the main PiE server (running on port 5010) to be restarted and the Raspberry Pi to be rebooted. This is necessary to allow all this to happen from the PiE web interface . This admin app is automatically installed when the PiE server is installed with ./install-pie and should not need further tweaking.","title":"Admin server"},{"location":"implementation-details/#commander-server","text":"The commander_app creates a web interface (running on port 8000) to control any number of PiE servers (on port 5010) running on different Raspberry Pis. The commander server runs completely independent of the PiE server and can be installed on its own dedicated Raspberry Pi or one that is already running the PiE server. See the commander documentation for more details. Note.. In a near future version, the commander will be able to run on any other machine including macOS and Microsoft Windows computers.","title":"Commander server"},{"location":"implementation-details/#components","text":"","title":"Components"},{"location":"implementation-details/#uv4l","text":"The uv4l system is used to streaming video from the camera to a web browser. This is a system wide program and is controlled from bCamera using bash script in pie_app/bin .","title":"uv4l"},{"location":"implementation-details/#avconv","text":"The avconv package (also known as libav) is used to convert .h264 files saved by the camera to .mp4. This is a system wide program and is controlled from bCamera using bash script in pie_app/bin .","title":"avconv"},{"location":"implementation-details/#dht-sensors","text":"Readings from AM2302 and DHT22 temperature/humidity sensors requires the Adafruit Python library Adafruit_Python_DHT . Readings are implemented in a background task in bTrial.","title":"DHT sensors"},{"location":"implementation-details/#documentation","text":"Last but not least, this website is written in markdown . The markdown and a description of the contents using yaml are brought together, compiled, and a static site is generated by mkdocs . The final layout is controlled by an mkdocs theme called material . All of this is then pushed to Github which serves this website fast and reliable.","title":"Documentation"},{"location":"install-buster/","text":"Overview This is a recipe to prepare a Raspberry Pi computer to use with a PiE server. The general steps we will follow are as follows: Install the Raspberry Pi OS named buster onto an SD card. Boot the Pi with the SD card and find its IP on a local network. Login to the Pi with ssh. Configure the Pi with sudo raspi-config . Mount a USB drive This might seem daungting but if you take each step methodically, you can do it. If you have done it a few times, it should take about 20 minutes . Required hardware For this initial setup you will need the following: A residential router connected to the internet A macOS or Windows machine connected to the router An additional ethernet cable for the new Pi If your setting up the Pi to eventually be on a University network, there are some additional requirements. Here we will assume you are on a residential network that you control. This can be acheived by simply bringing everything home and working from there. Download Raspberry Pi Imager These initial steps are done on any internet connected computer (not the Pi). We will use the Raspbery Pi Imager to copy a downloaded Raspberry Pi OS (a .zip or .img file) onto your SD card. Download the Raspberry Pi Imager . Here are direct links for downloading for the macOS and Windows: macOS Download Windows download Download the Raspberry Pi OS (buster) It is CRITICAL that you download and install a slightly older version named Buster . This can be found towards the bottom of the main Raspberry Pi OS download page . You can get there using the 'See all download options' button. Specifically, you want the following: Raspberry Pi OS Lite (Legacy) Release date: February 21st 2023 System: 32-bit Kernel version: 5.10 Debian version: 10 (buster) Size: 286MB Here is a direct link to download the buster xz file . The name of the file you downloaded should be 2023-02-21-raspios-buster-armhf-lite.img.xz . This is a compressed file, on either macOS or Windows uncompress it and you should end up with a new img file named 2023-02-21-raspios-buster-armhf-lite.img . This is what you will install onto the SD card using the Raspberry Pi Imager. Format the SD card You need to format the SD card using the Fat format. If using a macOS computer Insert the SD card Open the 'Disk Utilities' app. It is in Applications:Utilities folder Select your SD card in the left list (make sure you get it right) Select 'Erase' In the Erase dialog select MS-DOS (Fat) and Master Boot Record (MBR) If you are using a Window computer, just follow the prompts when you first insert the SD card or right-click the SD card and format it. Run Raspbery Pi Imager In the Raspberry Pi Imager software ... Select Choose OS and then Use Custom and then select the img file you just uncompressed. Select your SD card. Enable ssh on boot Now the system is on your SD card. You need to enable ssh on boot so you can login to your Pi. An aside. What we are doing here is a bit different than most interactions with computers. The Raspberry Pi, as we are using it, will reamin headless . This means there will never be a monitor, keyboard, or mouse connected to your Pi. All interaction is done through a command prompt using the terminal software called ssh . To enable ssh on boot, you need to make an empty file named ssh on the SD card. On macOS With the SD card inserted, in a Terminal, enable ssh on boot with the following command touch /Volumes/boot/ssh On Windows Use the exporer to view the SD card, it should be named boot . Right-click and create a new text document. Change the name of the new file to just ssh (no extnesion). Goal half-way completed !!! You now have an SD card ready to boot a Raspberry Pi! Go take a break! Power up the Pi Insert the SD card into the Raspberry Pi computer. Attach an ethernet cable from the Pi to your local router. Plug in the USB power. Find the Pi on your local network and get its IP address Now you need to find the IP address of your Pi on the local network. Note: This step is most easily done on a home type router (a residential router). This way you can use the router web interface to determine the IP address of the Pi. If your on a University network, you need to contact your network administrators and request a fixed IP . To do this, you will usually have to give them the Raspbery Pi ethernet MAC address. Once you are connected to a residential router, on a computer on the local network (connected to the same router as the Pi), open a browser and go to your local router page. It is usually at http://192.168.1.1 . Once there, find the connected devices tab and find your Raspbery Pi in the list. You need to note the IP address of your Pi for the following steps. If you eventually want your Pi on a University network and need the MAC address of the Pi you can also find it here. The MAC address is a unique identifier for each ethernet or wifi chip, it does not change. Connect with ssh Again, on a computer on the local network, you need to connect to the Pi using a terminal program called ssh . On macOS, run the Terminal program. On Windows run a terminal program like Putty . At the command prompt, type ssh pi@<IP-address-of-your-pi> Where <ip-address-of-your-pi> is the IP address you just noted down from your router. This will then ask for a username and password . The username is pi and the password is raspberry . Once logged in, your command prompt should look something like pi@raspberrypi:~ $ Configure pi Once logged into the pi, type sudo raspi-config and you will be presented with a number of menu options. You can select menus with the up/down arrows, enter into submenus with return (or enter ) and go back to a previous menu with escape . sudo raspi-config | 1 System Options Configure system settings \u2502 \u2502 2 Display Options Configure display settings \u2502 \u2502 3 Interface Options Configure connections to peripherals \u2502 \u2502 4 Performance Options Configure performance settings \u2502 \u2502 5 Localisation Options Configure language and regional settings \u2502 \u2502 6 Advanced Options Configure advanced settings \u2502 \u2502 8 Update Update this tool to the latest version \u2502 \u2502 9 About raspi-config Information about this configuration tool Select 1 then \u2502 S3 Password Change password for the 'pi' user \u2502 You must set the password to poetry7d . This is required for the PiE server to talk to the Raspberry Pi. \u2502 S4 Hostname Set name for this computer on a network \u2502 Enter any valid hostname you want. This will uniquely identify your Pi with an easy to remember name on the network. We usually use animal names like giraffe or monkey. Select 3 \u2502 3 Interface Options Configure connections to peripherals \u2502 then select \u2502 P1 Camera Enable/disable connection to the Raspberry Pi Camera \u2502 When asked, Would you like the camera interface to be enabled select <yes> Select 5 \u2502 5 Localisation Options Configure language and regional settings \u2502 then select \u2502 L1 Locale Configure language and regional settings \u2502 Scroll up/down with up/down arrow. Toggle the selections with space , move from the list to the ok and cancel buttons with tab by default, the following is usually selected \u2502 [*] en_GB.UTF-8 UTF-8 \u2592 \u2502 If your in the UK, you are good to go. If you are in the US then select (sorry to be so US centric) \u2502 [*] en_US.UTF-8 UTF-8 \u2193 \u2502 Select \u2502 L2 Timezone Configure time zone \u2502 and select your timezone Select 6 \u2502 6 Advanced Options Configure advanced settings \u2502 then select \u2502 A1 Expand Filesystem Ensures that all of the SD card is available \u2502 You are done with this step ! From the main menu select <finish> and when asked to reboot select <Yes> Mount a USB drive The Raspberry Pi OS does not mount USB drives when they are first plugged in (this is normal for most Linux operating systems). Follow our monting a USB drive tutorial. An alternate version is here .","title":"Preparing a Raspberry Pi"},{"location":"install-buster/#overview","text":"This is a recipe to prepare a Raspberry Pi computer to use with a PiE server. The general steps we will follow are as follows: Install the Raspberry Pi OS named buster onto an SD card. Boot the Pi with the SD card and find its IP on a local network. Login to the Pi with ssh. Configure the Pi with sudo raspi-config . Mount a USB drive This might seem daungting but if you take each step methodically, you can do it. If you have done it a few times, it should take about 20 minutes .","title":"Overview"},{"location":"install-buster/#required-hardware","text":"For this initial setup you will need the following: A residential router connected to the internet A macOS or Windows machine connected to the router An additional ethernet cable for the new Pi If your setting up the Pi to eventually be on a University network, there are some additional requirements. Here we will assume you are on a residential network that you control. This can be acheived by simply bringing everything home and working from there.","title":"Required hardware"},{"location":"install-buster/#download-raspberry-pi-imager","text":"These initial steps are done on any internet connected computer (not the Pi). We will use the Raspbery Pi Imager to copy a downloaded Raspberry Pi OS (a .zip or .img file) onto your SD card. Download the Raspberry Pi Imager . Here are direct links for downloading for the macOS and Windows: macOS Download Windows download","title":"Download Raspberry Pi Imager"},{"location":"install-buster/#download-the-raspberry-pi-os-buster","text":"It is CRITICAL that you download and install a slightly older version named Buster . This can be found towards the bottom of the main Raspberry Pi OS download page . You can get there using the 'See all download options' button. Specifically, you want the following: Raspberry Pi OS Lite (Legacy) Release date: February 21st 2023 System: 32-bit Kernel version: 5.10 Debian version: 10 (buster) Size: 286MB Here is a direct link to download the buster xz file . The name of the file you downloaded should be 2023-02-21-raspios-buster-armhf-lite.img.xz . This is a compressed file, on either macOS or Windows uncompress it and you should end up with a new img file named 2023-02-21-raspios-buster-armhf-lite.img . This is what you will install onto the SD card using the Raspberry Pi Imager.","title":"Download the Raspberry Pi OS (buster)"},{"location":"install-buster/#format-the-sd-card","text":"You need to format the SD card using the Fat format. If using a macOS computer Insert the SD card Open the 'Disk Utilities' app. It is in Applications:Utilities folder Select your SD card in the left list (make sure you get it right) Select 'Erase' In the Erase dialog select MS-DOS (Fat) and Master Boot Record (MBR) If you are using a Window computer, just follow the prompts when you first insert the SD card or right-click the SD card and format it.","title":"Format the SD card"},{"location":"install-buster/#run-raspbery-pi-imager","text":"In the Raspberry Pi Imager software ... Select Choose OS and then Use Custom and then select the img file you just uncompressed. Select your SD card.","title":"Run Raspbery Pi Imager"},{"location":"install-buster/#enable-ssh-on-boot","text":"Now the system is on your SD card. You need to enable ssh on boot so you can login to your Pi. An aside. What we are doing here is a bit different than most interactions with computers. The Raspberry Pi, as we are using it, will reamin headless . This means there will never be a monitor, keyboard, or mouse connected to your Pi. All interaction is done through a command prompt using the terminal software called ssh . To enable ssh on boot, you need to make an empty file named ssh on the SD card. On macOS With the SD card inserted, in a Terminal, enable ssh on boot with the following command touch /Volumes/boot/ssh On Windows Use the exporer to view the SD card, it should be named boot . Right-click and create a new text document. Change the name of the new file to just ssh (no extnesion).","title":"Enable ssh on boot"},{"location":"install-buster/#goal-half-way-completed","text":"You now have an SD card ready to boot a Raspberry Pi! Go take a break!","title":"Goal half-way completed !!!"},{"location":"install-buster/#power-up-the-pi","text":"Insert the SD card into the Raspberry Pi computer. Attach an ethernet cable from the Pi to your local router. Plug in the USB power.","title":"Power up the Pi"},{"location":"install-buster/#find-the-pi-on-your-local-network-and-get-its-ip-address","text":"Now you need to find the IP address of your Pi on the local network. Note: This step is most easily done on a home type router (a residential router). This way you can use the router web interface to determine the IP address of the Pi. If your on a University network, you need to contact your network administrators and request a fixed IP . To do this, you will usually have to give them the Raspbery Pi ethernet MAC address. Once you are connected to a residential router, on a computer on the local network (connected to the same router as the Pi), open a browser and go to your local router page. It is usually at http://192.168.1.1 . Once there, find the connected devices tab and find your Raspbery Pi in the list. You need to note the IP address of your Pi for the following steps. If you eventually want your Pi on a University network and need the MAC address of the Pi you can also find it here. The MAC address is a unique identifier for each ethernet or wifi chip, it does not change.","title":"Find the Pi on your local network and get its IP address"},{"location":"install-buster/#connect-with-ssh","text":"Again, on a computer on the local network, you need to connect to the Pi using a terminal program called ssh . On macOS, run the Terminal program. On Windows run a terminal program like Putty . At the command prompt, type ssh pi@<IP-address-of-your-pi> Where <ip-address-of-your-pi> is the IP address you just noted down from your router. This will then ask for a username and password . The username is pi and the password is raspberry . Once logged in, your command prompt should look something like pi@raspberrypi:~ $","title":"Connect with ssh"},{"location":"install-buster/#configure-pi","text":"Once logged into the pi, type sudo raspi-config and you will be presented with a number of menu options. You can select menus with the up/down arrows, enter into submenus with return (or enter ) and go back to a previous menu with escape . sudo raspi-config | 1 System Options Configure system settings \u2502 \u2502 2 Display Options Configure display settings \u2502 \u2502 3 Interface Options Configure connections to peripherals \u2502 \u2502 4 Performance Options Configure performance settings \u2502 \u2502 5 Localisation Options Configure language and regional settings \u2502 \u2502 6 Advanced Options Configure advanced settings \u2502 \u2502 8 Update Update this tool to the latest version \u2502 \u2502 9 About raspi-config Information about this configuration tool Select 1 then \u2502 S3 Password Change password for the 'pi' user \u2502 You must set the password to poetry7d . This is required for the PiE server to talk to the Raspberry Pi. \u2502 S4 Hostname Set name for this computer on a network \u2502 Enter any valid hostname you want. This will uniquely identify your Pi with an easy to remember name on the network. We usually use animal names like giraffe or monkey. Select 3 \u2502 3 Interface Options Configure connections to peripherals \u2502 then select \u2502 P1 Camera Enable/disable connection to the Raspberry Pi Camera \u2502 When asked, Would you like the camera interface to be enabled select <yes> Select 5 \u2502 5 Localisation Options Configure language and regional settings \u2502 then select \u2502 L1 Locale Configure language and regional settings \u2502 Scroll up/down with up/down arrow. Toggle the selections with space , move from the list to the ok and cancel buttons with tab by default, the following is usually selected \u2502 [*] en_GB.UTF-8 UTF-8 \u2592 \u2502 If your in the UK, you are good to go. If you are in the US then select (sorry to be so US centric) \u2502 [*] en_US.UTF-8 UTF-8 \u2193 \u2502 Select \u2502 L2 Timezone Configure time zone \u2502 and select your timezone Select 6 \u2502 6 Advanced Options Configure advanced settings \u2502 then select \u2502 A1 Expand Filesystem Ensures that all of the SD card is available \u2502 You are done with this step ! From the main menu select <finish> and when asked to reboot select <Yes>","title":"Configure pi"},{"location":"install-buster/#mount-a-usb-drive","text":"The Raspberry Pi OS does not mount USB drives when they are first plugged in (this is normal for most Linux operating systems). Follow our monting a USB drive tutorial. An alternate version is here .","title":"Mount a USB drive"},{"location":"install/","text":"Install the PiE server Get a functioning Raspberry Pi We assume you have a functioning Raspberry Pi 2/3. To get started, see our installation recipe. In the remaining parts of this tutorial, all commands are entered into an ssh session that is logged into the Pi. Any time you see the number sign (#) that is a comment and does not have to be entered. 1) Download the PiE server code # update your system sudo apt-get update sudo apt-get upgrade # if you don't already have git sudo apt-get install git # clone the main PiE repository cd git clone https://github.com/cudmore/pie.git 3) Install the PiE server cd ~/pie ./install-pie Thats it, the PiE server should be running and you can use the web interface at http://[ip]:5010 . Where [ip] is the IP address of your Raspberry Pi. Make sure you specify port 5010 in the web address. By default, the PiE server will start when the Raspberry Pi is booted. 4) Install uv4l for video streaming. The uv4l software runs at the system level (not within the PiE folder) and only needs to be installed once per machine. cd ~/pie ./install-uv4l 5) Install the DHT temperature/humidity sensor Python package (optional) If you are using a DHT temperature/humidity sensor , the Adafruit DHT python package needs to be installed. cd ~/pie ./install-dht 6) Checking the status of the PiE server. If all goes well, the web interface is all this is needed. If the PiE server does not work as expected, it is useful to check its log file. Do this from the web interface or from the command line with: more ~/pie/pie_app/pie.log 7) Controlling the PiE server from the command line Once installed, the PiE server installs a system service allowing the PiE server to run in the background. This background PiE server can be controlled as follows: cd ~/pie ./pie start - start background PiE server\" ./pie stop - stop background PiE server\" ./pie status - check the status of background PiE server\" ./pie enable - enable background PiE server at boot\" ./pie disable - disable background PiE server at boot\" ./pie run - run PiE server on command line\" For debugging, use ./pie run to print the PiE server log to the command line. The logs can also be viewed from the web interface or the command line using more ~/pie/pie_app/pie.log . Running the PiE server at boot By default, the PiE server will run when the Raspberry Pi is booted and this can be controlled as follows. # To make the background server run at boot cd ~/pie ./pie enable # To make the background server NOT run at boot cd ~/pie ./pie disable Manually running the PiE server Normally, the PiE server will run in the background after installation with './install-pie'. If there are errors during the install or the PiE server is not running, the pie server can be run manually as follows. # stop background pie server cd ~/pie ./pie stop # activate the pie server python virtual environment in pie_env/ # Once activated, the command prompt will start with (pie_env) cd ~/pie source pie_env/bin/activate # manually run the pie server cd ~/pie/pie_app python treadmill_app.py # don't forget to deactivate the python virtual environment with deactivate Uninstalling the PiE server Run the uninstall script ./uninstall-pie and remove the ~/pie folder with sudo -Rf ~/pie . # run the uninstall script cd ~/pie ./uninstall-pie # remove the pie folder sudo -Rf ~/pie Full reinstall of the PiE server Issue these commands to remove and reinstall the PiE server. # stop the PiE server cd ~/pie ./pie stop # remove existing ~/pie folder cd sudo rm -Rf ~/pie # download/clone a new copy of pie folder cd git clone https://github.com/cudmore/pie.git # install PiE server cd ~/pie ./install-pie # install dht sensor (optional) cd ~/pie ./install-dht","title":"Install the PiE server"},{"location":"install/#install-the-pie-server","text":"","title":"Install the PiE server"},{"location":"install/#get-a-functioning-raspberry-pi","text":"We assume you have a functioning Raspberry Pi 2/3. To get started, see our installation recipe. In the remaining parts of this tutorial, all commands are entered into an ssh session that is logged into the Pi. Any time you see the number sign (#) that is a comment and does not have to be entered.","title":"Get a functioning Raspberry Pi"},{"location":"install/#1-download-the-pie-server-code","text":"# update your system sudo apt-get update sudo apt-get upgrade # if you don't already have git sudo apt-get install git # clone the main PiE repository cd git clone https://github.com/cudmore/pie.git","title":"1) Download the PiE server code"},{"location":"install/#3-install-the-pie-server","text":"cd ~/pie ./install-pie Thats it, the PiE server should be running and you can use the web interface at http://[ip]:5010 . Where [ip] is the IP address of your Raspberry Pi. Make sure you specify port 5010 in the web address. By default, the PiE server will start when the Raspberry Pi is booted.","title":"3) Install the PiE server"},{"location":"install/#4-install-uv4l-for-video-streaming","text":"The uv4l software runs at the system level (not within the PiE folder) and only needs to be installed once per machine. cd ~/pie ./install-uv4l","title":"4) Install uv4l for video streaming."},{"location":"install/#5-install-the-dht-temperaturehumidity-sensor-python-package-optional","text":"If you are using a DHT temperature/humidity sensor , the Adafruit DHT python package needs to be installed. cd ~/pie ./install-dht","title":"5) Install the DHT temperature/humidity sensor Python package (optional)"},{"location":"install/#6-checking-the-status-of-the-pie-server","text":"If all goes well, the web interface is all this is needed. If the PiE server does not work as expected, it is useful to check its log file. Do this from the web interface or from the command line with: more ~/pie/pie_app/pie.log","title":"6) Checking the status of the PiE server."},{"location":"install/#7-controlling-the-pie-server-from-the-command-line","text":"Once installed, the PiE server installs a system service allowing the PiE server to run in the background. This background PiE server can be controlled as follows: cd ~/pie ./pie start - start background PiE server\" ./pie stop - stop background PiE server\" ./pie status - check the status of background PiE server\" ./pie enable - enable background PiE server at boot\" ./pie disable - disable background PiE server at boot\" ./pie run - run PiE server on command line\" For debugging, use ./pie run to print the PiE server log to the command line. The logs can also be viewed from the web interface or the command line using more ~/pie/pie_app/pie.log .","title":"7) Controlling the PiE server from the command line"},{"location":"install/#running-the-pie-server-at-boot","text":"By default, the PiE server will run when the Raspberry Pi is booted and this can be controlled as follows. # To make the background server run at boot cd ~/pie ./pie enable # To make the background server NOT run at boot cd ~/pie ./pie disable","title":"Running the PiE server at boot"},{"location":"install/#manually-running-the-pie-server","text":"Normally, the PiE server will run in the background after installation with './install-pie'. If there are errors during the install or the PiE server is not running, the pie server can be run manually as follows. # stop background pie server cd ~/pie ./pie stop # activate the pie server python virtual environment in pie_env/ # Once activated, the command prompt will start with (pie_env) cd ~/pie source pie_env/bin/activate # manually run the pie server cd ~/pie/pie_app python treadmill_app.py # don't forget to deactivate the python virtual environment with deactivate","title":"Manually running the PiE server"},{"location":"install/#uninstalling-the-pie-server","text":"Run the uninstall script ./uninstall-pie and remove the ~/pie folder with sudo -Rf ~/pie . # run the uninstall script cd ~/pie ./uninstall-pie # remove the pie folder sudo -Rf ~/pie","title":"Uninstalling the PiE server"},{"location":"install/#full-reinstall-of-the-pie-server","text":"Issue these commands to remove and reinstall the PiE server. # stop the PiE server cd ~/pie ./pie stop # remove existing ~/pie folder cd sudo rm -Rf ~/pie # download/clone a new copy of pie folder cd git clone https://github.com/cudmore/pie.git # install PiE server cd ~/pie ./install-pie # install dht sensor (optional) cd ~/pie ./install-dht","title":"Full reinstall of the PiE server"},{"location":"mount-usb-drive/","text":"I have a Fat32 formatted USB drive and I want to have it mounted when the Raspberry Pi boots. To do this I add an entry to my fstab file using the UUID of the drive and some permission. Get a list of your USB devices to check if your USB drive is available lsusb Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp. Bus 001 Device 004: ID 13fe:5200 Kingston Technology Company Inc. Bus 001 Device 005: ID 0bda:8176 Realtek Semiconductor Corp. RTL8188CUS 802.11n WLAN Adapter Make a directory to mount your drive/volume into sudo mkdir /home/pi/video Find the UUID of your drive sudo blkid /dev/mmcblk0p1: SEC_TYPE=\"msdos\" LABEL=\"boot\" UUID=\"2654-BFC0\" TYPE=\"vfat\" /dev/mmcblk0p2: UUID=\"548da502-ebde-45c0-9ab2-de5e2431ee0b\" TYPE=\"ext4\" /dev/sda1: LABEL=\"video\" UUID=\"7CCD-19F2\" TYPE=\"vfat\" This tells me that my usb drive is in the device list at /dev/sda1, has the label \u2018video\u2019, a UUID of \u20197CCD-19F2\u2032, and is formatted as VFAT (e.g. FAT32). Edit your /etc/fstab file by appending a line for your dive sudo pico /etc/fstab proc /proc proc defaults 0 0 /dev/mmcblk0p1 /boot vfat defaults 0 2 /dev/mmcblk0p2 / ext4 defaults,noatime 0 1 UUID=7CCD-19F2 /home/pi/video vfat rw,umask=0 0 0 # a swapfile is not a swap partition, so no using swapon|off from here on, use $ Here, on the line starting with UUID, I have mounted a device using its UUID=7CCD-19F2 into a folder /home/pi/video. This is a Fat32 formatted drive (vfat) and everybody has read-write permissions (rw,umask=0). This recipe will not work for other types of formatted drives (Ext3, NTFS, etc). Remount Your drives and check the drive is mounted sudo mount -a 'ls' should show /video/ in blue to indicate it is mounted Important. When you make the directory where a drive will be mounted it MUST be done with \u2018sudo mkdir /home/pi/video\u2019. You need \u2018sudo\u2019 so fstab can mount it on boot, the final permissions of this mounted drive are set in the drives fstab line. In this case, \u2018rw,umask=0\u2032. Linux Commands List your usb devices: lsusb List the Location, Label, UUID and Type of your USB devices: sudo blkid Unmount a volume: sudo umount /home/pi/video Mount everybody in fstab: sudo mount -a Check if a drive is mounted: df | grep \u201c/home/pi/video\u201d | awk \u2018{print $6}\u2019 To Do A problem I just had is that my USB drive did not get mounted at boot and the folder I have reserved for it is on my root file system, \u2018/\u2019, with only 4 GB of space. I started writing tons of video files to the folder and quickly ran out of space on. Now, I need a way to test if the folder I am writing to is (I) a folder or (ii) an actual mount point. Tym, the bash guru in the lab and my go to person on these things suggested the following: df | grep \u201c/home/pi/video\u201d | awk \u2018{print $6}\u2019 This will return an empty string if /home/pi/video is NOT mounted.","title":"Mount USB Drive"},{"location":"mount-usb-drive/#get-a-list-of-your-usb-devices-to-check-if-your-usb-drive-is-available","text":"lsusb Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp. Bus 001 Device 004: ID 13fe:5200 Kingston Technology Company Inc. Bus 001 Device 005: ID 0bda:8176 Realtek Semiconductor Corp. RTL8188CUS 802.11n WLAN Adapter","title":"Get a list of your USB devices to check if your USB drive is available"},{"location":"mount-usb-drive/#make-a-directory-to-mount-your-drivevolume-into","text":"sudo mkdir /home/pi/video","title":"Make a directory to mount your drive/volume into"},{"location":"mount-usb-drive/#find-the-uuid-of-your-drive","text":"sudo blkid /dev/mmcblk0p1: SEC_TYPE=\"msdos\" LABEL=\"boot\" UUID=\"2654-BFC0\" TYPE=\"vfat\" /dev/mmcblk0p2: UUID=\"548da502-ebde-45c0-9ab2-de5e2431ee0b\" TYPE=\"ext4\" /dev/sda1: LABEL=\"video\" UUID=\"7CCD-19F2\" TYPE=\"vfat\" This tells me that my usb drive is in the device list at /dev/sda1, has the label \u2018video\u2019, a UUID of \u20197CCD-19F2\u2032, and is formatted as VFAT (e.g. FAT32).","title":"Find the UUID of your drive"},{"location":"mount-usb-drive/#edit-your-etcfstab-file-by-appending-a-line-for-your-dive","text":"sudo pico /etc/fstab proc /proc proc defaults 0 0 /dev/mmcblk0p1 /boot vfat defaults 0 2 /dev/mmcblk0p2 / ext4 defaults,noatime 0 1 UUID=7CCD-19F2 /home/pi/video vfat rw,umask=0 0 0 # a swapfile is not a swap partition, so no using swapon|off from here on, use $ Here, on the line starting with UUID, I have mounted a device using its UUID=7CCD-19F2 into a folder /home/pi/video. This is a Fat32 formatted drive (vfat) and everybody has read-write permissions (rw,umask=0). This recipe will not work for other types of formatted drives (Ext3, NTFS, etc).","title":"Edit your /etc/fstab file by appending a line for your dive"},{"location":"mount-usb-drive/#remount-your-drives-and-check-the-drive-is-mounted","text":"sudo mount -a 'ls' should show /video/ in blue to indicate it is mounted Important. When you make the directory where a drive will be mounted it MUST be done with \u2018sudo mkdir /home/pi/video\u2019. You need \u2018sudo\u2019 so fstab can mount it on boot, the final permissions of this mounted drive are set in the drives fstab line. In this case, \u2018rw,umask=0\u2032.","title":"Remount Your drives and check the drive is mounted"},{"location":"mount-usb-drive/#linux-commands","text":"List your usb devices: lsusb List the Location, Label, UUID and Type of your USB devices: sudo blkid Unmount a volume: sudo umount /home/pi/video Mount everybody in fstab: sudo mount -a Check if a drive is mounted: df | grep \u201c/home/pi/video\u201d | awk \u2018{print $6}\u2019","title":"Linux Commands"},{"location":"mount-usb-drive/#to-do","text":"A problem I just had is that my USB drive did not get mounted at boot and the folder I have reserved for it is on my root file system, \u2018/\u2019, with only 4 GB of space. I started writing tons of video files to the folder and quickly ran out of space on. Now, I need a way to test if the folder I am writing to is (I) a folder or (ii) an actual mount point. Tym, the bash guru in the lab and my go to person on these things suggested the following: df | grep \u201c/home/pi/video\u201d | awk \u2018{print $6}\u2019 This will return an empty string if /home/pi/video is NOT mounted.","title":"To Do"},{"location":"parts/","text":"Jump to the actual parts list Overview Raspberry Pi The Raspberry Pi is a complete computer system in an almost credit card size. It has ethernet, USB, general-purpose-input-output pins (GPIO), a dedicated camera port, and runs a version of Debian Linux called Rasbian . You can pick up the current model, a Raspberry Pi 3 Model B+ . Raspberry Pi camera The Raspberry Pi has a dedicated camera port for the Raspberry Pi Camera. This is an 8 megapixel camera capable of frame rates as high as 90 frames-per-second and comes in two flavors, the Pi NOIR Camera which can capture images/video using infrared (IR) lights and the ' normal ' camera which can capture images/video using visible (white) light. We generally use the Pi NOIR version to record video in behavior boxes during both the daytime (white LEDs) and night-time (IR LEDs) as well as on the scope to record video during two-photon imaging in the dark using IR LEDs. Two channel relay A relay is a switch allowing you to turn higher voltage devices (usually LEDs connected to 12V power) on and off with 3V GPIO pins. We are using a sainsmart 2-channel relay . LEDs If you end up with lots of LEDs, you could try an IR LED strip and/or a white LED strip . Optional: Analog video output The Raspberry Pi has a 3.5mm headphone jack that can be used to view an analog video stream from the Pi camera. The headphone jack needs to have 4-poles (bands), something like this . The analog video can be connected directly to any monitor that accepts an RCA video input. Alternatively, the analog video can be sent to another computer using an analog video to USB converter, something like this . These video to USB converters are for some reason a large gray market area and you need to be careful when ordering as you might get junk that does not work. In general, these video/USB converters use the easycap driver . The PiE server will output a live video feed when 'arm' is checked. This video feed does not interfere with simultaneous video recording to a file. Parts List For video recording Quatity Item Purpose Cost Vendor Link 1 Raspberry Pi 3 Model B Raspberry Pi system including computer, SD card, power, and case. In general, buy a kit from Canakit. $75 amazon 1 USB Flash Drive, 64GB To save recorded video $17 amazon 1 (either this) Pi NoIR Camera v2, 8MP IR video camera $30 adafruit 1 (or this) Pi Camera v2, 8MP Video camera $30 adafruit 1 (either this) Pi Camera Ribbon cable (2 meters) Flat ribbon cable to connect camera to computer (not optimal) $6 adafruit 1 (or this 1/2) Pi Camera HDMI extension cable Allows camera to connect to computer using an HDMI cable $15 tindie 1 (and this 2/2) HDMI Cable of sufficient length Male/Male HDMI cable $7 - $15 amazon 1 Ethernet cable of sufficient length Connect the computer to the network $5 - $20 amazon For video recording in a behavior box Quatity Item Purpose Cost Vendor Link 1 SainSmart 2-Channel Relay Module Allow computer to switch LEDs on/off $9 amazon 1-2 White LEDs White light for behavior box $5 sparkfun >4 IR LEDs, 840-850 nm IR light for behavior box. Pi Camera picks up ~850 nm light well, do not use 950 nm. $1 each sparkfun >1 Universal 4-LED Miniature Wedge Base PCB To mount 4x LEDs + required resistor $1 each super-bright-led 1 12V 2A LED Driver (does not come with wall plug) Power the IR LEDs $12 amazon 1 Temperature/humidity sensor Measure temperature/humidity $10-$15 Either am2302 or dht22 1 Wire To wire LEDs into box $17 sparkfun Future directions Level shifter If you need to connect the Raspberry Pi directly to 5V TTL lab equipment you need a level shifter to convert the 5V signal to 3V as the Raspberry Pi is only 3V tolerant. We normally use Adafruit or Sparkfun level shifters. Teensy microcontroller We are using Teensy 3.2 or 3.5 microcontrollers. They are Arduino compatible but have a lot more features. These microcontrollers can be programmed from the command line using platformio , no need for the Arduino IDE. To use platformio, the Raspberry Pi needs a few simple system wide configurations, see the readme in pie/platformio . Stepper motor and driver Use a Bipolar stepper motor with the Easy Driver motor driver. For video recording on a scope with triggering and frame clock Quatity Item Purpose Cost Vendor Link 1 4-channel Logic Level Converter (Bi-Directional) To connect 5V TTL lab equipment to 3V computer GPIO $4 Sparkfun , Adafruit 1 Tripod Swivel To mount the camera on an optical post and be able to angle it. $9 amazon 1 4-pole 3.5mm headphone jack Output analog video from the Pi $6 amazon 1 Video to USB converter Convert analog video to USB to view video on a computer $15 amazon For controlling a motorized treadmill with a microcontroller Quatity Item Purpose Cost Vendor Link 1 Teensy 3.5 Arduino compatible microcontroller $25 teensy 1 EasyDriver - Stepper Motor Driver Motor controller for stepper motor $15 sparkfun 1 Stepper Motor Share 12V 2A LED Driver for power $15 sparkfun 1 Rotary encoder Honeywell-600-128-CBL $51 digi-key or this 1 Breadboard and jumper cables A breadboard and a mixture of jumper cables: male/male, male/female, and female/female $11 amazon Building a treadmill These are Actobotics parts from ServoCity Quatity Item Cost Part # Link Aluminum channels link 4 1.50 inch Aluminum Channel 2.99 585440 4 6.00 inch Aluminum Channel 5.99 585446 1 9.00 inch Aluminum Channel 7.99 585450 1 15 inch Aluminum Channel 11.99 585458 Shafts and shaft couplers link 2 1/4 inch x12 inch Precision Shaft 3.59 634178 2 1/4 inch x4 inch Precision Shaft 1.49 634164 1 1/4 inch x6 inch Precision Shaft 2.09 634168 2 1/4 inch to 5mm Set Screw Shaft Coupler 4.99 625120 2 1/4 inch to 1/4 inch Set Screw Shaft Coupler 4.99 625104 Couplers and adapters link 8 1/4 inch Bore Clamping Hub (0.770 inch) 7.99 545588 4 1/4 inch Bore Set Screw Hub (0.770 inch) 4.99 545548 2 Stepper Motor Mount (NEMA 17) 7.49 555152 4 1/4-20 Round Screw Plate 3.99 545468 2 Large Square Screw Plate 2.69 585430 1 90 Degree Quad Hub Mount C 5.99 545360 1 90 Degree Quad Hub Mount D 5.99 545324 Ball bearings link 3 .250 inch ID x .500 inch OD Flanged Ball Bearing (Stainless Steel) 2 pack 1.99 535198 1 Dual Ball Bearing Hub A 6.99 545444 1 1/4 inch Shafting & Tubing Spacers (12 pk) 1.69 633104 Gears link 1 16T, 0.250 inch Bore, 32P Bevel Gear 5.99 615442 1 32T, 0.250 inch Bore, 32P Bevel Gear 7.99 615444 1 16T, 5mm Bore, 32P Bevel Gear 5.99 615438 2 48 Tooth, 32 Pitch Hub Gear (3/16 inch Face) 5.20 RHA32-36-48 Fasteners link 24 6-32x3/8 inch Pan Head Phillips Machine Screws (Zinc-Plated) 0.06 90272A146 8 1/2 inch 1/4-20 Flat Head Phillips Machine Screws 0.38 90273A537 1 3/32 Hex Key 1.39 57185A11 6 .250 in L x 6-32 Zinc-Plated Alloy Steel Socket Head Cap Screw (25 pk) 1.69 632106","title":"Parts List"},{"location":"parts/#overview","text":"","title":"Overview"},{"location":"parts/#raspberry-pi","text":"The Raspberry Pi is a complete computer system in an almost credit card size. It has ethernet, USB, general-purpose-input-output pins (GPIO), a dedicated camera port, and runs a version of Debian Linux called Rasbian . You can pick up the current model, a Raspberry Pi 3 Model B+ .","title":"Raspberry Pi"},{"location":"parts/#raspberry-pi-camera","text":"The Raspberry Pi has a dedicated camera port for the Raspberry Pi Camera. This is an 8 megapixel camera capable of frame rates as high as 90 frames-per-second and comes in two flavors, the Pi NOIR Camera which can capture images/video using infrared (IR) lights and the ' normal ' camera which can capture images/video using visible (white) light. We generally use the Pi NOIR version to record video in behavior boxes during both the daytime (white LEDs) and night-time (IR LEDs) as well as on the scope to record video during two-photon imaging in the dark using IR LEDs.","title":"Raspberry Pi camera"},{"location":"parts/#two-channel-relay","text":"A relay is a switch allowing you to turn higher voltage devices (usually LEDs connected to 12V power) on and off with 3V GPIO pins. We are using a sainsmart 2-channel relay .","title":"Two channel relay"},{"location":"parts/#leds","text":"If you end up with lots of LEDs, you could try an IR LED strip and/or a white LED strip .","title":"LEDs"},{"location":"parts/#optional-analog-video-output","text":"The Raspberry Pi has a 3.5mm headphone jack that can be used to view an analog video stream from the Pi camera. The headphone jack needs to have 4-poles (bands), something like this . The analog video can be connected directly to any monitor that accepts an RCA video input. Alternatively, the analog video can be sent to another computer using an analog video to USB converter, something like this . These video to USB converters are for some reason a large gray market area and you need to be careful when ordering as you might get junk that does not work. In general, these video/USB converters use the easycap driver . The PiE server will output a live video feed when 'arm' is checked. This video feed does not interfere with simultaneous video recording to a file.","title":"Optional: Analog video output"},{"location":"parts/#parts-list","text":"","title":"Parts List"},{"location":"parts/#for-video-recording","text":"Quatity Item Purpose Cost Vendor Link 1 Raspberry Pi 3 Model B Raspberry Pi system including computer, SD card, power, and case. In general, buy a kit from Canakit. $75 amazon 1 USB Flash Drive, 64GB To save recorded video $17 amazon 1 (either this) Pi NoIR Camera v2, 8MP IR video camera $30 adafruit 1 (or this) Pi Camera v2, 8MP Video camera $30 adafruit 1 (either this) Pi Camera Ribbon cable (2 meters) Flat ribbon cable to connect camera to computer (not optimal) $6 adafruit 1 (or this 1/2) Pi Camera HDMI extension cable Allows camera to connect to computer using an HDMI cable $15 tindie 1 (and this 2/2) HDMI Cable of sufficient length Male/Male HDMI cable $7 - $15 amazon 1 Ethernet cable of sufficient length Connect the computer to the network $5 - $20 amazon","title":"For video recording"},{"location":"parts/#for-video-recording-in-a-behavior-box","text":"Quatity Item Purpose Cost Vendor Link 1 SainSmart 2-Channel Relay Module Allow computer to switch LEDs on/off $9 amazon 1-2 White LEDs White light for behavior box $5 sparkfun >4 IR LEDs, 840-850 nm IR light for behavior box. Pi Camera picks up ~850 nm light well, do not use 950 nm. $1 each sparkfun >1 Universal 4-LED Miniature Wedge Base PCB To mount 4x LEDs + required resistor $1 each super-bright-led 1 12V 2A LED Driver (does not come with wall plug) Power the IR LEDs $12 amazon 1 Temperature/humidity sensor Measure temperature/humidity $10-$15 Either am2302 or dht22 1 Wire To wire LEDs into box $17 sparkfun","title":"For video recording in a behavior box"},{"location":"parts/#future-directions","text":"","title":"Future directions"},{"location":"parts/#level-shifter","text":"If you need to connect the Raspberry Pi directly to 5V TTL lab equipment you need a level shifter to convert the 5V signal to 3V as the Raspberry Pi is only 3V tolerant. We normally use Adafruit or Sparkfun level shifters.","title":"Level shifter"},{"location":"parts/#teensy-microcontroller","text":"We are using Teensy 3.2 or 3.5 microcontrollers. They are Arduino compatible but have a lot more features. These microcontrollers can be programmed from the command line using platformio , no need for the Arduino IDE. To use platformio, the Raspberry Pi needs a few simple system wide configurations, see the readme in pie/platformio .","title":"Teensy microcontroller"},{"location":"parts/#stepper-motor-and-driver","text":"Use a Bipolar stepper motor with the Easy Driver motor driver.","title":"Stepper motor and  driver"},{"location":"parts/#for-video-recording-on-a-scope-with-triggering-and-frame-clock","text":"Quatity Item Purpose Cost Vendor Link 1 4-channel Logic Level Converter (Bi-Directional) To connect 5V TTL lab equipment to 3V computer GPIO $4 Sparkfun , Adafruit 1 Tripod Swivel To mount the camera on an optical post and be able to angle it. $9 amazon 1 4-pole 3.5mm headphone jack Output analog video from the Pi $6 amazon 1 Video to USB converter Convert analog video to USB to view video on a computer $15 amazon","title":"For video recording on a scope with triggering and frame clock"},{"location":"parts/#for-controlling-a-motorized-treadmill-with-a-microcontroller","text":"Quatity Item Purpose Cost Vendor Link 1 Teensy 3.5 Arduino compatible microcontroller $25 teensy 1 EasyDriver - Stepper Motor Driver Motor controller for stepper motor $15 sparkfun 1 Stepper Motor Share 12V 2A LED Driver for power $15 sparkfun 1 Rotary encoder Honeywell-600-128-CBL $51 digi-key or this 1 Breadboard and jumper cables A breadboard and a mixture of jumper cables: male/male, male/female, and female/female $11 amazon","title":"For controlling a motorized treadmill with a microcontroller"},{"location":"parts/#building-a-treadmill","text":"These are Actobotics parts from ServoCity Quatity Item Cost Part # Link Aluminum channels link 4 1.50 inch Aluminum Channel 2.99 585440 4 6.00 inch Aluminum Channel 5.99 585446 1 9.00 inch Aluminum Channel 7.99 585450 1 15 inch Aluminum Channel 11.99 585458 Shafts and shaft couplers link 2 1/4 inch x12 inch Precision Shaft 3.59 634178 2 1/4 inch x4 inch Precision Shaft 1.49 634164 1 1/4 inch x6 inch Precision Shaft 2.09 634168 2 1/4 inch to 5mm Set Screw Shaft Coupler 4.99 625120 2 1/4 inch to 1/4 inch Set Screw Shaft Coupler 4.99 625104 Couplers and adapters link 8 1/4 inch Bore Clamping Hub (0.770 inch) 7.99 545588 4 1/4 inch Bore Set Screw Hub (0.770 inch) 4.99 545548 2 Stepper Motor Mount (NEMA 17) 7.49 555152 4 1/4-20 Round Screw Plate 3.99 545468 2 Large Square Screw Plate 2.69 585430 1 90 Degree Quad Hub Mount C 5.99 545360 1 90 Degree Quad Hub Mount D 5.99 545324 Ball bearings link 3 .250 inch ID x .500 inch OD Flanged Ball Bearing (Stainless Steel) 2 pack 1.99 535198 1 Dual Ball Bearing Hub A 6.99 545444 1 1/4 inch Shafting & Tubing Spacers (12 pk) 1.69 633104 Gears link 1 16T, 0.250 inch Bore, 32P Bevel Gear 5.99 615442 1 32T, 0.250 inch Bore, 32P Bevel Gear 7.99 615444 1 16T, 5mm Bore, 32P Bevel Gear 5.99 615438 2 48 Tooth, 32 Pitch Hub Gear (3/16 inch Face) 5.20 RHA32-36-48 Fasteners link 24 6-32x3/8 inch Pan Head Phillips Machine Screws (Zinc-Plated) 0.06 90272A146 8 1/2 inch 1/4-20 Flat Head Phillips Machine Screws 0.38 90273A537 1 3/32 Hex Key 1.39 57185A11 6 .250 in L x 6-32 Zinc-Plated Alloy Steel Socket Head Cap Screw (25 pk) 1.69 632106","title":"Building a treadmill"},{"location":"readme/","text":"Raspberry Pi Controlled Experiment (PiE) See web documentation at https://cudmore.github.io/pie-doc/ .","title":"Raspberry Pi Controlled Experiment (PiE)"},{"location":"readme/#raspberry-pi-controlled-experiment-pie","text":"See web documentation at https://cudmore.github.io/pie-doc/ .","title":"Raspberry Pi Controlled Experiment (PiE)"},{"location":"release-notes/","text":"Release Notes Current To Do Make sure streaming stops when browser tab is closed or browser is quit. Expand sunrise/sunset to fractional hour. [partially done 20180831] Add warning when video/ drive space remaining is less than 1 GB. Do this by updating status.trial.systemInfo.gbRemaining at the end of each recording (record video thread, and armed recording thread). I am doing this with hard-coded 5GB warning in index.html, see: ng-if=\"videoArray[$index].status.trial.systemInfo.gbRemaining < 5\" Have some mechanism to roll-over or otherwise replace the continuous environment log file. [done 20181018] Add code to check the camera as PiE server starts. This way, user can look at logs to troubleshoot. Add popup to web interface for selecting supported DHT (AM2302, DHT11) sensors [20181114] Have continuous environmental log also log status of the lights. Once done, add gray bars to environment plot to show when light actually came on/off. Major Changes 20181114 Revamped environmental log page. Now using fixed y-axis for humidity in range 0..80 Added controls to set y-axis of temperature. Showing last read timestamp, temerature, and humidity at top of page Added button to reload page. Once loaded, the page is static (does not continuously poll server). Clicking 'reload page' will fetch new values from server. Reversed order of table to show last reading first. The page is now using javascript and angular 20181013 Moved environment logs to /home/pie/video/logs. This way they can be browsed and will not be trashed on full reinstall 20180801 Lots of changes 20180722 Lots of changes Development Notes 20180710 (1) motor interface make setup not engage motor add motor on, motor off to web interface pass to teensy with serial useMotor/motorOn, see trial.useMotor //When set LOW, all STEP commands are ignored and all FET functionality is turned off. Must be pulled HIGH to enable STEP control const int motorResetPin = 19; //Logic Input. Enables the FET functionality within the motor driver. If set to HIGH, the FETs will be disabled, and the IC will not drive the motor. If set to LOW, all FETs will be enabled, allowing motor control. const int motorEnabledPin = 20; //low to engage, high to dis-engage (2) [done]finish writing docs for 'scope' configuration. (3) [done] make sure all config files still load (4) [done] add 'last response' to interface - update self.lastResponse throughout code (6) look at starting ./pie at boot, make sure it catches the serial Reduce png file size see: https://www.cyberciti.biz/faq/linux-unix-optimize-lossless-png-images-with-optipng-command/ sudo apt-get install optipng Remember Pins GPIO2 and GPIO3 have fixed pull-up resistors, but for other pins this can be configured in software. Gunicorn source env/bin/activate cd ~/pie/pie_app /home/pi/pie/env/bin/gunicorn -w 1 --bind 192.168.1.15:5010 treadmill_app:app MkDocs Had to install with sudo pip install mkdocs Run on an external port cd ~/pie/docs mkdocs serve -a 192.168.1.4:8000 # if that does not work, then mkdocs serve --dev-addr=0.0.0.0:8000 Push to github cd ~/pie/docs mkdocs gh-deploy","title":"Release Notes"},{"location":"release-notes/#release-notes","text":"","title":"Release Notes"},{"location":"release-notes/#current-to-do","text":"Make sure streaming stops when browser tab is closed or browser is quit. Expand sunrise/sunset to fractional hour. [partially done 20180831] Add warning when video/ drive space remaining is less than 1 GB. Do this by updating status.trial.systemInfo.gbRemaining at the end of each recording (record video thread, and armed recording thread). I am doing this with hard-coded 5GB warning in index.html, see: ng-if=\"videoArray[$index].status.trial.systemInfo.gbRemaining < 5\" Have some mechanism to roll-over or otherwise replace the continuous environment log file. [done 20181018] Add code to check the camera as PiE server starts. This way, user can look at logs to troubleshoot. Add popup to web interface for selecting supported DHT (AM2302, DHT11) sensors [20181114] Have continuous environmental log also log status of the lights. Once done, add gray bars to environment plot to show when light actually came on/off.","title":"Current To Do"},{"location":"release-notes/#major-changes","text":"20181114 Revamped environmental log page. Now using fixed y-axis for humidity in range 0..80 Added controls to set y-axis of temperature. Showing last read timestamp, temerature, and humidity at top of page Added button to reload page. Once loaded, the page is static (does not continuously poll server). Clicking 'reload page' will fetch new values from server. Reversed order of table to show last reading first. The page is now using javascript and angular 20181013 Moved environment logs to /home/pie/video/logs. This way they can be browsed and will not be trashed on full reinstall 20180801 Lots of changes 20180722 Lots of changes","title":"Major Changes"},{"location":"release-notes/#development-notes","text":"","title":"Development Notes"},{"location":"release-notes/#20180710","text":"(1) motor interface make setup not engage motor add motor on, motor off to web interface pass to teensy with serial useMotor/motorOn, see trial.useMotor //When set LOW, all STEP commands are ignored and all FET functionality is turned off. Must be pulled HIGH to enable STEP control const int motorResetPin = 19; //Logic Input. Enables the FET functionality within the motor driver. If set to HIGH, the FETs will be disabled, and the IC will not drive the motor. If set to LOW, all FETs will be enabled, allowing motor control. const int motorEnabledPin = 20; //low to engage, high to dis-engage (2) [done]finish writing docs for 'scope' configuration. (3) [done] make sure all config files still load (4) [done] add 'last response' to interface - update self.lastResponse throughout code (6) look at starting ./pie at boot, make sure it catches the serial","title":"20180710"},{"location":"release-notes/#reduce-png-file-size","text":"see: https://www.cyberciti.biz/faq/linux-unix-optimize-lossless-png-images-with-optipng-command/ sudo apt-get install optipng","title":"Reduce png file size"},{"location":"release-notes/#remember","text":"Pins GPIO2 and GPIO3 have fixed pull-up resistors, but for other pins this can be configured in software.","title":"Remember"},{"location":"release-notes/#gunicorn","text":"source env/bin/activate cd ~/pie/pie_app /home/pi/pie/env/bin/gunicorn -w 1 --bind 192.168.1.15:5010 treadmill_app:app","title":"Gunicorn"},{"location":"release-notes/#mkdocs","text":"Had to install with sudo pip install mkdocs Run on an external port cd ~/pie/docs mkdocs serve -a 192.168.1.4:8000 # if that does not work, then mkdocs serve --dev-addr=0.0.0.0:8000 Push to github cd ~/pie/docs mkdocs gh-deploy","title":"MkDocs"},{"location":"rest-interface/","text":"Introduction The PiE server provides a REST interface allowing web URLs to get and set configuration parameters and to perform actions like starting and stopping recording. For example, if your Pi has the IP address 192.168.4, the status of the PiE server can be retreived with: http://192.168.1.4:5010/status The entire web interface is driven by calling this REST interface from Javascript in pie/pie_app/static/treadmill.js . You can use this REST interface to control the PiE server from Python or Matlab or make your own web interface using Javascript. Endpoints The following is a list of valid endpoints. Get /status /systeminfo /api/refreshsysteminfo /log /environmentlog /api/lastimage Set /api/set/animalid/<string:animalID> /api/set/conditionid/<string:conditionID> /api/set/scopefilename/<string:scopeFilename> Actions /api/action/<string:thisAction> thisAction action startRecord stopRecord startStream stopStream startArm stopArm startArmVideo stopArmVideo Submit/Post This is a POST endpoint to change any configuration parameter. Need to send POST data which is results or modified version of /status. /api/submit/<string:submitThis> thisAction action saveconfig Save current configuration (no post data) configparams pinparams animalparams ledparams motorparams /api/submit/loadconfig/<string:loadThis> Scripting with the REST interface Python In this example, we get the server status, toggle the white LED, and post this new data to change the white LED on the server. 1) Install requests if necessary pip3 install requests 2) Put this code into a file called 'testrest.py' import requests from pprint import pprint # get the current status url = 'http://192.168.1.4:5010/status' r = requests.get(url) status = r.json() status = status['trial']['config'] # toggle the white LED # we are hard coding [1] here, IR LED is [2] whiteLED = status['hardware']['eventOut'][1]['state'] whiteLED = not whiteLED status['hardware']['eventOut'][1]['state'] = whiteLED # post the changes url = 'http://192.168.1.4:5010/api/submit/ledparams' r = requests.post(url, json = status) # check that our changes were returned (meaning they were set on the server) status = r.json() status = status['trial']['config'] print('server whiteLED is now:', status['hardware']['eventOut'][1]['state']) # check the last response from the server print('last response: ') pprint(r.json()['trial']['runtime']['lastResponse']) 3) Run on command line python3 testrest.py Each time this script is run, the white LED will be toggled. Matlab Coming soon! Processing Processing is a healthy alternative to Matlab and/or Python as it allows many of the same functionality without the overhead of a complicated, large, and proprietary installation. The Processing code below will fetch the status of the PiE server, toggle both the white and IR LEDs and then set new values on the PiE server. // This code assumes that http.request library is installed // To install, select menu 'Sketch - Import Library... - Add Library...' and search for 'http requests' import http.requests.GetRequest; // search and replace 192.168.1.4 with the IP address of a PiE server // grab the PiE server 'status' using endpoint /status JSONObject status = loadJSONObject(\"http://192.168.1.4:5010/status\"); // (0) parse the PiE server 'status' into its different pieces JSONObject trial = status.getJSONObject(\"trial\"); JSONObject config = trial.getJSONObject(\"config\"); JSONObject hardware = config.getJSONObject(\"hardware\"); JSONArray eventOut = hardware.getJSONArray(\"eventOut\"); // eventOut is a JSON array // specify the white and IR LED indices (these are indices into JSON eventOut array) Integer whiteIdx = 1; Integer irIdx = 2; // (1) get the the initial 'state' of white and IR LEDs JSONObject whiteLED = eventOut.getJSONObject(whiteIdx); JSONObject irLED = eventOut.getJSONObject(irIdx); println(\"1\"); println(\"whiteLED 'state' was:\", whiteLED.getBoolean(\"state\")); println(\"irLED 'state' was:\", irLED.getBoolean(\"state\")); // (2) toggle/invert the 'state' of white and IR leds Boolean newWhiteState = ! whiteLED.getBoolean(\"state\"); Boolean newIRState = ! irLED.getBoolean(\"state\"); println(\"2\"); println(\"newWhiteState:\", newWhiteState); println(\"newIRState:\", newIRState); // convert from Boolean to int // endpoint /api/v2/set/led/<ledIdx>/<value> expects <value> in (0,1) and not in (true, false) int newWhiteStateInt = newWhiteState ? 1 : 0; int newIRStateInt = newIRState ? 1 : 0; // set the new values on the PiE server using REST endpoint /api/v2/set/led/<ledIdx>/<value> // where: // <ledIdx>: 1 for white, 2 for IR (e.g. whiteIdx and irIdx) // <value>: 1 for on, 0 for off GetRequest postWhite = new GetRequest(\"http://192.168.1.4:5010/api/v2/set/led/\" + whiteIdx + \"/\" + newWhiteStateInt); postWhite.send(); GetRequest postIR = new GetRequest(\"http://192.168.1.4:5010/api/v2/set/led/\" + irIdx + \"/\" + newIRStateInt); postIR.send(); // (3) grab the PiE server 'status' using endpoint /status again to ensure our changes took effect // You can also look at the web interface to see if the LED changes took effect !!! status = loadJSONObject(\"http://192.168.1.4:5010/status\"); // parse the PiE server 'status' into its different pieces, the same as step (0) above trial = status.getJSONObject(\"trial\"); config = trial.getJSONObject(\"config\"); hardware = config.getJSONObject(\"hardware\"); eventOut = hardware.getJSONArray(\"eventOut\"); whiteLED = eventOut.getJSONObject(whiteIdx); irLED = eventOut.getJSONObject(whiteIdx); println(\"3\"); println(\"whiteLED 'state' is now:\", whiteLED.getBoolean(\"state\")); println(\"irLED 'state' is now:\", irLED.getBoolean(\"state\"));","title":"Rest Interface"},{"location":"rest-interface/#introduction","text":"The PiE server provides a REST interface allowing web URLs to get and set configuration parameters and to perform actions like starting and stopping recording. For example, if your Pi has the IP address 192.168.4, the status of the PiE server can be retreived with: http://192.168.1.4:5010/status The entire web interface is driven by calling this REST interface from Javascript in pie/pie_app/static/treadmill.js . You can use this REST interface to control the PiE server from Python or Matlab or make your own web interface using Javascript.","title":"Introduction"},{"location":"rest-interface/#endpoints","text":"The following is a list of valid endpoints.","title":"Endpoints"},{"location":"rest-interface/#get","text":"/status /systeminfo /api/refreshsysteminfo /log /environmentlog /api/lastimage","title":"Get"},{"location":"rest-interface/#set","text":"/api/set/animalid/<string:animalID> /api/set/conditionid/<string:conditionID> /api/set/scopefilename/<string:scopeFilename>","title":"Set"},{"location":"rest-interface/#actions","text":"/api/action/<string:thisAction> thisAction action startRecord stopRecord startStream stopStream startArm stopArm startArmVideo stopArmVideo","title":"Actions"},{"location":"rest-interface/#submitpost","text":"This is a POST endpoint to change any configuration parameter. Need to send POST data which is results or modified version of /status. /api/submit/<string:submitThis> thisAction action saveconfig Save current configuration (no post data) configparams pinparams animalparams ledparams motorparams /api/submit/loadconfig/<string:loadThis>","title":"Submit/Post"},{"location":"rest-interface/#scripting-with-the-rest-interface","text":"","title":"Scripting with the REST interface"},{"location":"rest-interface/#python","text":"In this example, we get the server status, toggle the white LED, and post this new data to change the white LED on the server. 1) Install requests if necessary pip3 install requests 2) Put this code into a file called 'testrest.py' import requests from pprint import pprint # get the current status url = 'http://192.168.1.4:5010/status' r = requests.get(url) status = r.json() status = status['trial']['config'] # toggle the white LED # we are hard coding [1] here, IR LED is [2] whiteLED = status['hardware']['eventOut'][1]['state'] whiteLED = not whiteLED status['hardware']['eventOut'][1]['state'] = whiteLED # post the changes url = 'http://192.168.1.4:5010/api/submit/ledparams' r = requests.post(url, json = status) # check that our changes were returned (meaning they were set on the server) status = r.json() status = status['trial']['config'] print('server whiteLED is now:', status['hardware']['eventOut'][1]['state']) # check the last response from the server print('last response: ') pprint(r.json()['trial']['runtime']['lastResponse']) 3) Run on command line python3 testrest.py Each time this script is run, the white LED will be toggled.","title":"Python"},{"location":"rest-interface/#matlab","text":"Coming soon!","title":"Matlab"},{"location":"rest-interface/#processing","text":"Processing is a healthy alternative to Matlab and/or Python as it allows many of the same functionality without the overhead of a complicated, large, and proprietary installation. The Processing code below will fetch the status of the PiE server, toggle both the white and IR LEDs and then set new values on the PiE server. // This code assumes that http.request library is installed // To install, select menu 'Sketch - Import Library... - Add Library...' and search for 'http requests' import http.requests.GetRequest; // search and replace 192.168.1.4 with the IP address of a PiE server // grab the PiE server 'status' using endpoint /status JSONObject status = loadJSONObject(\"http://192.168.1.4:5010/status\"); // (0) parse the PiE server 'status' into its different pieces JSONObject trial = status.getJSONObject(\"trial\"); JSONObject config = trial.getJSONObject(\"config\"); JSONObject hardware = config.getJSONObject(\"hardware\"); JSONArray eventOut = hardware.getJSONArray(\"eventOut\"); // eventOut is a JSON array // specify the white and IR LED indices (these are indices into JSON eventOut array) Integer whiteIdx = 1; Integer irIdx = 2; // (1) get the the initial 'state' of white and IR LEDs JSONObject whiteLED = eventOut.getJSONObject(whiteIdx); JSONObject irLED = eventOut.getJSONObject(irIdx); println(\"1\"); println(\"whiteLED 'state' was:\", whiteLED.getBoolean(\"state\")); println(\"irLED 'state' was:\", irLED.getBoolean(\"state\")); // (2) toggle/invert the 'state' of white and IR leds Boolean newWhiteState = ! whiteLED.getBoolean(\"state\"); Boolean newIRState = ! irLED.getBoolean(\"state\"); println(\"2\"); println(\"newWhiteState:\", newWhiteState); println(\"newIRState:\", newIRState); // convert from Boolean to int // endpoint /api/v2/set/led/<ledIdx>/<value> expects <value> in (0,1) and not in (true, false) int newWhiteStateInt = newWhiteState ? 1 : 0; int newIRStateInt = newIRState ? 1 : 0; // set the new values on the PiE server using REST endpoint /api/v2/set/led/<ledIdx>/<value> // where: // <ledIdx>: 1 for white, 2 for IR (e.g. whiteIdx and irIdx) // <value>: 1 for on, 0 for off GetRequest postWhite = new GetRequest(\"http://192.168.1.4:5010/api/v2/set/led/\" + whiteIdx + \"/\" + newWhiteStateInt); postWhite.send(); GetRequest postIR = new GetRequest(\"http://192.168.1.4:5010/api/v2/set/led/\" + irIdx + \"/\" + newIRStateInt); postIR.send(); // (3) grab the PiE server 'status' using endpoint /status again to ensure our changes took effect // You can also look at the web interface to see if the LED changes took effect !!! status = loadJSONObject(\"http://192.168.1.4:5010/status\"); // parse the PiE server 'status' into its different pieces, the same as step (0) above trial = status.getJSONObject(\"trial\"); config = trial.getJSONObject(\"config\"); hardware = config.getJSONObject(\"hardware\"); eventOut = hardware.getJSONArray(\"eventOut\"); whiteLED = eventOut.getJSONObject(whiteIdx); irLED = eventOut.getJSONObject(whiteIdx); println(\"3\"); println(\"whiteLED 'state' is now:\", whiteLED.getBoolean(\"state\")); println(\"irLED 'state' is now:\", irLED.getBoolean(\"state\"));","title":"Processing"},{"location":"trial-file/","text":"Trial files are text files to log events that occur during a video recording. Trial file names are automatically generated with the date, time, and trial number as 'yyyymmdd_hhmmss_t[trial].txt' where [trial] is the trial number. Events are accumulated during each video recording, including 'record' and 'arm', and saved at the end of each recording into a trial file. Trial File Format All trial files begin with a one line header, followed by one line of column names and then any number of events (one line per event). Trial files are comma delimited except for the one line header. Here is an example trial file with 8 events: date=20180902;time=19:26:49;startTimeSeconds=1535930809.9245791;hostname=\"pi15\";id=\"\";condition=\"\";trialNum=4;numRepeats=1;repeatDuration=301;numRepeatsRecorded=1;repeatInfinity=\"False\";scopeFilename\"\";video_fps=30;video_resolution=\"640,480\"; date,time,linuxSeconds,secondsSinceStart,event,value,str,tick 20180902,19:26:49,1535930809.9245791,0.0,startTrial,4,,None 20180902,19:26:49,1535930809.95922,0.03464078903198242,newRepeat,1,,None 20180902,19:26:49,1535930809.9660773,0.04149818420410156,beforefilepath,1,/home/pi/video/20180902/20180902_192649_t4_r1_before.h264,None 20180902,19:26:49,1535930809.9661162,0.04153704643249512,afterfilepath,1,/home/pi/video/20180902/20180902_192649_t4_r1_after.h264,None 20180902,19:26:50,1535930810.1416507,0.217071533203125,frame,1,1654442841,710240.945 20180902,19:26:50,1535930810.1694624,0.24488329887390137,frame,2,1654476158,710270.944 20180902,19:26:51,1535930811.1701634,1.24558424949646,triggerIn,False,,711270.812 20180902,19:26:51,1535930811.252085,1.3275058269500732,stopTrial,4,,None Note that the date and start time of a trial (yyyymmdd and hh:mm:ss) appears in (i) the file name, (ii) the header, and (iii) the first 'startTrial' event. Trial File Header The trial file header is a single line with a semi-colon delimited list of token=value pairs. Tokens with a string or boolean type use double quotes (\"\") around their value. If there is no value for a string token, the double quotes are always included. Token Format Meaning date yyyymmdd time hh:mm:ss startTimeSeconds float hostname string The hostname of the Raspberry Pi. Useful to keep track of multiple machines. id string The id that is entered in the web, can be empty (e.g. \"\").interface. condition string The condition that is entered in the web interface, can be empty (e.g. \"\"). trialNum integer numRepeats integer repeatDuration float numRepeatsRecorded integer The number of repeats actually recorded. Can be different from numRepeats if the user stops the video recording before it is finished. repeatInfinity boolean scopeFilename string video_fps integer The frames-per-second of the recorded video, set in the web interface. video_resolution string The width and height of the video recording (in pixels). For example \"640,480\" or \"1024,768\" Trial File Events All events begin with date, time, linuxSeconds, and secondsSinceStart tokens. Token Value date yyyymmdd time hh:mm:ss linuxSeconds A long float representing the time since the linux epoch, this value comes from the Python time package time.time(). secondsSinceStart A long float representing the number of seconds (with fraciton) soince the 'start trigger was received'. All events end with a 'tick' token. Tick tokens are unsigned float that represents the micro-seconds since the startTrial event. These are only used if the pigpio daemon has been activated. If the pigpiod is not active, all ticks will be logged as 'None' (without the single-quotes). Using pigpio gives better precision for GPIO events compared to the standard Python time.time() function. Keep in mind, although events are more precise, they can still be missed! Event Class value str tick startTrial bTrial The trial number stopTrial bTrial The trial number newRepeat bTrial The repeat (epoch) number whiteLED bTrial 1 for on, 0 for off irLED bTrial 1 for on, 0 for off temperature bTrial The temperature in celcius (assumes using a DHT sensor) humidity bTrial The % relative humidity (assumes using a DHT sensor) triggerIn bPins frame bPins The frame number generic bPins user2 bPins beforefilepath bCamera n/a Full path to pre trigger video file. afterfilepath bCamera n/a Full path to main video file. The whole point of the PiE server. startArmedRecording bCamera Time armed recording was started. The code to retrieve this time is immediately after the code to start the camera. As such, it is a more precide time-stamp for the actual time the video was started. stopArmedRecording bCamera Same idea but at the stop of armed recording, see startArmedRecording. startVideoRecord bCamera See startArmedRecording. stopVideoRecord bCamera Same idea but at the stop of recording, see startArmedRecording","title":"Trial File"},{"location":"trial-file/#trial-file-format","text":"All trial files begin with a one line header, followed by one line of column names and then any number of events (one line per event). Trial files are comma delimited except for the one line header. Here is an example trial file with 8 events: date=20180902;time=19:26:49;startTimeSeconds=1535930809.9245791;hostname=\"pi15\";id=\"\";condition=\"\";trialNum=4;numRepeats=1;repeatDuration=301;numRepeatsRecorded=1;repeatInfinity=\"False\";scopeFilename\"\";video_fps=30;video_resolution=\"640,480\"; date,time,linuxSeconds,secondsSinceStart,event,value,str,tick 20180902,19:26:49,1535930809.9245791,0.0,startTrial,4,,None 20180902,19:26:49,1535930809.95922,0.03464078903198242,newRepeat,1,,None 20180902,19:26:49,1535930809.9660773,0.04149818420410156,beforefilepath,1,/home/pi/video/20180902/20180902_192649_t4_r1_before.h264,None 20180902,19:26:49,1535930809.9661162,0.04153704643249512,afterfilepath,1,/home/pi/video/20180902/20180902_192649_t4_r1_after.h264,None 20180902,19:26:50,1535930810.1416507,0.217071533203125,frame,1,1654442841,710240.945 20180902,19:26:50,1535930810.1694624,0.24488329887390137,frame,2,1654476158,710270.944 20180902,19:26:51,1535930811.1701634,1.24558424949646,triggerIn,False,,711270.812 20180902,19:26:51,1535930811.252085,1.3275058269500732,stopTrial,4,,None Note that the date and start time of a trial (yyyymmdd and hh:mm:ss) appears in (i) the file name, (ii) the header, and (iii) the first 'startTrial' event.","title":"Trial File Format"},{"location":"trial-file/#trial-file-header","text":"The trial file header is a single line with a semi-colon delimited list of token=value pairs. Tokens with a string or boolean type use double quotes (\"\") around their value. If there is no value for a string token, the double quotes are always included. Token Format Meaning date yyyymmdd time hh:mm:ss startTimeSeconds float hostname string The hostname of the Raspberry Pi. Useful to keep track of multiple machines. id string The id that is entered in the web, can be empty (e.g. \"\").interface. condition string The condition that is entered in the web interface, can be empty (e.g. \"\"). trialNum integer numRepeats integer repeatDuration float numRepeatsRecorded integer The number of repeats actually recorded. Can be different from numRepeats if the user stops the video recording before it is finished. repeatInfinity boolean scopeFilename string video_fps integer The frames-per-second of the recorded video, set in the web interface. video_resolution string The width and height of the video recording (in pixels). For example \"640,480\" or \"1024,768\"","title":"Trial File Header"},{"location":"trial-file/#trial-file-events","text":"All events begin with date, time, linuxSeconds, and secondsSinceStart tokens. Token Value date yyyymmdd time hh:mm:ss linuxSeconds A long float representing the time since the linux epoch, this value comes from the Python time package time.time(). secondsSinceStart A long float representing the number of seconds (with fraciton) soince the 'start trigger was received'. All events end with a 'tick' token. Tick tokens are unsigned float that represents the micro-seconds since the startTrial event. These are only used if the pigpio daemon has been activated. If the pigpiod is not active, all ticks will be logged as 'None' (without the single-quotes). Using pigpio gives better precision for GPIO events compared to the standard Python time.time() function. Keep in mind, although events are more precise, they can still be missed! Event Class value str tick startTrial bTrial The trial number stopTrial bTrial The trial number newRepeat bTrial The repeat (epoch) number whiteLED bTrial 1 for on, 0 for off irLED bTrial 1 for on, 0 for off temperature bTrial The temperature in celcius (assumes using a DHT sensor) humidity bTrial The % relative humidity (assumes using a DHT sensor) triggerIn bPins frame bPins The frame number generic bPins user2 bPins beforefilepath bCamera n/a Full path to pre trigger video file. afterfilepath bCamera n/a Full path to main video file. The whole point of the PiE server. startArmedRecording bCamera Time armed recording was started. The code to retrieve this time is immediately after the code to start the camera. As such, it is a more precide time-stamp for the actual time the video was started. stopArmedRecording bCamera Same idea but at the stop of armed recording, see startArmedRecording. startVideoRecord bCamera See startArmedRecording. stopVideoRecord bCamera Same idea but at the stop of recording, see startArmedRecording","title":"Trial File Events"},{"location":"troubleshooting/","text":"The first thing to check is the PiE server log. The log can be viewed in many ways, From the web interface By running the PiE server on the command line with ./pie run By directly viewing the log file with more ~/pie/pie_app/pie.log Common Errors OSError: [Errno 98] Address already in use This happens when you try and start the server but it is already running. Usually when it is running in the background and you run it again with ./pie run . Just stop the server with ./pie stop and then try again with ./pie run . Troubleshooting the camera Capture a still image with the Pi camera with: raspistill -o test.jpg If you get any errors then there is a problem with the Pi Camera. Make sure the Pi Camera is activated. # type this at a command prompt sudo raspi-config # select '5 Interface Options' # select 'P1 Camera' # Answer 'Yes' to question 'Would you like the camera interface to be enabled?' bCamera PiCameraMMALError: Failed to enable connection: Out of resources If you receive this error in the web interface or PiE server log, it means the camera is in use by some other process. The Raspberry camera can only do one thing at a time, it can stream or record but not both at the same time. In addition, the camera can not record (or stream) in two different programs simultaneously. Make sure other programs are not using the camera and try again. Rebooting with 'sudo reboot' usually does the trick unless these programs, like the PiE server, are set up to run at boot. Troubleshooting a DHT temperature/humidity sensor Run the simplified code in the testing/ folder. If you can't get a temperature/humidity reading with this code, it will not work within the PiE server. Check the PiE server log (see above) and make sure the Adafruit DHT driver is installed and run when the PiE server is started. You should see entries in the PiE server log like this: [2018-10-14 09:53:59,596] {bTrial.py <module>:51} DEBUG - Loaded Adafruit_DHT [2018-10-14 09:54:00,168] {bTrial.py __init__:178} DEBUG - starting temperature thread [2018-10-14 09:54:00,172] {bTrial.py tempThread:918} INFO - tempThread() sensorTypeStr:AM2302 sensorType:22 pin:4 If the DHT driver is not installed, install it with ./install-dht , restart the PiE server with ./pie restart , and check the PiE server log again. Converting video to mp4 The PiE server uses libav (avconv) to convert video from .h264 to .mp4. If libav (avconv) does not install during ~/pie/install-pie , this conversion will not work. Troubleshooting uv4l streaming In rare instances the uv4l streaming server does not stop properly. Streaming with uv4l runs at the system level and not in Python. As such, uv4l needs to be controlled via the command line. #list all uv4l processes ps -aux | grep uv4l # will yield something like root 23117 9.8 1.3 140796 12312 ? Ssl 20:34 0:02 uv4l --driver raspicam --auto-video_nr --encoding h264 --width 640 --height 480 --enable-server on pi 23262 0.0 0.1 6644 1316 pts/1 S+ 20:34 0:00 grep --color=auto uv4l # kill uv4l with its process id (PID) # '--' is needed to kill parent and child processes sudo kill -- 23117 #check the uv4l process is no longer running ps -aux | grep uv4l # should yield pi 674 0.0 0.1 6644 1320 pts/0 S+ 21:06 0:00 grep --color=auto uv4l uv4l will not go away Worst case senario is ps -aux | grep uvl4 yields something like this root 23117 17.2 0.0 0 0 ? Zsl 20:34 0:37 [uv4l] <defunct> If you see the <defunct> then restart the Pi with sudo reboot and it should be fixed. Manually editing user config (json) files The PiE server comes with three default sets of options: Homecage, Scope, and Treadmill. There is an additional User configuration that can be edited manually to configure the PiE server. To edit the User file, open pie/pie_app/config/config_user.json in the pie/pie_app/config/ folder. The format of the file is [json][json] and basically specifies key/value pairs. Do not add or remove any keys, just change their values. The json format is very strict, if there are any syntax errors, the file will not load and the PiE server will not run. To check your work, use cd ~/pie/pie_app/config cat config_user.json | python -m json.tool If your edits are syntatically correct, this command will output the contents of the file. If you have created an error, they will be reported on the command line. For example, if your forget a comma after \"enabled\": true like this \"triggerIn\": { \"enabled\": true \"pin\": 23, \"polarity\": \"rising\", \"pull_up_down\": \"down\" }, You will get an error Expecting , delimiter: line 27 column 13 (char 648) Checking system and software versions The PiE server should work out of the box but as system and Python libraries are updated, things can potentially become broken. Thus, it is important to check and verify a number of system and Python Package versions. Here is a snapshot of versions for a working PiE server as of October 2018. As python packages are updated, things can potentially break. === linux: ('debian', '9.4', '') Linux hc4 4.14.71-v7+ #1145 SMP Fri Sep 21 15:38:35 BST 2018 armv7l GNU/Linux === python: 3.5.3 (default, Jan 19 2017, 14:11:04) [GCC 6.3.0 20170124] === PiE: 20190104a === picamera: [picamera 1.13 (/home/pi/pie/pie_env/lib/python3.5/site-packages)] === RPi.GPIO: 0.6.3 === serial: 3.4 === flask: 1.0.2 === flask_cors: 3.0.6 === flask_socketio: 3.0.2 === avconv: ffmpeg version 3.2.10-1~deb9u1+rpt2 Copyright (c) 2000-2018 the FFmpeg developers built with gcc 6.3.0 (Raspbian 6.3.0-18+rpi1+deb9u1) 20170516 configuration: --prefix=/usr --extra-version='1~deb9u1+rpt2' --toolchain=hardened --libdir=/usr/lib/arm-linux-gnueabihf --incdir=/usr/include/arm-linux-gnueabihf --enable-gpl --disable-stripping --enable-avresample --enable-avisynth --enable-gnutls --enable-ladspa --enable-libass --enable-libbluray --enable-libbs2b --enable-libcaca --enable-libcdio --enable-libebur128 --enable-libflite --enable-libfontconfig --enable-libfreetype --enable-libfribidi --enable-libgme --enable-libgsm --enable-libmp3lame --enable-libopenjpeg --enable-libopenmpt --enable-libopus --enable-libpulse --enable-librubberband --enable-libshine --enable-libsnappy --enable-libsoxr --enable-libspeex --enable-libssh --enable-libtheora --enable-libtwolame --enable-libvorbis --enable-libvpx --enable-libwavpack --enable-libwebp --enable-libx265 --enable-libxvid --enable-libzmq --enable-libzvbi --enable-omx-rpi --enable-mmal --enable-openal --enable-opengl --enable-sdl2 --enable-libdc1394 --enable-libiec61883 --arch=armhf --enable-chromaprint --enable-frei0r --enable-libopencv --enable-libx264 --enable-shared libavutil 55. 34.101 / 55. 34.101 libavcodec 57. 64.101 / 57. 64.101 libavformat 57. 56.101 / 57. 56.101 libavdevice 57. 1.100 / 57. 1.100 libavfilter 6. 65.100 / 6. 65.100 libavresample 3. 1. 0 / 3. 1. 0 libswscale 4. 2.100 / 4. 2.100 libswresample 2. 3.100 / 2. 3.100 libpostproc 54. 1.100 / 54. 1.100 === uv4l Userspace Video4Linux Copyright (C) Luca Risolia Version 1.9.16 built on Oct 6 2018 Version check using the rest interface With a PiE server running, browse to this url: http://[IP]:5010/version Version check from the command line cd ~/pie source pie_env/bin/activate # activate the Python3 virtual environment python version_check.py # run version check Other versions to check cat /etc/os-release # returns PRETTY_NAME=\"Raspbian GNU/Linux 9 (stretch)\" NAME=\"Raspbian GNU/Linux\" VERSION_ID=\"9\" VERSION=\"9 (stretch)\" ID=raspbian ID_LIKE=debian uname -a # returns Linux pi15 4.14.52-v7+ #1123 SMP Wed Jun 27 17:35:49 BST 2018 armv7l GNU/Linux","title":"Troubleshooting"},{"location":"troubleshooting/#common-errors","text":"","title":"Common Errors"},{"location":"troubleshooting/#oserror-errno-98-address-already-in-use","text":"This happens when you try and start the server but it is already running. Usually when it is running in the background and you run it again with ./pie run . Just stop the server with ./pie stop and then try again with ./pie run .","title":"OSError: [Errno 98] Address already in use"},{"location":"troubleshooting/#troubleshooting-the-camera","text":"Capture a still image with the Pi camera with: raspistill -o test.jpg If you get any errors then there is a problem with the Pi Camera. Make sure the Pi Camera is activated. # type this at a command prompt sudo raspi-config # select '5 Interface Options' # select 'P1 Camera' # Answer 'Yes' to question 'Would you like the camera interface to be enabled?'","title":"Troubleshooting the camera"},{"location":"troubleshooting/#bcamera-picamerammalerror-failed-to-enable-connection-out-of-resources","text":"If you receive this error in the web interface or PiE server log, it means the camera is in use by some other process. The Raspberry camera can only do one thing at a time, it can stream or record but not both at the same time. In addition, the camera can not record (or stream) in two different programs simultaneously. Make sure other programs are not using the camera and try again. Rebooting with 'sudo reboot' usually does the trick unless these programs, like the PiE server, are set up to run at boot.","title":"bCamera PiCameraMMALError: Failed to enable connection: Out of resources"},{"location":"troubleshooting/#troubleshooting-a-dht-temperaturehumidity-sensor","text":"Run the simplified code in the testing/ folder. If you can't get a temperature/humidity reading with this code, it will not work within the PiE server. Check the PiE server log (see above) and make sure the Adafruit DHT driver is installed and run when the PiE server is started. You should see entries in the PiE server log like this: [2018-10-14 09:53:59,596] {bTrial.py <module>:51} DEBUG - Loaded Adafruit_DHT [2018-10-14 09:54:00,168] {bTrial.py __init__:178} DEBUG - starting temperature thread [2018-10-14 09:54:00,172] {bTrial.py tempThread:918} INFO - tempThread() sensorTypeStr:AM2302 sensorType:22 pin:4 If the DHT driver is not installed, install it with ./install-dht , restart the PiE server with ./pie restart , and check the PiE server log again.","title":"Troubleshooting a DHT temperature/humidity sensor"},{"location":"troubleshooting/#converting-video-to-mp4","text":"The PiE server uses libav (avconv) to convert video from .h264 to .mp4. If libav (avconv) does not install during ~/pie/install-pie , this conversion will not work.","title":"Converting video to mp4"},{"location":"troubleshooting/#troubleshooting-uv4l-streaming","text":"In rare instances the uv4l streaming server does not stop properly. Streaming with uv4l runs at the system level and not in Python. As such, uv4l needs to be controlled via the command line. #list all uv4l processes ps -aux | grep uv4l # will yield something like root 23117 9.8 1.3 140796 12312 ? Ssl 20:34 0:02 uv4l --driver raspicam --auto-video_nr --encoding h264 --width 640 --height 480 --enable-server on pi 23262 0.0 0.1 6644 1316 pts/1 S+ 20:34 0:00 grep --color=auto uv4l # kill uv4l with its process id (PID) # '--' is needed to kill parent and child processes sudo kill -- 23117 #check the uv4l process is no longer running ps -aux | grep uv4l # should yield pi 674 0.0 0.1 6644 1320 pts/0 S+ 21:06 0:00 grep --color=auto uv4l","title":"Troubleshooting uv4l streaming"},{"location":"troubleshooting/#uv4l-will-not-go-away","text":"Worst case senario is ps -aux | grep uvl4 yields something like this root 23117 17.2 0.0 0 0 ? Zsl 20:34 0:37 [uv4l] <defunct> If you see the <defunct> then restart the Pi with sudo reboot and it should be fixed.","title":"uv4l will not go away"},{"location":"troubleshooting/#manually-editing-user-config-json-files","text":"The PiE server comes with three default sets of options: Homecage, Scope, and Treadmill. There is an additional User configuration that can be edited manually to configure the PiE server. To edit the User file, open pie/pie_app/config/config_user.json in the pie/pie_app/config/ folder. The format of the file is [json][json] and basically specifies key/value pairs. Do not add or remove any keys, just change their values. The json format is very strict, if there are any syntax errors, the file will not load and the PiE server will not run. To check your work, use cd ~/pie/pie_app/config cat config_user.json | python -m json.tool If your edits are syntatically correct, this command will output the contents of the file. If you have created an error, they will be reported on the command line. For example, if your forget a comma after \"enabled\": true like this \"triggerIn\": { \"enabled\": true \"pin\": 23, \"polarity\": \"rising\", \"pull_up_down\": \"down\" }, You will get an error Expecting , delimiter: line 27 column 13 (char 648)","title":"Manually editing user config (json) files"},{"location":"troubleshooting/#checking-system-and-software-versions","text":"The PiE server should work out of the box but as system and Python libraries are updated, things can potentially become broken. Thus, it is important to check and verify a number of system and Python Package versions. Here is a snapshot of versions for a working PiE server as of October 2018. As python packages are updated, things can potentially break. === linux: ('debian', '9.4', '') Linux hc4 4.14.71-v7+ #1145 SMP Fri Sep 21 15:38:35 BST 2018 armv7l GNU/Linux === python: 3.5.3 (default, Jan 19 2017, 14:11:04) [GCC 6.3.0 20170124] === PiE: 20190104a === picamera: [picamera 1.13 (/home/pi/pie/pie_env/lib/python3.5/site-packages)] === RPi.GPIO: 0.6.3 === serial: 3.4 === flask: 1.0.2 === flask_cors: 3.0.6 === flask_socketio: 3.0.2 === avconv: ffmpeg version 3.2.10-1~deb9u1+rpt2 Copyright (c) 2000-2018 the FFmpeg developers built with gcc 6.3.0 (Raspbian 6.3.0-18+rpi1+deb9u1) 20170516 configuration: --prefix=/usr --extra-version='1~deb9u1+rpt2' --toolchain=hardened --libdir=/usr/lib/arm-linux-gnueabihf --incdir=/usr/include/arm-linux-gnueabihf --enable-gpl --disable-stripping --enable-avresample --enable-avisynth --enable-gnutls --enable-ladspa --enable-libass --enable-libbluray --enable-libbs2b --enable-libcaca --enable-libcdio --enable-libebur128 --enable-libflite --enable-libfontconfig --enable-libfreetype --enable-libfribidi --enable-libgme --enable-libgsm --enable-libmp3lame --enable-libopenjpeg --enable-libopenmpt --enable-libopus --enable-libpulse --enable-librubberband --enable-libshine --enable-libsnappy --enable-libsoxr --enable-libspeex --enable-libssh --enable-libtheora --enable-libtwolame --enable-libvorbis --enable-libvpx --enable-libwavpack --enable-libwebp --enable-libx265 --enable-libxvid --enable-libzmq --enable-libzvbi --enable-omx-rpi --enable-mmal --enable-openal --enable-opengl --enable-sdl2 --enable-libdc1394 --enable-libiec61883 --arch=armhf --enable-chromaprint --enable-frei0r --enable-libopencv --enable-libx264 --enable-shared libavutil 55. 34.101 / 55. 34.101 libavcodec 57. 64.101 / 57. 64.101 libavformat 57. 56.101 / 57. 56.101 libavdevice 57. 1.100 / 57. 1.100 libavfilter 6. 65.100 / 6. 65.100 libavresample 3. 1. 0 / 3. 1. 0 libswscale 4. 2.100 / 4. 2.100 libswresample 2. 3.100 / 2. 3.100 libpostproc 54. 1.100 / 54. 1.100 === uv4l Userspace Video4Linux Copyright (C) Luca Risolia Version 1.9.16 built on Oct 6 2018","title":"Checking system and software versions"},{"location":"troubleshooting/#version-check-using-the-rest-interface","text":"With a PiE server running, browse to this url: http://[IP]:5010/version","title":"Version check using the rest interface"},{"location":"troubleshooting/#version-check-from-the-command-line","text":"cd ~/pie source pie_env/bin/activate # activate the Python3 virtual environment python version_check.py # run version check","title":"Version check from the command line"},{"location":"troubleshooting/#other-versions-to-check","text":"cat /etc/os-release # returns PRETTY_NAME=\"Raspbian GNU/Linux 9 (stretch)\" NAME=\"Raspbian GNU/Linux\" VERSION_ID=\"9\" VERSION=\"9 (stretch)\" ID=raspbian ID_LIKE=debian uname -a # returns Linux pi15 4.14.52-v7+ #1123 SMP Wed Jun 27 17:35:49 BST 2018 armv7l GNU/Linux","title":"Other versions to check"},{"location":"video-annotate/","text":"Video annotate is a desktop application that provides a simple to use point and click interface to annotatate behavioral events in video files. This is in its own Github repository named Pie-Analysis Example screenshot of editing a video 'chunk'. All events within the chunk are shown schematically below the video. The number in the event is the event type (1..9). Selecting an event will snap the video to the first frame of the event. In this case, the 4th event is selected. Once selected the event start/stop frame can be edited with keyboard 'f' and 'l'. Install Clone the source git clone https://github.com/cudmore/pie-analysis.git Make a Python virtual environment python -m venv video-annotate source video-annotate/bin/activate Install the video-player requirements cd video-player pip install -r requirements.txt Run desktop GUI of video player python src/VideoApp.py Directions for Using VideoAnnotate for Behavior Scoring Open VideoAnnotate and under File, select the folder with the video files to be analyzed. Click \u201cgenerate chunks\u201d. Change the piece duration (if chunks need to be selected evenly across the video file), duration of the chunks, and number of chunks per file. Navigate to the folder on the hard drive, duplicate the chunks file and name the copy \u201crandomChunks.txt\u201d Quit VideoAnnotate and relaunch the application. Select the relevant folder of videos and under the Window menu, see that \u201cBlind Interface\u201d is selected. The chunks will appear starting at 0/1234 (1234 will be the total number of chunks across the entire folder you selected). Use the space bar to play the chunk #0, and at the occurrence of a behavior of interest, press the computer key 1-9 corresponding to the specific behavior being scored. Click the arrow for Next Chunk and continue doing so until scoring is complete. If duration of behaviors is needed, click the number corresponding to the specific behavior and use the \u201cf\u201d and \u201cl\u201d keys to set the duration of the first and last frames during which the behavior occurs. When scoring is complete, VideoAnnotate will have written csv files into the folder containing the video files. Each csv can be read into excel, R, MatLab, or whatever the user\u2019s choice of analysis software may be. Keyboard commands Controlling video Keyboard Action space play/pause left-arrow Move backwards in video rigth-arrow Move forwards in video shift + left arrow Larger move backward in video shift + right arrow Larger move forward in video + Play video faster - Play video slower Editing events Keyboard Action 1..9 Create new event at current frame f Set first frame of selected event l Set last frame of selected event n Set note of current selected event Chunks Keyboard Action [ Previous Chunk ] Next Chunk There are currently 9 event types corresponding to keyboard 1, 2, 3, 4, 5, 6, 7, 8, 9. Menus File Open Folder... - Open a folder of video files. Video files must be mp4. Open Random Chunks... - Open a random chunks file. See Blind scoring . Save Options - Save options to a file. Options will be reloaded next time program runs. See Options file . Quit - Quit the video player. Options are automatically saved before quit. Window Toggle interface on/off for: video files, events, video feedback, and chunks. Saving events All events are automatically saved in a text file (.txt) with the same base name as the video file. One events .txt file per video file. The events file is saved when new events are created or edited (first/last frame, note, file video note). First line in events file is comma separated list of name=value pairs describing the associated video. Second line is column headers. Remaining lines in file are event with one event per line. For example, an events file with three events would look like this: # path=/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,fileName=1-homecage-movie.mp4,width=640.0,height=480.0,aspectRatio=0.75,fps=15.0,numFrames=4500,numSeconds=300.0,numEvents=22,videoFileNote=, index,path,cSeconds,cDate,cTime,typeNum,typeStr,frameStart,frameStop,numFrames,sStart,sStop,numSeconds,chunkIndex,note, 0,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552305.756366,2018-11-29,23:31:45,1,a,2468,,None,164.53,None,None,4,,, 1,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552306.0374012,2018-11-29,23:31:46,2,b,2468,,None,164.53,None,None,4,,, 2,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552306.435797,2018-11-29,23:31:46,3,c,2473,,None,164.87,None,None,4,,, 3,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552306.8971589,2018-11-29,23:31:46,4,d,2479,,None,165.27,None,None,4,,, Analysis Event Analysis See Analysis/eventAnalysis . For each file, sum duration (sec) of each event type (1..9) flag events that have start/stop frame out of order flag events that overlap with previous event (if previous has duration) flag events outside of a chunk Blinding analysis Make plot of chunks with each file in a list of files. See Analysis/chunkAnalysis . Blind Scoring Button Action < Go to previous chunk (keyboard '[') |< Go to start of current chunk > Go to next chunk (keyboard ']') Go To Go to chunk number specified in the edit/spin box. Limit Video Controls Limit the video frame slider and all video controls (including keyboard) to stay within the current chunk. In addition, when checked, the event list will only show events within the current chunk. Blind scoring is done with a user created 'chunks' file. Once created, blinding is achieved by stepping through a number of (random) video chunks of a specified length. Use the following code to generate a chunks file for a folder of video files. Once created, rename the output file to 'randomChunks.txt' and it will automatically be loaded when the folder of video is loaded into the video-player. # full path to your video folder path = '/Users/cudmore/Dropbox/PiE/video' chunks = bChunk(path) pieceDurationSeconds = 10 * 60 # seconds chunkDurationSeconds = 10 # seconds chunksPerFile = 30 outFile = chunks.generate(pieceDurationSeconds, chunkDurationSeconds, chunksPerFile) Blinding Algorithm video file duration (30 min) pieceDur (10 min) gives us numPieces = dur / pieceDur totalNumChunks (30) is total number of chunks for one video chunkDur (10 sec) is duration of each chunk split video into a large number of chunks numChunks = (dur/chunkDur) partition video into a number of 'pieces' numPieces = (dur/pieceDur) chunksPerPiece = totalNumChunks/numPieces for each 'piece', randomly choose chunksPerPiece without replacement. Can do this by stepping through all chunks and only considering chunks with a piece using chunksPerPiece. Here is an example of the results of the blinding algorithm for 6 video files, 30 chunks each. Each colored symbol is a different random chunk (duration 10 sec) and the color scale shows the order the chunks are visited. There are 180 chunks spread across the 6 files. Blinding file format params: dict of parameters used to generate random chunks chunkDurationSeconds: chunksPerFile: pieceDurationSeconds: generated: chunkOrder: integer list of random chunk order chunks: dict list of chunks chunks { \"index\": 0, \"numFrames\": 299, \"path\": \"/Users/cudmore/Dropbox/PiE/scrambled/s_1831.mp4\", \"piece\": 0, \"randomIndex\": 55, \"startFrame\": 5083, \"stopFrame\": 5381 }, { \"index\": 1, \"numFrames\": 299, \"path\": \"/Users/cudmore/Dropbox/PiE/scrambled/s_1831.mp4\", \"piece\": 0, \"randomIndex\": 29, \"startFrame\": 11362, \"stopFrame\": 11660 }, { \"index\": 2, \"numFrames\": 299, \"path\": \"/Users/cudmore/Dropbox/PiE/scrambled/s_1831.mp4\", \"piece\": 0, \"randomIndex\": 16, \"startFrame\": 13156, \"stopFrame\": 13454 }, Options file Interface options can be saved with menu 'File - Save Options'. Options are also saved each time the program is quit with 'File - Quit'. The options are saved in a json file 'options.json' and can be manually edited. By manually editing the 'options.json' file, mappings between event numbers 1..9 and names can be specified. In addition, the duration the video is advanced/reversed with either the keyboard or video control buttons can be set with 'smallSecondsStep' and 'largeSecondsStep'. { \"appWindowGeometry\": \"1035x698\", \"eventTypes\": { \"1\": \"a\", \"2\": \"b\", \"3\": \"c\", \"4\": \"d\", \"5\": \"e\", \"6\": \"f\", \"7\": \"g\", \"8\": \"h\", \"9\": \"i\" }, \"fpsIncrement\": 5, \"smallSecondsStep\": 10, \"largeSecondsStep\": 60, \"showVideoFiles\": true, \"showEvents\": true, \"showRandomChunks\": true, \"showVideoFeedback\": true, \"videoFileSash\": 200, \"eventSash\": 400, \"lastPath\": \"/Users/cudmore/Dropbox/PiE/video\" } Known bugs [fixed] Has some problems when it reaches end of file. [fixed] Resizing window will sometimes cause a crash. Check that avconv (used by PiE server on Pi) always generates valid mp4 files. See here . In at least one file, getting errors like 'Invalid NAL unit size' and 'Error splitting the input into NAL'. Maybe save original .h264 on Pi so we can convert later if neccessary. To Do (important) Add keys to set event 1..9 to preferences [done] Implement single menu to turn blinding on/off [bug] turning blinding on, the video stream is not paused??? scrolling up/down with arrow keys through video file list is NOT updating to next video. Clicking in list DOES work. When starting app and chunk file is loaded, make sure we are in chunk 0. When user first clicks 'limit', we need to be in a chunk!!! Clicking on a chunk (gray bar) should select chunk (in chunk view). Selecting event in event list should highlight event in event canvas. Streamline interface for blinding. Make a system where when handed to a scorer, they can not activate non-blinded interface (they are locked into blinding). Try and add a password to switch between one and the other. Update numEvents in video list as we add/delete events Make menu interface to create random chunks file from folder. So we can do it in stand-alone app Add dIndex to events so we can always show events in list with 'index' column as 1,2,3,... When editing chunks, do not allow video list selection Recalculate chunkIndex when setting event startFrame with keyboard 'f'. [hard] switch event list interface when editing chunks. Show frame start/stop relative to start of current chunk To Do [done?] Fix chunk interface, it is remembering pointers to old chunk file Implement options dialog to set small/big keyboard steps (Seconds) Finish 'about dialog' Make fps a spin box to easily increase/descrease. [solved] Highlight most recent event in list as video is played. Need to sort by startFrame. [solved] Add option to warn when event frame start/stop is out of order, e.g. frameStart>frameStop. Add note to video file by putting it in event list header. Finish 'right-click' popup menu in video list. [bug] Make sure toggle of video file and event list do not trash interface on next run. Need to add code to HIDE video and event list, currently setting sashpos==0 (remove this). [bug] When increasing/decreasing fps with +/-, sometimes can not get back to orignal fps. Fix this. This is now fixed but minimum fps is no longer 1 fps. [big idea - done] Make a visual bar for each video file showing: duration (black) overlaid .with position of chunks (gray), and position of events (bright colors). To Do (done) [done] In event tree, select and go to next event when event is deleted (if next event exists) [done] Add option to turn off delete event warning [done] Implement second layer of blinding with 'parts' to evenly distribute random chunks through file [done] Finish sorting event columns when clicked. Need to insert str(), int(), float() to do this. [done] Just always sort events by frameStart. [done] Implement 'delete event'. Add dialog to ask if ok. [done] Sort events after setting first frame [done] Add differnet small/big step for chunk edit [done] Standardize chunk index. I am showing random index in chunk interface but absolute chunk index in event list. Now building standalone app with pyinstaller Added video edit icon [hopefully done, bug] Make sure chunk navigation is working: >, <, go to. [hopefully done, bug] frame slider gets corrupted and does not move during chunk editing [hopefully done, bug] Make sure video controls (buttons and keyboard) stay within chunk when 'Limit Controls' is on. [done] Need some way to 1) categorize/file each event into its chunk 2) detect events falling outside a chunk. [done] During chunk editing, hijack ALL video controls (frame slider, play, >, >>, <, <<) to only allow scrolling through frames in current chunk. [done] Add checkbox to activate/inactivate chunk editing. [done] Running video faster/slower using +/- increments frame interval, it should increment frames per second (+/- 5 fps). Maximum fps for tkinter seems to be ~90 fps. [done] Implement saving/loading options via JSON file. Include window geometry, show/hide, (MAYBE) mapping of event numbers to names. [done] Toggle 'play' button to reflect state e.g. play and pause. [done] Add option to hide video controls like we hide video file list and event list. [done] Add information about video file to saved event list .txt file, e.g. (path=xxx, numframes=yyy, fps=zzz). [done] Expand code to open a folder of video files. Right now it is one hard-coded video file. [done] Add standard video control buttons like play/pause/forward/backward/large-forward/large-backward. [done] Finish setting event notes with keyboard 'n'. [done] Write recipe for installation into Python virtual environment. [done] Design system where events can have start/stop frames or start frame and number of frames (duration). Right now events only have single (start) frame. Troubleshooting Standalone app Right-click the .app and select 'Show Package Contents' Run the app directly by double-clicking 'Contents - macOS - VideoAnnotate'. This will run the app with a text console showing feedback on the state of the program. If there are errors, they will appear in the text console. Running from source If there are errors when running, check the versions. The video-player requires: Python 3.7 (includes tkinter 8.x) numpy opencv 3 Pillow Check Python version with 'python --version'. Check Python libraries with 'pip3 freeze'. numpy==1.15.4 Pillow==5.3.0 If having problems with opencv, try both installing into Python 'pip3 install opencv-python' and/or installing with brew with 'brew install opencv3 --with-python3'. The opencv version should be 'opencv-python==3.4.3.18' or newer. old - Install old - Install - Using 'install-player' script This install recipe assumes you have Python 3.7, pip, virtualenv, homebrew, and git installed on your computer. If you do not have these things or have no idea what we are talking about, then please see the Install - Step By Step section below. Clone repository cd ~ git clone https://github.com/cudmore/pie-analysis.git Install video-player cd pie-analysis/video-player ./install-player Run cd pie-analysis/video-player ./player old - Install - Using requirements file Requires Python 3.7, Open CV 3, Pillow (PIL), Numpy git clone https://github.com/cudmore/pie-analysis.git cd pie-analysis/video-player mkdir player_env virtualenv -p python3 --no-site-packages player_env source player_env/bin/activate pip install -r requirements.txt # run the player cd src python3 VideoApp.py old - Install - Step By Step You will install the following Homebrew Python 3.7 Virtualenv Git # Install homebrew ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\" # Install Python 3.7 brew install python # Upgrade to Python 3.7 brew upgrade python # Check Python 3.7 is installed, should return 'Python 3.7.1' or 'Python 3.7.2' python3 --version # install virtualenv if necessary pip3 install virtualenv # Install git if necessary brew install git Clone the repository git clone https://github.com/cudmore/pie-analysis.git Run the provided installer cd pie-analysis/video-play ./install-player You should now be able to run the video-player with python src/VideoApp.py If that does not work, create your own virtual environment and run from there. # Create a Python 3 virtual environment in 'player_env'. cd ~/pie-analysis/video-player mkdir player_env virtualenv -p python3 --no-site-packages player_env # activate the virtual environment # Once activated, command line should begin with '(player_env)' source player_env/bin/activate # install with pip pip install -r requirements.txt # finally, run the player with python3 src/player.py","title":"Video Annotate"},{"location":"video-annotate/#install","text":"Clone the source git clone https://github.com/cudmore/pie-analysis.git Make a Python virtual environment python -m venv video-annotate source video-annotate/bin/activate Install the video-player requirements cd video-player pip install -r requirements.txt Run desktop GUI of video player python src/VideoApp.py","title":"Install"},{"location":"video-annotate/#directions-for-using-videoannotate-for-behavior-scoring","text":"Open VideoAnnotate and under File, select the folder with the video files to be analyzed. Click \u201cgenerate chunks\u201d. Change the piece duration (if chunks need to be selected evenly across the video file), duration of the chunks, and number of chunks per file. Navigate to the folder on the hard drive, duplicate the chunks file and name the copy \u201crandomChunks.txt\u201d Quit VideoAnnotate and relaunch the application. Select the relevant folder of videos and under the Window menu, see that \u201cBlind Interface\u201d is selected. The chunks will appear starting at 0/1234 (1234 will be the total number of chunks across the entire folder you selected). Use the space bar to play the chunk #0, and at the occurrence of a behavior of interest, press the computer key 1-9 corresponding to the specific behavior being scored. Click the arrow for Next Chunk and continue doing so until scoring is complete. If duration of behaviors is needed, click the number corresponding to the specific behavior and use the \u201cf\u201d and \u201cl\u201d keys to set the duration of the first and last frames during which the behavior occurs. When scoring is complete, VideoAnnotate will have written csv files into the folder containing the video files. Each csv can be read into excel, R, MatLab, or whatever the user\u2019s choice of analysis software may be.","title":"Directions for Using VideoAnnotate for Behavior Scoring"},{"location":"video-annotate/#keyboard-commands","text":"Controlling video Keyboard Action space play/pause left-arrow Move backwards in video rigth-arrow Move forwards in video shift + left arrow Larger move backward in video shift + right arrow Larger move forward in video + Play video faster - Play video slower Editing events Keyboard Action 1..9 Create new event at current frame f Set first frame of selected event l Set last frame of selected event n Set note of current selected event Chunks Keyboard Action [ Previous Chunk ] Next Chunk There are currently 9 event types corresponding to keyboard 1, 2, 3, 4, 5, 6, 7, 8, 9.","title":"Keyboard commands"},{"location":"video-annotate/#menus","text":"File Open Folder... - Open a folder of video files. Video files must be mp4. Open Random Chunks... - Open a random chunks file. See Blind scoring . Save Options - Save options to a file. Options will be reloaded next time program runs. See Options file . Quit - Quit the video player. Options are automatically saved before quit. Window Toggle interface on/off for: video files, events, video feedback, and chunks.","title":"Menus"},{"location":"video-annotate/#saving-events","text":"All events are automatically saved in a text file (.txt) with the same base name as the video file. One events .txt file per video file. The events file is saved when new events are created or edited (first/last frame, note, file video note). First line in events file is comma separated list of name=value pairs describing the associated video. Second line is column headers. Remaining lines in file are event with one event per line. For example, an events file with three events would look like this: # path=/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,fileName=1-homecage-movie.mp4,width=640.0,height=480.0,aspectRatio=0.75,fps=15.0,numFrames=4500,numSeconds=300.0,numEvents=22,videoFileNote=, index,path,cSeconds,cDate,cTime,typeNum,typeStr,frameStart,frameStop,numFrames,sStart,sStop,numSeconds,chunkIndex,note, 0,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552305.756366,2018-11-29,23:31:45,1,a,2468,,None,164.53,None,None,4,,, 1,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552306.0374012,2018-11-29,23:31:46,2,b,2468,,None,164.53,None,None,4,,, 2,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552306.435797,2018-11-29,23:31:46,3,c,2473,,None,164.87,None,None,4,,, 3,/Users/cudmore/Dropbox/PiE/video/1-homecage-movie.mp4,1543552306.8971589,2018-11-29,23:31:46,4,d,2479,,None,165.27,None,None,4,,,","title":"Saving events"},{"location":"video-annotate/#analysis","text":"","title":"Analysis"},{"location":"video-annotate/#event-analysis","text":"See Analysis/eventAnalysis . For each file, sum duration (sec) of each event type (1..9) flag events that have start/stop frame out of order flag events that overlap with previous event (if previous has duration) flag events outside of a chunk","title":"Event Analysis"},{"location":"video-annotate/#blinding-analysis","text":"Make plot of chunks with each file in a list of files. See Analysis/chunkAnalysis .","title":"Blinding analysis"},{"location":"video-annotate/#blind-scoring","text":"Button Action < Go to previous chunk (keyboard '[') |< Go to start of current chunk > Go to next chunk (keyboard ']') Go To Go to chunk number specified in the edit/spin box. Limit Video Controls Limit the video frame slider and all video controls (including keyboard) to stay within the current chunk. In addition, when checked, the event list will only show events within the current chunk. Blind scoring is done with a user created 'chunks' file. Once created, blinding is achieved by stepping through a number of (random) video chunks of a specified length. Use the following code to generate a chunks file for a folder of video files. Once created, rename the output file to 'randomChunks.txt' and it will automatically be loaded when the folder of video is loaded into the video-player. # full path to your video folder path = '/Users/cudmore/Dropbox/PiE/video' chunks = bChunk(path) pieceDurationSeconds = 10 * 60 # seconds chunkDurationSeconds = 10 # seconds chunksPerFile = 30 outFile = chunks.generate(pieceDurationSeconds, chunkDurationSeconds, chunksPerFile) Blinding Algorithm video file duration (30 min) pieceDur (10 min) gives us numPieces = dur / pieceDur totalNumChunks (30) is total number of chunks for one video chunkDur (10 sec) is duration of each chunk split video into a large number of chunks numChunks = (dur/chunkDur) partition video into a number of 'pieces' numPieces = (dur/pieceDur) chunksPerPiece = totalNumChunks/numPieces for each 'piece', randomly choose chunksPerPiece without replacement. Can do this by stepping through all chunks and only considering chunks with a piece using chunksPerPiece. Here is an example of the results of the blinding algorithm for 6 video files, 30 chunks each. Each colored symbol is a different random chunk (duration 10 sec) and the color scale shows the order the chunks are visited. There are 180 chunks spread across the 6 files. Blinding file format params: dict of parameters used to generate random chunks chunkDurationSeconds: chunksPerFile: pieceDurationSeconds: generated: chunkOrder: integer list of random chunk order chunks: dict list of chunks chunks { \"index\": 0, \"numFrames\": 299, \"path\": \"/Users/cudmore/Dropbox/PiE/scrambled/s_1831.mp4\", \"piece\": 0, \"randomIndex\": 55, \"startFrame\": 5083, \"stopFrame\": 5381 }, { \"index\": 1, \"numFrames\": 299, \"path\": \"/Users/cudmore/Dropbox/PiE/scrambled/s_1831.mp4\", \"piece\": 0, \"randomIndex\": 29, \"startFrame\": 11362, \"stopFrame\": 11660 }, { \"index\": 2, \"numFrames\": 299, \"path\": \"/Users/cudmore/Dropbox/PiE/scrambled/s_1831.mp4\", \"piece\": 0, \"randomIndex\": 16, \"startFrame\": 13156, \"stopFrame\": 13454 },","title":"Blind Scoring"},{"location":"video-annotate/#options-file","text":"Interface options can be saved with menu 'File - Save Options'. Options are also saved each time the program is quit with 'File - Quit'. The options are saved in a json file 'options.json' and can be manually edited. By manually editing the 'options.json' file, mappings between event numbers 1..9 and names can be specified. In addition, the duration the video is advanced/reversed with either the keyboard or video control buttons can be set with 'smallSecondsStep' and 'largeSecondsStep'. { \"appWindowGeometry\": \"1035x698\", \"eventTypes\": { \"1\": \"a\", \"2\": \"b\", \"3\": \"c\", \"4\": \"d\", \"5\": \"e\", \"6\": \"f\", \"7\": \"g\", \"8\": \"h\", \"9\": \"i\" }, \"fpsIncrement\": 5, \"smallSecondsStep\": 10, \"largeSecondsStep\": 60, \"showVideoFiles\": true, \"showEvents\": true, \"showRandomChunks\": true, \"showVideoFeedback\": true, \"videoFileSash\": 200, \"eventSash\": 400, \"lastPath\": \"/Users/cudmore/Dropbox/PiE/video\" }","title":"Options file"},{"location":"video-annotate/#known-bugs","text":"[fixed] Has some problems when it reaches end of file. [fixed] Resizing window will sometimes cause a crash. Check that avconv (used by PiE server on Pi) always generates valid mp4 files. See here . In at least one file, getting errors like 'Invalid NAL unit size' and 'Error splitting the input into NAL'. Maybe save original .h264 on Pi so we can convert later if neccessary.","title":"Known bugs"},{"location":"video-annotate/#to-do-important","text":"Add keys to set event 1..9 to preferences [done] Implement single menu to turn blinding on/off [bug] turning blinding on, the video stream is not paused??? scrolling up/down with arrow keys through video file list is NOT updating to next video. Clicking in list DOES work. When starting app and chunk file is loaded, make sure we are in chunk 0. When user first clicks 'limit', we need to be in a chunk!!! Clicking on a chunk (gray bar) should select chunk (in chunk view). Selecting event in event list should highlight event in event canvas. Streamline interface for blinding. Make a system where when handed to a scorer, they can not activate non-blinded interface (they are locked into blinding). Try and add a password to switch between one and the other. Update numEvents in video list as we add/delete events Make menu interface to create random chunks file from folder. So we can do it in stand-alone app Add dIndex to events so we can always show events in list with 'index' column as 1,2,3,... When editing chunks, do not allow video list selection Recalculate chunkIndex when setting event startFrame with keyboard 'f'. [hard] switch event list interface when editing chunks. Show frame start/stop relative to start of current chunk","title":"To Do (important)"},{"location":"video-annotate/#to-do","text":"[done?] Fix chunk interface, it is remembering pointers to old chunk file Implement options dialog to set small/big keyboard steps (Seconds) Finish 'about dialog' Make fps a spin box to easily increase/descrease. [solved] Highlight most recent event in list as video is played. Need to sort by startFrame. [solved] Add option to warn when event frame start/stop is out of order, e.g. frameStart>frameStop. Add note to video file by putting it in event list header. Finish 'right-click' popup menu in video list. [bug] Make sure toggle of video file and event list do not trash interface on next run. Need to add code to HIDE video and event list, currently setting sashpos==0 (remove this). [bug] When increasing/decreasing fps with +/-, sometimes can not get back to orignal fps. Fix this. This is now fixed but minimum fps is no longer 1 fps. [big idea - done] Make a visual bar for each video file showing: duration (black) overlaid .with position of chunks (gray), and position of events (bright colors).","title":"To Do"},{"location":"video-annotate/#to-do-done","text":"[done] In event tree, select and go to next event when event is deleted (if next event exists) [done] Add option to turn off delete event warning [done] Implement second layer of blinding with 'parts' to evenly distribute random chunks through file [done] Finish sorting event columns when clicked. Need to insert str(), int(), float() to do this. [done] Just always sort events by frameStart. [done] Implement 'delete event'. Add dialog to ask if ok. [done] Sort events after setting first frame [done] Add differnet small/big step for chunk edit [done] Standardize chunk index. I am showing random index in chunk interface but absolute chunk index in event list. Now building standalone app with pyinstaller Added video edit icon [hopefully done, bug] Make sure chunk navigation is working: >, <, go to. [hopefully done, bug] frame slider gets corrupted and does not move during chunk editing [hopefully done, bug] Make sure video controls (buttons and keyboard) stay within chunk when 'Limit Controls' is on. [done] Need some way to 1) categorize/file each event into its chunk 2) detect events falling outside a chunk. [done] During chunk editing, hijack ALL video controls (frame slider, play, >, >>, <, <<) to only allow scrolling through frames in current chunk. [done] Add checkbox to activate/inactivate chunk editing. [done] Running video faster/slower using +/- increments frame interval, it should increment frames per second (+/- 5 fps). Maximum fps for tkinter seems to be ~90 fps. [done] Implement saving/loading options via JSON file. Include window geometry, show/hide, (MAYBE) mapping of event numbers to names. [done] Toggle 'play' button to reflect state e.g. play and pause. [done] Add option to hide video controls like we hide video file list and event list. [done] Add information about video file to saved event list .txt file, e.g. (path=xxx, numframes=yyy, fps=zzz). [done] Expand code to open a folder of video files. Right now it is one hard-coded video file. [done] Add standard video control buttons like play/pause/forward/backward/large-forward/large-backward. [done] Finish setting event notes with keyboard 'n'. [done] Write recipe for installation into Python virtual environment. [done] Design system where events can have start/stop frames or start frame and number of frames (duration). Right now events only have single (start) frame.","title":"To Do (done)"},{"location":"video-annotate/#troubleshooting","text":"","title":"Troubleshooting"},{"location":"video-annotate/#standalone-app","text":"Right-click the .app and select 'Show Package Contents' Run the app directly by double-clicking 'Contents - macOS - VideoAnnotate'. This will run the app with a text console showing feedback on the state of the program. If there are errors, they will appear in the text console.","title":"Standalone app"},{"location":"video-annotate/#running-from-source","text":"If there are errors when running, check the versions. The video-player requires: Python 3.7 (includes tkinter 8.x) numpy opencv 3 Pillow Check Python version with 'python --version'. Check Python libraries with 'pip3 freeze'. numpy==1.15.4 Pillow==5.3.0 If having problems with opencv, try both installing into Python 'pip3 install opencv-python' and/or installing with brew with 'brew install opencv3 --with-python3'. The opencv version should be 'opencv-python==3.4.3.18' or newer.","title":"Running from source"},{"location":"video-annotate/#old-install","text":"","title":"old - Install"},{"location":"video-annotate/#old-install-using-install-player-script","text":"This install recipe assumes you have Python 3.7, pip, virtualenv, homebrew, and git installed on your computer. If you do not have these things or have no idea what we are talking about, then please see the Install - Step By Step section below. Clone repository cd ~ git clone https://github.com/cudmore/pie-analysis.git Install video-player cd pie-analysis/video-player ./install-player Run cd pie-analysis/video-player ./player","title":"old - Install - Using 'install-player' script"},{"location":"video-annotate/#old-install-using-requirements-file","text":"Requires Python 3.7, Open CV 3, Pillow (PIL), Numpy git clone https://github.com/cudmore/pie-analysis.git cd pie-analysis/video-player mkdir player_env virtualenv -p python3 --no-site-packages player_env source player_env/bin/activate pip install -r requirements.txt # run the player cd src python3 VideoApp.py","title":"old - Install - Using requirements file"},{"location":"video-annotate/#old-install-step-by-step","text":"You will install the following Homebrew Python 3.7 Virtualenv Git # Install homebrew ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\" # Install Python 3.7 brew install python # Upgrade to Python 3.7 brew upgrade python # Check Python 3.7 is installed, should return 'Python 3.7.1' or 'Python 3.7.2' python3 --version # install virtualenv if necessary pip3 install virtualenv # Install git if necessary brew install git Clone the repository git clone https://github.com/cudmore/pie-analysis.git Run the provided installer cd pie-analysis/video-play ./install-player You should now be able to run the video-player with python src/VideoApp.py If that does not work, create your own virtual environment and run from there. # Create a Python 3 virtual environment in 'player_env'. cd ~/pie-analysis/video-player mkdir player_env virtualenv -p python3 --no-site-packages player_env # activate the virtual environment # Once activated, command line should begin with '(player_env)' source player_env/bin/activate # install with pip pip install -r requirements.txt # finally, run the player with python3 src/player.py","title":"old - Install - Step By Step"},{"location":"web-interface/","text":"When the PiE sever is running, the web interface is accesible at http:/[IP]:5010 where [IP] is the IP address of the Pi. The top row displays the Pi hostname, IP, and current date and time. When the PiE server is running, the time will be updated each second. In addition, there are links to recorded video files, PiE server logs, environmental sensors, and the full source code and documentation on Github. The 'Start Recording' and 'Start Trial' buttons start video recording to a file. All files are saved in the /video folder. At the end of each video file recording, a trial file is also saved. Trial files are plain text files with a record of 'events' that occurred during the video recording. See the trial file readme for more information. White and IR Switches . Will turn White and IR lights on and off. This assumes white and IR leds for the PiE server have been wired correctly to the Raspberry Pi. Both white and IR LEDs cannot be controlled when 'Configure - Auto Lights' is on. ID and Condition . These will be pre-pended to all saved file names. Leave them blank and nothing will be added. This is useful to organize your saved files with an animal ID and condition. Start Recording . Will start a video recording following 'Repeat Forever', 'Number of Repeats' and 'Repeat Duration'. These parameters can be set and saved in the Configure section. Start Streaming . Will start streaming the camera to the web page. If the stream fails to start the first time, try turning it off and then on again. If it still does not work, refresh the page in the browser. Arm . When checked, the PiE server will wait for an input trigger to start video recording. Arming is only available when 'Configure - Allow Arming' is on. Turning 'Arm' on will force 'Repeat Forever' off and 'Number of Repeats' to 1. When 'Arm' is on and an input trigger is received, video recording begins and a pre-trigger video recording will be saved. The duration of the pre-trigger video is set in 'Configure - Pre Trigger Buffer (sec)'. Last Action . Is updated with the last action the PiE server took. This is normally updated in response to clicking interface buttons. Configure The Configure section allows parameters of the PiE server to be set. Current parameters can be saved with 'Save Defaults' and will automatically be loaded the next time the PiE server is run. Make sure you save your changes with 'Save Defaults'. Repeat Forever . When checked, 'Start Recording' will record videos of 'Repeat Duration' over and over until 'Stop Recording' is pressed. When 'Arm' is on, this will be turned off. Number of Repeats . The number of video files to record when 'Start Recording' is pressed. Each video file will have a duration set by 'Repeat Duration Sec)'. When 'Arm' is on, this will be set to 1. Repeat Duration (sec) . The length of each video file in seconds. Auto Lights . When checked, the White and IR lights will be turned on and off to simulate daytime and nighttime. The white light will be on between sunrise and sunset, the IR light will be on otherwise. Sunrise (hour) and Sunset (hour) . When 'Auto Lights' is on, the White and IR lights will be turned on and off to simulate daytime and nighttime. FPS . Specifies the frames-per-second (FPS) or recorded video. Minimum is 1 and maximum is 90. Resolution . Specifies the resolution of recorded video. Stream Resolution . Specifies the resolution of streaming video. Capture Still and Still Interval (Sec) . If on, still images will be captured at 'Still Interval (Sec)'. These still images can be viewed in real-time in the 'Last Still Image' section. Pre Trigger Buffer (sec) . Used for 'Armed' recording. Specifies the duration of video recording before an input trigger. Video Annotation and Annotation Font Size . Annotate text on top of video recording. Select one of: none, date, time, date time, elapsed, or video frame. Include Hostname . If checked, the hostname will be pre-pended to each saved video file. Trial Number . Allows the trial number to be manually set. The trial number is always automatically incremented each time 'Start Recording' or 'Start Trial' are initiated. Allow Arming . If on, will activate the 'Arm' interface. This assumes the PiE server has been wired to a 'trigger in' and optionally a microscope 'frame clock'. Use Serial . If on, will activate the 'Motor' interface. This assumes a Teensy microcontroller is attached via usb. Load . Buttons to load presets of configuration parameters. This includes 'Defaults', the last configuration saved with 'Save Defaults' as well as pre-defined configuration parameters. It is easy to set your own configuration parameters and use 'Save Defaults' exclusively. Defaults . Load the last configuration saved with 'Save Defaults'. These are also loaded when the PiE server is first run. Homecage . Auto lights on, arm off, serial off. Scope . Arm on, serial off. Treadmill . Arm on, serial on. User . Only for advanced users. User specified configuration file. Factory Defaults . Reset the PiE server to its factory default configuration. Pins The Pins section allows GPIO pin parameters to be specified. All parameters in the 'Pins' section will be save with ' Configure - Save Defaults '. Each pin can be independenlty enabled/disabled, please disable pins you are not using. Input Pins . The triggerIn and frame pins are used during armed recording and their parameters need to be set to match the signals coming off your particular hardware/scope. For example, if your scope outputs a rising trigger then triggerIn should be set to Polarity rising and Pull Up/Down to down . Output Pins . The triggerOut pin is set at the start of armed recording and can be used to trigger external devices when the PiE server is used as a slave. The whiteLED and irLED pins are turned on/off when the white and IR toggles switches are set in the main web interface. To change 'Pin' numbers, the configuration json files need to be manually edited. These can be found in pie_app/config folder. DHT Temperature/Humidity . This assumes you have installed the Adafruit DHT temperature sensor driver with ./install-dht . If 'enabled' is checked, temperature and humidity will be logged to a trial file during video recording at the specified 'interval (sec)'. If 'continuous' is checked, temperature and humidity readings will still be looged to a trial file during video recording but will also be continuosly logged at the specified 'interval (sec)' wether video is recording or not. The continuous log can be accessed on a separate page, named environment, using the thermometer icon. The temperature and humidity log file is in video/logs/environment.log . If you change these options and they do not take effect, try restarting the PiE server in the web interface 'Debug' section. Motor The Motor section allows parameters to be uploaded to a Teensy microcontroller. This is only for advanced users. Activate this section by turning on 'Configure - Use Serial'. Debug This section reports all parameters received from the PiE server. Use 'Restart Pie Server' to restart the PiE server. Note, this restarts the PiE server software, it does not reboot the machine.","title":"Web Interface"},{"location":"web-interface/#configure","text":"The Configure section allows parameters of the PiE server to be set. Current parameters can be saved with 'Save Defaults' and will automatically be loaded the next time the PiE server is run. Make sure you save your changes with 'Save Defaults'. Repeat Forever . When checked, 'Start Recording' will record videos of 'Repeat Duration' over and over until 'Stop Recording' is pressed. When 'Arm' is on, this will be turned off. Number of Repeats . The number of video files to record when 'Start Recording' is pressed. Each video file will have a duration set by 'Repeat Duration Sec)'. When 'Arm' is on, this will be set to 1. Repeat Duration (sec) . The length of each video file in seconds. Auto Lights . When checked, the White and IR lights will be turned on and off to simulate daytime and nighttime. The white light will be on between sunrise and sunset, the IR light will be on otherwise. Sunrise (hour) and Sunset (hour) . When 'Auto Lights' is on, the White and IR lights will be turned on and off to simulate daytime and nighttime. FPS . Specifies the frames-per-second (FPS) or recorded video. Minimum is 1 and maximum is 90. Resolution . Specifies the resolution of recorded video. Stream Resolution . Specifies the resolution of streaming video. Capture Still and Still Interval (Sec) . If on, still images will be captured at 'Still Interval (Sec)'. These still images can be viewed in real-time in the 'Last Still Image' section. Pre Trigger Buffer (sec) . Used for 'Armed' recording. Specifies the duration of video recording before an input trigger. Video Annotation and Annotation Font Size . Annotate text on top of video recording. Select one of: none, date, time, date time, elapsed, or video frame. Include Hostname . If checked, the hostname will be pre-pended to each saved video file. Trial Number . Allows the trial number to be manually set. The trial number is always automatically incremented each time 'Start Recording' or 'Start Trial' are initiated. Allow Arming . If on, will activate the 'Arm' interface. This assumes the PiE server has been wired to a 'trigger in' and optionally a microscope 'frame clock'. Use Serial . If on, will activate the 'Motor' interface. This assumes a Teensy microcontroller is attached via usb. Load . Buttons to load presets of configuration parameters. This includes 'Defaults', the last configuration saved with 'Save Defaults' as well as pre-defined configuration parameters. It is easy to set your own configuration parameters and use 'Save Defaults' exclusively. Defaults . Load the last configuration saved with 'Save Defaults'. These are also loaded when the PiE server is first run. Homecage . Auto lights on, arm off, serial off. Scope . Arm on, serial off. Treadmill . Arm on, serial on. User . Only for advanced users. User specified configuration file. Factory Defaults . Reset the PiE server to its factory default configuration.","title":"Configure"},{"location":"web-interface/#pins","text":"The Pins section allows GPIO pin parameters to be specified. All parameters in the 'Pins' section will be save with ' Configure - Save Defaults '. Each pin can be independenlty enabled/disabled, please disable pins you are not using. Input Pins . The triggerIn and frame pins are used during armed recording and their parameters need to be set to match the signals coming off your particular hardware/scope. For example, if your scope outputs a rising trigger then triggerIn should be set to Polarity rising and Pull Up/Down to down . Output Pins . The triggerOut pin is set at the start of armed recording and can be used to trigger external devices when the PiE server is used as a slave. The whiteLED and irLED pins are turned on/off when the white and IR toggles switches are set in the main web interface. To change 'Pin' numbers, the configuration json files need to be manually edited. These can be found in pie_app/config folder. DHT Temperature/Humidity . This assumes you have installed the Adafruit DHT temperature sensor driver with ./install-dht . If 'enabled' is checked, temperature and humidity will be logged to a trial file during video recording at the specified 'interval (sec)'. If 'continuous' is checked, temperature and humidity readings will still be looged to a trial file during video recording but will also be continuosly logged at the specified 'interval (sec)' wether video is recording or not. The continuous log can be accessed on a separate page, named environment, using the thermometer icon. The temperature and humidity log file is in video/logs/environment.log . If you change these options and they do not take effect, try restarting the PiE server in the web interface 'Debug' section.","title":"Pins"},{"location":"web-interface/#motor","text":"The Motor section allows parameters to be uploaded to a Teensy microcontroller. This is only for advanced users. Activate this section by turning on 'Configure - Use Serial'.","title":"Motor"},{"location":"web-interface/#debug","text":"This section reports all parameters received from the PiE server. Use 'Restart Pie Server' to restart the PiE server. Note, this restarts the PiE server software, it does not reboot the machine.","title":"Debug"},{"location":"wiring-behavior-box/","text":"Wiring a behavior box Wiring a behavior box is fairly simple. The Pi needs to be wired to one end of a relay/switch, the other end of the relay/switch is wired to 12V DC, IR and white LEDs, and the fan. Finally the temperature/humidity sensor is wired to the Pi. Full Wiring Schematic PiE hardware overview for a single behavior box Starting with the network connection, the Raspberry Pi receives commands and sends data through the ethernet cable. It sends and receives data from the temperature/humidity sensor (DHT) and the video camera (teal outlined boxes). It sends data to the quad channel relay, which turns power on or off to the white lights, infrared lights, and fan. Wire colors used for temperature/humidity sensor and quad channel relay are consistent with the Wiring Table. Plug in locations for each wire on the quad channel relay can be used as a reference. Wiring table The Raspberry Pi diagram (top, right) shows a map to every pin on the Raspberry Pi, to differentiate signal pins, power pins, and ground pins. Temperature/Humidity Sensor Wiring table (bottom left), colors match the color of the wires as depicted in the hardware overview, and on the physical DHT sensor on the purchase list. Quad channel relay shield wiring table (bottom right), wire colors match the colors used in the hardware overview. Behavior Box Schematic Schematic showing an overview of a single behavior box with sensors and actuators in place within the box. Raspberry Pi 2/3 pin out There are multiple power and ground pins, use these to connect to the relay switch and the temperature sensor. Conceptually, all the ground pins are the same, you can use a bread-board if you run out of ground pins or the wiring becomes too tangled. Wiring the camera The Raspberry Pi NoIR camera (and the normal Pi camera ) is connected to the Pi with a flat [ribbon cable][flat-camera-cable]. The length should not exceed 2 meters. The cable should have one side with a blue tab (one on each end). When connecting the cable to the camera and the Pi, the direction of the blue tab matters. If it is backwards, the camera will not function. The blue side of the cable must go towards the back of the camera. The blue side of the cable must go towards the ethernet and USB ports. Finally, the camera must be activated from the command line using sudo raspi-config and choosing '5 Interface Options' then 'P1 Camera' and answering 'Yes'. Wiring diagram Lights Use an external 12V AC/DC power supply. - Don't power the lights directly from the 5V pins on the Pi, the Pi does not have enough current. A >1 Amp 12V adapter should be fine. Don't worry, if it is under-powered, the LED lights will be a little dim. Use a relay switch. - Never connect the 12V adapter directly to the Pi, instead use a relay switch. Only work with DC current coming out of the AC/DC adapter, DO NOT work with AC power coming from the wall as it can kill you. The relay switch effectively separates the 5V, Ground, and GPIO on the Pi (left half of the relay) from the 12V power of the AC/DC adapter and the lights (right half of the relay). Here we will wire the system with the white LED on channel 1 and the IR LED on channel 2 of the relay switch. All LEDs need resistors. - All LEDs need a resistor, these are called 'current limiting resistor'. If you directly connect an LED to power and ground without a resistor, you will burn the LED. The value of the resistor (in Ohms) needs to be calculated using Ohms law , V=I*R. Where: V (Volts) is determined by the power source I (Amps) depends on the properties of each LED and if they are wired in series or in parallel R (Ohms) is what needs to be calculated. Follow this tutorial to get started calculating the required resistor value. Use IR LEDs <900 nm. - These are within the sensitivity range of the Pi NoIR camera. A lot of IR LEDs are 940nm, these are not well suited for use with the Pi NoIR camera but are designed for IR sensors as is used in a TV remote. Wiring the lights Connect a 12V AC/DC adapter, IR, and white lights to the two-channel relay switch. Using a 12V AC/DC adapter (>1 Amp), cut the wire and stick the positive 'hot' wire into the center 'common' pin' of channel 1 on the relay switch. The 'hot' end wire usually has a white line down the length of the wire. You can also determine the 'hot' end using a multi-meter, it is the one that gives a positive (+) voltage when attached to the positive (normally red) end of the multi-meter. Cut a bit of wire and connect the center 'common pin' of channel 1 to the center 'common pin' of channel 2. This is the 'hot' end. Stick the positive end of the white LED into the 'normally closed' port of channel 1. Attach the negative end of the white LED to the 'ground' wire of the 12V AC/DC adapter. Remember, all LEDs need resistors! Do the same for the IR LED. Stick the positive end into the 'normally closed' port of channel 2 on the relay switch. Attach the negative end of the IR LED to the 'ground' wire of the 12V AC/DC adapter. Remember, all LEDs need resistors! Tie the three grounds together, this includes the ground from the 12V AC/DC adapter, the white LEDs and the IR LEDs. Connect the Pi to the relay switch switch Connect 4 wires from the Pi to the relay switch. All these wires go on the opposite end from the 12V wires. Look at your relay switch for the correct connects, they are usually clearly labelled but can be in a different order from the image shown. Connect a GPIO pin from the Pi to the 'In1=Digital Input' pin on the relay switch. Connect a second GPIO pin from the Pi to the 'In2=Digital Input' pin on the relay switch. Connect a 5V pin from the Pi to the 'Vcc' pin on the relay switch. Connect a ground pin from the Pi to the 'GND' pin on the relay switch. Wiring a temperature and humidity sensor The PiE server can log temperature and humidity using the DHT line of temperature sensors. To use these sensors, the Adafruit Python sensor library needs to to be installed. cd ~/pie ./install-dht There are additional troubleshooting tips in the pie/testing/ folder. AM2302 Red is power, black is ground, and yellow is data. Connect a 5V pin from the Pi to the red wire on the sensor. Connect a ground pin from the Pi to the back wire on the sensor. Connect a GPIO pin from the Pi to the yellow (data) pin on the sensor. DHT22 Connect a 5V pin from the Pi to the 'VCC' pin on the sensor. Connect a ground pin from the Pi to the 'GND' pin on the sensor. Connect a GPIO pin from the Pi to the 'DATA' pin on the sensor.","title":"Behavior Box"},{"location":"wiring-behavior-box/#wiring-a-behavior-box","text":"Wiring a behavior box is fairly simple. The Pi needs to be wired to one end of a relay/switch, the other end of the relay/switch is wired to 12V DC, IR and white LEDs, and the fan. Finally the temperature/humidity sensor is wired to the Pi.","title":"Wiring a behavior box"},{"location":"wiring-behavior-box/#full-wiring-schematic","text":"","title":"Full Wiring Schematic"},{"location":"wiring-behavior-box/#pie-hardware-overview-for-a-single-behavior-box","text":"Starting with the network connection, the Raspberry Pi receives commands and sends data through the ethernet cable. It sends and receives data from the temperature/humidity sensor (DHT) and the video camera (teal outlined boxes). It sends data to the quad channel relay, which turns power on or off to the white lights, infrared lights, and fan. Wire colors used for temperature/humidity sensor and quad channel relay are consistent with the Wiring Table. Plug in locations for each wire on the quad channel relay can be used as a reference.","title":"PiE hardware overview for a single behavior box"},{"location":"wiring-behavior-box/#wiring-table","text":"The Raspberry Pi diagram (top, right) shows a map to every pin on the Raspberry Pi, to differentiate signal pins, power pins, and ground pins. Temperature/Humidity Sensor Wiring table (bottom left), colors match the color of the wires as depicted in the hardware overview, and on the physical DHT sensor on the purchase list. Quad channel relay shield wiring table (bottom right), wire colors match the colors used in the hardware overview.","title":"Wiring table"},{"location":"wiring-behavior-box/#behavior-box-schematic","text":"Schematic showing an overview of a single behavior box with sensors and actuators in place within the box.","title":"Behavior Box Schematic"},{"location":"wiring-behavior-box/#raspberry-pi-23-pin-out","text":"There are multiple power and ground pins, use these to connect to the relay switch and the temperature sensor. Conceptually, all the ground pins are the same, you can use a bread-board if you run out of ground pins or the wiring becomes too tangled.","title":"Raspberry Pi 2/3 pin out"},{"location":"wiring-behavior-box/#wiring-the-camera","text":"The Raspberry Pi NoIR camera (and the normal Pi camera ) is connected to the Pi with a flat [ribbon cable][flat-camera-cable]. The length should not exceed 2 meters. The cable should have one side with a blue tab (one on each end). When connecting the cable to the camera and the Pi, the direction of the blue tab matters. If it is backwards, the camera will not function. The blue side of the cable must go towards the back of the camera. The blue side of the cable must go towards the ethernet and USB ports. Finally, the camera must be activated from the command line using sudo raspi-config and choosing '5 Interface Options' then 'P1 Camera' and answering 'Yes'.","title":"Wiring the camera"},{"location":"wiring-behavior-box/#wiring-diagram","text":"","title":"Wiring diagram"},{"location":"wiring-behavior-box/#lights","text":"Use an external 12V AC/DC power supply. - Don't power the lights directly from the 5V pins on the Pi, the Pi does not have enough current. A >1 Amp 12V adapter should be fine. Don't worry, if it is under-powered, the LED lights will be a little dim. Use a relay switch. - Never connect the 12V adapter directly to the Pi, instead use a relay switch. Only work with DC current coming out of the AC/DC adapter, DO NOT work with AC power coming from the wall as it can kill you. The relay switch effectively separates the 5V, Ground, and GPIO on the Pi (left half of the relay) from the 12V power of the AC/DC adapter and the lights (right half of the relay). Here we will wire the system with the white LED on channel 1 and the IR LED on channel 2 of the relay switch. All LEDs need resistors. - All LEDs need a resistor, these are called 'current limiting resistor'. If you directly connect an LED to power and ground without a resistor, you will burn the LED. The value of the resistor (in Ohms) needs to be calculated using Ohms law , V=I*R. Where: V (Volts) is determined by the power source I (Amps) depends on the properties of each LED and if they are wired in series or in parallel R (Ohms) is what needs to be calculated. Follow this tutorial to get started calculating the required resistor value. Use IR LEDs <900 nm. - These are within the sensitivity range of the Pi NoIR camera. A lot of IR LEDs are 940nm, these are not well suited for use with the Pi NoIR camera but are designed for IR sensors as is used in a TV remote.","title":"Lights"},{"location":"wiring-behavior-box/#wiring-the-lights","text":"","title":"Wiring the lights"},{"location":"wiring-behavior-box/#connect-a-12v-acdc-adapter-ir-and-white-lights-to-the-two-channel-relay-switch","text":"Using a 12V AC/DC adapter (>1 Amp), cut the wire and stick the positive 'hot' wire into the center 'common' pin' of channel 1 on the relay switch. The 'hot' end wire usually has a white line down the length of the wire. You can also determine the 'hot' end using a multi-meter, it is the one that gives a positive (+) voltage when attached to the positive (normally red) end of the multi-meter. Cut a bit of wire and connect the center 'common pin' of channel 1 to the center 'common pin' of channel 2. This is the 'hot' end. Stick the positive end of the white LED into the 'normally closed' port of channel 1. Attach the negative end of the white LED to the 'ground' wire of the 12V AC/DC adapter. Remember, all LEDs need resistors! Do the same for the IR LED. Stick the positive end into the 'normally closed' port of channel 2 on the relay switch. Attach the negative end of the IR LED to the 'ground' wire of the 12V AC/DC adapter. Remember, all LEDs need resistors! Tie the three grounds together, this includes the ground from the 12V AC/DC adapter, the white LEDs and the IR LEDs.","title":"Connect a 12V AC/DC adapter, IR, and white lights to the two-channel relay switch."},{"location":"wiring-behavior-box/#connect-the-pi-to-the-relay-switch-switch","text":"Connect 4 wires from the Pi to the relay switch. All these wires go on the opposite end from the 12V wires. Look at your relay switch for the correct connects, they are usually clearly labelled but can be in a different order from the image shown. Connect a GPIO pin from the Pi to the 'In1=Digital Input' pin on the relay switch. Connect a second GPIO pin from the Pi to the 'In2=Digital Input' pin on the relay switch. Connect a 5V pin from the Pi to the 'Vcc' pin on the relay switch. Connect a ground pin from the Pi to the 'GND' pin on the relay switch.","title":"Connect the Pi to the relay switch switch"},{"location":"wiring-behavior-box/#wiring-a-temperature-and-humidity-sensor","text":"The PiE server can log temperature and humidity using the DHT line of temperature sensors. To use these sensors, the Adafruit Python sensor library needs to to be installed. cd ~/pie ./install-dht There are additional troubleshooting tips in the pie/testing/ folder.","title":"Wiring a temperature and humidity sensor"},{"location":"wiring-behavior-box/#am2302","text":"Red is power, black is ground, and yellow is data. Connect a 5V pin from the Pi to the red wire on the sensor. Connect a ground pin from the Pi to the back wire on the sensor. Connect a GPIO pin from the Pi to the yellow (data) pin on the sensor.","title":"AM2302"},{"location":"wiring-behavior-box/#dht22","text":"Connect a 5V pin from the Pi to the 'VCC' pin on the sensor. Connect a ground pin from the Pi to the 'GND' pin on the sensor. Connect a GPIO pin from the Pi to the 'DATA' pin on the sensor.","title":"DHT22"},{"location":"wiring-scope/","text":"Wiring a scope This is a tutorial for wiring tactile-push-buttons to trigger a frame and a trigger-in in a PiE server. This tutorial requires: A breadboard . Some jumper wires . Two tactile push buttons . A functioning Raspberry Pi. A PiE server to be installed. Raspberry Pi 3 pin out Here is a schematic of the Raspberry Pi 2/3 pin outs. Red is 5V, orange is 3.3V, yellow are GPIO, black are Ground, and white should not be used. Important: The Raspberry Pi GPIO pins are not 5V tolerant. Never connect a 5V line to a Raspberry GPIO pin. 1) Test the PiE server 'frame' pin with a tactile-button-switch Here, we will wire a tactile-button-switch to the the Raspberry Pi 3.3V line and the PiE frame pin (GPIO 18) to test that pushing the button registers a frame in the PiE server. This button will normally sit at LOW and take on a '3.3V ' level when pushed. 1) Wire the Raspberry Pi 3.3V pin to the '+' rail on a breadboard (red). 2) Insert a Tactile-button-switch on the breadboard. 3) Connect the top-left pin of the Tactile-button-switch to the '+' rail on the breadboard (red). 4) Connect the top-right pin of the Tactile-button-switch to the Raspberry Pi GPIO 23 . 5) The remaining bottom-left and bottom-right pins on the tactile-button-switch should not be connected to anything. Make sure the PiE server is running with ./pie run so we can see the output in the terminal. cd ~/pie ./pie stop # stop any background PiE servers ./pie run # run the PiE server on the command line In the 'Pins' section, configure the triggerIn pin to Polarity 'rising' and Pull Up/Down to 'down'. Do the same for the 'frame' pin. Make sure 'Allow arming' is checked in the Configure section. Push the frame tactile-button-switch and you should see see something like this on the command line: !!! received frame when not running If you do see this Good. Your frame pin is working. If you do not see this STOP your frame pin is not working. Please check your wiring and try again. 2) Test the PiE server 'trigger-in' pin with a tactile-button-switch Here, we will wire a tactile-button-switch to the Raspberry Pi 3.3V line and the PiE 'triggerIn' pin (GPIO 23) to test that pushing the button starts a 'trial' in the PiE server. This push-button will normally sit at LOW and take on a '3.3V' level when pushed. 1) Wire the Raspberry Pi 3.3V pin to the '+' rail on a breadboard (red). 2) Insert a Tactile-button-switch on the breadboard. 3) Connect the top-left pin of the Tactile-button-switch to the '+' rail on the breadboard (red). 4) Connect the top-right pin of the Tactile-button-switch to the Raspberry Pi GPIO 24 . 5) The remaining bottom-left and bottom-right pins on the tactile-button-switch should not be connected to anything. Make sure the PiE server is running with ./pie run so we can see the output in the terminal. cd ~/pie ./pie stop # stop any background PiE servers ./pie run # run the PiE server on the command line Make sure 'Allow arming' is checked in the Configure section. Push the trigger-in tactile-button-switch and you should see something like this on the command line: !!! received triggerIn_Callback() when camera is NOT armed If you do see this Good. Your trigger-in pin is working. If you do not see this STOP your trigger-in pin is not working. Please check your wiring and try again. Once your trigger-in pin and tactile-button-switch are working Go into the web interface and arm the recording with the arm checkbox. Push the trigger-in tactile-button-switch and video should start recording and you should see this in the command prompt: [2018-07-09 08:48:26,556] {bTrial.py startTrial:702} DEBUG - startTrial startArmVideo=True [2018-07-09 08:48:26,559] {bTrial.py startTrial:721} INFO - triggerOut pin:15 value:True Then, while the recording is still going, push the frame tactile-button-switch and you should see [2018-07-09 08:49:08,884] {bTrial.py eventIn_Callback:614} DEBUG - eventIn_Callback() frame 1 [2018-07-09 08:49:09,027] {bTrial.py eventIn_Callback:614} DEBUG - eventIn_Callback() frame 2 [2018-07-09 08:49:09,312] {bTrial.py eventIn_Callback:614} DEBUG - eventIn_Callback() frame 3 Once you done this for awhile, click the disk icon in the top tool-bar and view your videos and trial .txt files. Your videos should be watermarked with frame numbers and the .txt file should log the frame times. You will see two video files per trial, a before and after video. The after video is started when a trial is started, the before video is a 'pre-trigger' video whose length is set with 'Pre Trigger Buffer (sec)'. 3) Connecting triggerIn, triggerOut, and frame pins to a scope. Following the same logic, we can connect the Raspberry Pi triggerIn to the 'Scope Trigger Out', the Raspberry triggerOut to the 'scope Trigger In', and the Raspberry Pi frame in pin to the 'Scope Frame Out'. Keep in mind that the definition of 'in' versus 'out' is with respect to the device you are talking about. Important: The Raspberry Pi GPIO pins are not 5V tolerant. Never connect a 5V line to a Raspberry GPIO pin. We use a level-shifter to convert high voltage 5V to 3V. If your scope sends a rising high pulse for 'trigger out' and 'frame out' you can follow steps #1 and #2 above. If your scope sends a falling low pulse for either of these, you need to configure the 'pins' section of the web interface as polarity falling and Pull Up/Down as up . Raspberry Pi as the master (Scope is slave) To have the PiE server trigger your scope (Raspberry Pi is master), use the Raspberry triggerOut pin. In the web interface, if the 'Default Setting' for the triggerOut pin is set to 'false' then the PiE server will hold this pin LOW and send a 'positive' HIGH pulse when you click 'Start Trial'. The opposite is also true, if the 'Default Setting' for the triggerOut pin is set to 'true', the PiE server will hold this pin HIGH and send a LOW pulse when you click 'Start Trial'. You need to figure out what signal your scope is expecting for a trigger, it is either HIGH or LOW . Raspberry Pi as the slave (Scope is master) To have your scope trigger the PiE server (Scope is master), use the Raspberry triggerIn pin. In the web interface you 'arm' the Raspberry to 'wait for trigger' using the 'arm' checkbox. Troubleshooting If you run into trouble it is best to independently test each component of the system. In this case, you would use a volt-meter to test the signals coming off your scope are what you expect. Wiring diagram","title":"Scope"},{"location":"wiring-scope/#wiring-a-scope","text":"This is a tutorial for wiring tactile-push-buttons to trigger a frame and a trigger-in in a PiE server. This tutorial requires: A breadboard . Some jumper wires . Two tactile push buttons . A functioning Raspberry Pi. A PiE server to be installed.","title":"Wiring a scope"},{"location":"wiring-scope/#raspberry-pi-3-pin-out","text":"Here is a schematic of the Raspberry Pi 2/3 pin outs. Red is 5V, orange is 3.3V, yellow are GPIO, black are Ground, and white should not be used. Important: The Raspberry Pi GPIO pins are not 5V tolerant. Never connect a 5V line to a Raspberry GPIO pin.","title":"Raspberry Pi 3 pin out"},{"location":"wiring-scope/#1-test-the-pie-server-frame-pin-with-a-tactile-button-switch","text":"Here, we will wire a tactile-button-switch to the the Raspberry Pi 3.3V line and the PiE frame pin (GPIO 18) to test that pushing the button registers a frame in the PiE server. This button will normally sit at LOW and take on a '3.3V ' level when pushed. 1) Wire the Raspberry Pi 3.3V pin to the '+' rail on a breadboard (red). 2) Insert a Tactile-button-switch on the breadboard. 3) Connect the top-left pin of the Tactile-button-switch to the '+' rail on the breadboard (red). 4) Connect the top-right pin of the Tactile-button-switch to the Raspberry Pi GPIO 23 . 5) The remaining bottom-left and bottom-right pins on the tactile-button-switch should not be connected to anything. Make sure the PiE server is running with ./pie run so we can see the output in the terminal. cd ~/pie ./pie stop # stop any background PiE servers ./pie run # run the PiE server on the command line In the 'Pins' section, configure the triggerIn pin to Polarity 'rising' and Pull Up/Down to 'down'. Do the same for the 'frame' pin. Make sure 'Allow arming' is checked in the Configure section. Push the frame tactile-button-switch and you should see see something like this on the command line: !!! received frame when not running","title":"1) Test the PiE server 'frame' pin with a tactile-button-switch"},{"location":"wiring-scope/#if-you-do-see-this","text":"Good. Your frame pin is working.","title":"If you do see this"},{"location":"wiring-scope/#if-you-do-not-see-this","text":"STOP your frame pin is not working. Please check your wiring and try again.","title":"If you do not see this"},{"location":"wiring-scope/#2-test-the-pie-server-trigger-in-pin-with-a-tactile-button-switch","text":"Here, we will wire a tactile-button-switch to the Raspberry Pi 3.3V line and the PiE 'triggerIn' pin (GPIO 23) to test that pushing the button starts a 'trial' in the PiE server. This push-button will normally sit at LOW and take on a '3.3V' level when pushed. 1) Wire the Raspberry Pi 3.3V pin to the '+' rail on a breadboard (red). 2) Insert a Tactile-button-switch on the breadboard. 3) Connect the top-left pin of the Tactile-button-switch to the '+' rail on the breadboard (red). 4) Connect the top-right pin of the Tactile-button-switch to the Raspberry Pi GPIO 24 . 5) The remaining bottom-left and bottom-right pins on the tactile-button-switch should not be connected to anything. Make sure the PiE server is running with ./pie run so we can see the output in the terminal. cd ~/pie ./pie stop # stop any background PiE servers ./pie run # run the PiE server on the command line Make sure 'Allow arming' is checked in the Configure section. Push the trigger-in tactile-button-switch and you should see something like this on the command line: !!! received triggerIn_Callback() when camera is NOT armed","title":"2) Test the PiE server 'trigger-in' pin with a tactile-button-switch"},{"location":"wiring-scope/#if-you-do-see-this_1","text":"Good. Your trigger-in pin is working.","title":"If you do see this"},{"location":"wiring-scope/#if-you-do-not-see-this_1","text":"STOP your trigger-in pin is not working. Please check your wiring and try again.","title":"If you do not see this"},{"location":"wiring-scope/#once-your-trigger-in-pin-and-tactile-button-switch-are-working","text":"Go into the web interface and arm the recording with the arm checkbox. Push the trigger-in tactile-button-switch and video should start recording and you should see this in the command prompt: [2018-07-09 08:48:26,556] {bTrial.py startTrial:702} DEBUG - startTrial startArmVideo=True [2018-07-09 08:48:26,559] {bTrial.py startTrial:721} INFO - triggerOut pin:15 value:True Then, while the recording is still going, push the frame tactile-button-switch and you should see [2018-07-09 08:49:08,884] {bTrial.py eventIn_Callback:614} DEBUG - eventIn_Callback() frame 1 [2018-07-09 08:49:09,027] {bTrial.py eventIn_Callback:614} DEBUG - eventIn_Callback() frame 2 [2018-07-09 08:49:09,312] {bTrial.py eventIn_Callback:614} DEBUG - eventIn_Callback() frame 3 Once you done this for awhile, click the disk icon in the top tool-bar and view your videos and trial .txt files. Your videos should be watermarked with frame numbers and the .txt file should log the frame times. You will see two video files per trial, a before and after video. The after video is started when a trial is started, the before video is a 'pre-trigger' video whose length is set with 'Pre Trigger Buffer (sec)'.","title":"Once your trigger-in pin and tactile-button-switch are working"},{"location":"wiring-scope/#3-connecting-triggerin-triggerout-and-frame-pins-to-a-scope","text":"Following the same logic, we can connect the Raspberry Pi triggerIn to the 'Scope Trigger Out', the Raspberry triggerOut to the 'scope Trigger In', and the Raspberry Pi frame in pin to the 'Scope Frame Out'. Keep in mind that the definition of 'in' versus 'out' is with respect to the device you are talking about. Important: The Raspberry Pi GPIO pins are not 5V tolerant. Never connect a 5V line to a Raspberry GPIO pin. We use a level-shifter to convert high voltage 5V to 3V. If your scope sends a rising high pulse for 'trigger out' and 'frame out' you can follow steps #1 and #2 above. If your scope sends a falling low pulse for either of these, you need to configure the 'pins' section of the web interface as polarity falling and Pull Up/Down as up .","title":"3) Connecting triggerIn, triggerOut, and frame pins to a scope."},{"location":"wiring-scope/#raspberry-pi-as-the-master-scope-is-slave","text":"To have the PiE server trigger your scope (Raspberry Pi is master), use the Raspberry triggerOut pin. In the web interface, if the 'Default Setting' for the triggerOut pin is set to 'false' then the PiE server will hold this pin LOW and send a 'positive' HIGH pulse when you click 'Start Trial'. The opposite is also true, if the 'Default Setting' for the triggerOut pin is set to 'true', the PiE server will hold this pin HIGH and send a LOW pulse when you click 'Start Trial'. You need to figure out what signal your scope is expecting for a trigger, it is either HIGH or LOW .","title":"Raspberry Pi as the master (Scope is slave)"},{"location":"wiring-scope/#raspberry-pi-as-the-slave-scope-is-master","text":"To have your scope trigger the PiE server (Scope is master), use the Raspberry triggerIn pin. In the web interface you 'arm' the Raspberry to 'wait for trigger' using the 'arm' checkbox.","title":"Raspberry Pi as the slave (Scope is master)"},{"location":"wiring-scope/#troubleshooting","text":"If you run into trouble it is best to independently test each component of the system. In this case, you would use a volt-meter to test the signals coming off your scope are what you expect.","title":"Troubleshooting"},{"location":"wiring-scope/#wiring-diagram","text":"","title":"Wiring diagram"},{"location":"wiring-treadmill/","text":"Wiring a treadmill Overview The treadmill stepper motor is controlled with a motor controller which is controlled by a Teensy . The Teensy is attached to the Pi via USB and code is uploaded using the command line program platformio . Once the code is running on the Teensy, the PiE server (in pie/pie_app/bTrial.py) uses a serial connection to set treadmill motor parameters. The Teensy logs all events within a trial to memory. At the end of a trial, the PiE server (again in pie/pie_app/bTrial.py) downloads all the events and saves them to a file. The Teensy code is in pie/platformio/treadmill/src/treadmill2.cpp . Attaching a Teensy to the Raspberry Pi Attach a Teensy microcontroller to the Pi using a USB cable. Code is uploaded using a command line program called platformio . For how to do this, please refer to the pie/platformio readme. Parts See the main parts page, scroll down to the treadmill section. Wiring This is a full wiring diagram for microscope triggered video recording and using a Teensy and motor controller with a motorized treadmill. This wiring diagram is made with Fritzing , download the original pie.fzz file if you like. There are lots of connections here, they can be conceptualized as 4 different subsystems. Wiring the Teensy to Scope Trigger In , Scope Trigger Out , and Scope Frame out . Wiring the Teensy to the Raspberry Pi Wiring the stepper motor to the motor controller. Wiring the motor controller to the Teensy Important The Raspberry Pi is NOT 5V tolerant. Connecting standard lab equipment using 5V TTL pulses can damage the Pi. These 5V lines can be converted to 3V with a dedicated level shifter . Or, if you are using a Teensy, these 5V lines can pass through the Teensy which IS 5V tolerant but then outputs 3V which can go into the Raspberry Pi. In this way, the Teensy can act as a programmable level shifter . The Easy Driver Motor Driver has a nasty feature. If you connect the 12V line to the board, the Stepper motor must be plugged in or else you will fry the driver board. Thus, check the stepper motor is connected before plugging in the 12V line and check the 12V line is not plugged in before disconnecting the stepper motor. Pin table Download this pdf for a table of all pin connections between the Raspberry, motor controller, and Teensy. Serial interface The treadmill2.cpp code sets up serial communication at 115200 baud. All serial commands are a single line and must end in a carriage return (ascii 13). If a serial command is not understood by the treadmill code, it will return 'treadmill did not handle serial: ...'. Command Actions Returns h Help A list of commands v Get version Version p Get state The state of all parameters as name=value pairs d Dump Trial All events that occurred during the last trial, one line per event. Each event contains a comma separated list of (timestamp, event name, value). start Start Trial None stop Stop Trial None set,name,value Set a parameter (name) to a value (value). See table below. name=value The command to 'set' a parameter (name) to a value (value) takes the following parameter 'names'. If a 'set' command is not understood, 'SetValue() did not handle ...' is returned. name meaning possible values numEpoch Number of epochs Unsigned Integer epochDur Epoch duration (ms) Unsigned Integer preDur Pre duration (ms). Specifies a duration before all epochs. Unsigned Integer postDur Post duration (ms). Specifies a duation after all epochs. Unsigned Integer useMotor Use the motor during a trial String in (\"motorOn\", \"\") motorDel Delay before turning the motor in an epoch (ms) Unsigned Integer motorDur Duration to turn the motor in an epoch (ms) Unsigned Integer motorSpeed Speed to turn the motor(au) Unsigned Integer, 100...700 from slow to fast. arm Arm the treadmill to start a trial in response to changes in startTrialPin pin String in (\"True\", \"False\") duringPulse What to do with motor during motorDur String in (\"Rotate\", \"Locked\", \"Free\") betweenPulse What to do with motor outside of motor dur String in (\"Locked\", \"Free\") Some examples, To set the number of epochs to 5, use set,numEpoch,5 . To arm the treadmill, use set,arm,True To have the treadmill free to turn between pulses, use set,betweenPulse,Free Using the serial interface on the command line A simple yet esoteric command line program called screen can be used to establish a serial connection with an Arduino/Teensy on the command line. Install screen sudo apt-get install screen Use screen to connect to serial port. This assumes your Arduino/Teensy is at /dev/ttyACM0 . screen /dev/ttyACM0 115200 Enter some serial commands manually h v set,numEpoch,5 d You might have to hit return to get it going. Quit screen with ctrl+a then type : then type quit","title":"Treadmill"},{"location":"wiring-treadmill/#wiring-a-treadmill","text":"","title":"Wiring a treadmill"},{"location":"wiring-treadmill/#overview","text":"The treadmill stepper motor is controlled with a motor controller which is controlled by a Teensy . The Teensy is attached to the Pi via USB and code is uploaded using the command line program platformio . Once the code is running on the Teensy, the PiE server (in pie/pie_app/bTrial.py) uses a serial connection to set treadmill motor parameters. The Teensy logs all events within a trial to memory. At the end of a trial, the PiE server (again in pie/pie_app/bTrial.py) downloads all the events and saves them to a file. The Teensy code is in pie/platformio/treadmill/src/treadmill2.cpp .","title":"Overview"},{"location":"wiring-treadmill/#attaching-a-teensy-to-the-raspberry-pi","text":"Attach a Teensy microcontroller to the Pi using a USB cable. Code is uploaded using a command line program called platformio . For how to do this, please refer to the pie/platformio readme.","title":"Attaching a Teensy to the Raspberry Pi"},{"location":"wiring-treadmill/#parts","text":"See the main parts page, scroll down to the treadmill section.","title":"Parts"},{"location":"wiring-treadmill/#wiring","text":"This is a full wiring diagram for microscope triggered video recording and using a Teensy and motor controller with a motorized treadmill. This wiring diagram is made with Fritzing , download the original pie.fzz file if you like. There are lots of connections here, they can be conceptualized as 4 different subsystems. Wiring the Teensy to Scope Trigger In , Scope Trigger Out , and Scope Frame out . Wiring the Teensy to the Raspberry Pi Wiring the stepper motor to the motor controller. Wiring the motor controller to the Teensy","title":"Wiring"},{"location":"wiring-treadmill/#important","text":"The Raspberry Pi is NOT 5V tolerant. Connecting standard lab equipment using 5V TTL pulses can damage the Pi. These 5V lines can be converted to 3V with a dedicated level shifter . Or, if you are using a Teensy, these 5V lines can pass through the Teensy which IS 5V tolerant but then outputs 3V which can go into the Raspberry Pi. In this way, the Teensy can act as a programmable level shifter . The Easy Driver Motor Driver has a nasty feature. If you connect the 12V line to the board, the Stepper motor must be plugged in or else you will fry the driver board. Thus, check the stepper motor is connected before plugging in the 12V line and check the 12V line is not plugged in before disconnecting the stepper motor.","title":"Important"},{"location":"wiring-treadmill/#pin-table","text":"Download this pdf for a table of all pin connections between the Raspberry, motor controller, and Teensy.","title":"Pin table"},{"location":"wiring-treadmill/#serial-interface","text":"The treadmill2.cpp code sets up serial communication at 115200 baud. All serial commands are a single line and must end in a carriage return (ascii 13). If a serial command is not understood by the treadmill code, it will return 'treadmill did not handle serial: ...'. Command Actions Returns h Help A list of commands v Get version Version p Get state The state of all parameters as name=value pairs d Dump Trial All events that occurred during the last trial, one line per event. Each event contains a comma separated list of (timestamp, event name, value). start Start Trial None stop Stop Trial None set,name,value Set a parameter (name) to a value (value). See table below. name=value The command to 'set' a parameter (name) to a value (value) takes the following parameter 'names'. If a 'set' command is not understood, 'SetValue() did not handle ...' is returned. name meaning possible values numEpoch Number of epochs Unsigned Integer epochDur Epoch duration (ms) Unsigned Integer preDur Pre duration (ms). Specifies a duration before all epochs. Unsigned Integer postDur Post duration (ms). Specifies a duation after all epochs. Unsigned Integer useMotor Use the motor during a trial String in (\"motorOn\", \"\") motorDel Delay before turning the motor in an epoch (ms) Unsigned Integer motorDur Duration to turn the motor in an epoch (ms) Unsigned Integer motorSpeed Speed to turn the motor(au) Unsigned Integer, 100...700 from slow to fast. arm Arm the treadmill to start a trial in response to changes in startTrialPin pin String in (\"True\", \"False\") duringPulse What to do with motor during motorDur String in (\"Rotate\", \"Locked\", \"Free\") betweenPulse What to do with motor outside of motor dur String in (\"Locked\", \"Free\") Some examples, To set the number of epochs to 5, use set,numEpoch,5 . To arm the treadmill, use set,arm,True To have the treadmill free to turn between pulses, use set,betweenPulse,Free","title":"Serial interface"},{"location":"wiring-treadmill/#using-the-serial-interface-on-the-command-line","text":"A simple yet esoteric command line program called screen can be used to establish a serial connection with an Arduino/Teensy on the command line. Install screen sudo apt-get install screen Use screen to connect to serial port. This assumes your Arduino/Teensy is at /dev/ttyACM0 . screen /dev/ttyACM0 115200 Enter some serial commands manually h v set,numEpoch,5 d You might have to hit return to get it going. Quit screen with ctrl+a then type : then type quit","title":"Using the serial interface on the command line"}]}