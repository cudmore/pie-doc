



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Raspberry Pi Controlled Experiment (PiE)">
      
      
      
        <meta name="author" content="Robert H Cudmore">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../img/icons/video-camera-blue.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.2.2">
    
    
      
        <title>Wiring a treadmill - PiE Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.7a4cdee3.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="PiE Docs" class="md-header-nav__button md-logo">
          
            <img src="../img/icons/video-camera-blue.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                PiE Docs
              </span>
              <span class="md-header-nav__topic">
                Wiring a treadmill
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/cudmore/pie" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      PiE Repository
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../img/icons/video-camera-blue.png" width="24" height="24">
      
    </span>
    PiE Docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/cudmore/pie" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      PiE Repository
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Raspberry Pi Controlled Experiment (PiE)" class="md-nav__link">
      Raspberry Pi Controlled Experiment (PiE)
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../commander/" title="Commander" class="md-nav__link">
      Commander
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../file-server/" title="File server" class="md-nav__link">
      File server
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../gpio-timing/" title="Gpio timing" class="md-nav__link">
      Gpio timing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../images/" title="Images" class="md-nav__link">
      Images
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../implementation-details/" title="Implementation details" class="md-nav__link">
      Implementation details
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../install/" title="Install the PiE server" class="md-nav__link">
      Install the PiE server
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../mount-usb-drive/" title="Mount usb drive" class="md-nav__link">
      Mount usb drive
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../parts/" title="Parts" class="md-nav__link">
      Parts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../readme/" title="Raspberry Pi Controlled Experiment (PiE)" class="md-nav__link">
      Raspberry Pi Controlled Experiment (PiE)
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../release-notes/" title="Release notes" class="md-nav__link">
      Release notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rest-interface/" title="Rest interface" class="md-nav__link">
      Rest interface
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../trial-file/" title="Trial file" class="md-nav__link">
      Trial file
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../web-interface/" title="Web interface" class="md-nav__link">
      Web interface
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../wiring-behavior-box/" title="Wiring a behavior box" class="md-nav__link">
      Wiring a behavior box
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../wiring-scope/" title="Wiring a scope" class="md-nav__link">
      Wiring a scope
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Wiring a treadmill
      </label>
    
    <a href="./" title="Wiring a treadmill" class="md-nav__link md-nav__link--active">
      Wiring a treadmill
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attaching-a-teensy-to-the-raspberry-pi" title="Attaching a Teensy to the Raspberry Pi" class="md-nav__link">
    Attaching a Teensy to the Raspberry Pi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parts" title="Parts" class="md-nav__link">
    Parts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wiring" title="Wiring" class="md-nav__link">
    Wiring
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important" title="Important" class="md-nav__link">
    Important
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pin-table" title="Pin table" class="md-nav__link">
    Pin table
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serial-interface" title="Serial interface" class="md-nav__link">
    Serial interface
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-serial-interface-on-the-command-line" title="Using the serial interface on the command line" class="md-nav__link">
    Using the serial interface on the command line
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attaching-a-teensy-to-the-raspberry-pi" title="Attaching a Teensy to the Raspberry Pi" class="md-nav__link">
    Attaching a Teensy to the Raspberry Pi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parts" title="Parts" class="md-nav__link">
    Parts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wiring" title="Wiring" class="md-nav__link">
    Wiring
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important" title="Important" class="md-nav__link">
    Important
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pin-table" title="Pin table" class="md-nav__link">
    Pin table
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serial-interface" title="Serial interface" class="md-nav__link">
    Serial interface
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-serial-interface-on-the-command-line" title="Using the serial interface on the command line" class="md-nav__link">
    Using the serial interface on the command line
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="wiring-a-treadmill">Wiring a treadmill</h1>
<h2 id="overview">Overview</h2>
<p>The treadmill <a href="https://www.sparkfun.com/products/9238">stepper motor</a> is controlled with a <a href="https://www.sparkfun.com/products/12779">motor controller</a> which is controlled by a <a href="https://www.pjrc.com/store/teensy35.html">Teensy</a>. The Teensy is attached to the Pi via USB and code is uploaded using the command line program <a href="https://platformio.org/">platformio</a>. Once the code is running on the Teensy, the PiE server (in pie/pie_app/bTrial.py) uses a serial connection to set treadmill motor parameters. The Teensy logs all events within a trial to memory. At the end of a trial, the PiE server (again in pie/pie_app/bTrial.py) downloads all the events and saves them to a file.</p>
<p>The Teensy code is in <a href="https://github.com/cudmore/pie/blob/master/platformio/treadmill/src/treadmill2.cpp">pie/platformio/treadmill/src/treadmill2.cpp</a>. </p>
<h2 id="attaching-a-teensy-to-the-raspberry-pi">Attaching a Teensy to the Raspberry Pi</h2>
<p>Attach a Teensy microcontroller to the Pi using a USB cable. Code is uploaded using a command line program called <a href="https://platformio.org/">platformio</a>. For how to do this, please refer to the <a href="https://github.com/cudmore/pie/tree/master/platformio">pie/platformio</a> readme. </p>
<h2 id="parts">Parts</h2>
<p>See the main <a href="../parts/">parts</a> page, scroll down to the treadmill section.</p>
<h2 id="wiring">Wiring</h2>
<p>This is a full wiring diagram for microscope triggered video recording and using a Teensy and motor controller with a motorized treadmill. This wiring diagram is made with <a href="http://fritzing.org/home/">Fritzing</a>, download the original <a href="../../img/pie.fzz">pie.fzz</a> file if you like.</p>
<p>There are lots of connections here, they can be conceptualized as 4 different subsystems.</p>
<ol>
<li>Wiring the Teensy  to <code>Scope Trigger In</code>, <code>Scope Trigger Out</code>, and <code>Scope Frame out</code>.</li>
<li>Wiring the Teensy to the Raspberry Pi</li>
<li>Wiring the stepper motor to the motor controller.</li>
<li>Wiring the motor controller to the Teensy</li>
</ol>
<p><IMG SRC="../img/pie_fritzing.png"></p>
<h3 id="important">Important</h3>
<ul>
<li>
<p>The Raspberry Pi is <strong>NOT</strong> 5V tolerant. Connecting standard lab equipment using 5V TTL pulses can damage the Pi. These 5V lines can be converted to 3V with a <a href="https://www.adafruit.com/product/757">dedicated level shifter</a>. Or, if you are using a Teensy, these 5V lines can pass through the Teensy which <strong>IS</strong> 5V tolerant but then outputs 3V which can go into the Raspberry Pi. In this way, the Teensy can act as a programmable <a href="https://en.wikipedia.org/wiki/Level_shifter">level shifter</a>.</p>
</li>
<li>
<p>The <a href="https://www.sparkfun.com/products/12779">Easy Driver</a> Motor Driver has a nasty feature. If you connect the 12V line to the board, the Stepper motor <strong>must</strong> be plugged in or else you will fry the driver board. Thus, check the stepper motor is connected before plugging in the 12V line and check the 12V line is not plugged in before disconnecting the stepper motor.</p>
</li>
</ul>
<h3 id="pin-table">Pin table</h3>
<p>Download <a href="../../img/pie_pins.pdf">this</a> pdf for a table of all pin connections between the Raspberry, motor controller, and Teensy.</p>
<h2 id="serial-interface">Serial interface</h2>
<p>The treadmill2.cpp code sets up serial communication at 115200 baud.</p>
<p>All serial commands are a single line and must end in a carriage return (ascii 13). If a serial command is not understood by the treadmill code, it will return 'treadmill did not handle serial: ...'.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Actions</th>
<th>Returns</th>
</tr>
</thead>
<tbody>
<tr>
<td>h</td>
<td>Help</td>
<td>A list of commands</td>
</tr>
<tr>
<td>v</td>
<td>Get version</td>
<td>Version</td>
</tr>
<tr>
<td>p</td>
<td>Get state</td>
<td>The state of all parameters as name=value pairs</td>
</tr>
<tr>
<td>d</td>
<td>Dump Trial</td>
<td>All events that occurred during the last trial, one line per event. Each event contains a comma separated list of (timestamp, event name, value).</td>
</tr>
<tr>
<td>start</td>
<td>Start Trial</td>
<td>None</td>
</tr>
<tr>
<td>stop</td>
<td>Stop Trial</td>
<td>None</td>
</tr>
<tr>
<td>set,name,value</td>
<td>Set a parameter (name) to a value (value). See table below.</td>
<td>name=value</td>
</tr>
</tbody>
</table>
<p>The command to 'set' a parameter (name) to a value (value) takes the following parameter 'names'. If a 'set' command is not understood, 'SetValue() did not handle ...' is returned.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>meaning</th>
<th>possible values</th>
</tr>
</thead>
<tbody>
<tr>
<td>numEpoch</td>
<td>Number of epochs</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>epochDur</td>
<td>Epoch duration (ms)</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>preDur</td>
<td>Pre duration (ms). Specifies a duration before all epochs.</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>postDur</td>
<td>Post duration (ms). Specifies a duation after all epochs.</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>useMotor</td>
<td>Use the motor during a trial</td>
<td>String in ("motorOn", "")</td>
</tr>
<tr>
<td>motorDel</td>
<td>Delay before turning the motor in an epoch (ms)</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>motorDur</td>
<td>Duration to turn the motor in an epoch (ms)</td>
<td>Unsigned Integer</td>
</tr>
<tr>
<td>motorSpeed</td>
<td>Speed to turn the motor(au)</td>
<td>Unsigned Integer, 100...700 from slow to fast.</td>
</tr>
<tr>
<td>arm</td>
<td>Arm the treadmill to start a trial in response to changes in startTrialPin pin</td>
<td>String in ("True", "False")</td>
</tr>
<tr>
<td>duringPulse</td>
<td>What to do with motor during motorDur</td>
<td>String in ("Rotate", "Locked", "Free")</td>
</tr>
<tr>
<td>betweenPulse</td>
<td>What to do with motor outside of motor dur</td>
<td>String in ("Locked", "Free")</td>
</tr>
</tbody>
</table>
<p>Some examples, </p>
<ul>
<li>To set the number of epochs to 5, use <code>set,numEpoch,5</code>.</li>
<li>To arm the treadmill, use <code>set,arm,True</code></li>
<li>To have the treadmill free to turn between pulses, use <code>set,betweenPulse,Free</code></li>
</ul>
<h3 id="using-the-serial-interface-on-the-command-line">Using the serial interface on the command line</h3>
<p>A simple yet esoteric command line program called <code>screen</code> can be used to establish a serial connection with an Arduino/Teensy on the command line.</p>
<p>Install <code>screen</code></p>
<pre><code>sudo apt-get install screen
</code></pre>
<p>Use <code>screen</code> to connect to serial port. This assumes your Arduino/Teensy is at <code>/dev/ttyACM0</code>.</p>
<pre><code>screen /dev/ttyACM0 115200
</code></pre>
<p>Enter some serial commands manually</p>
<pre><code>h
v
set,numEpoch,5
d
</code></pre>
<p>You might have to hit <code>return</code> to get it going. Quit screen with <code>ctrl+a</code> then type <code>:</code> then type <code>quit</code></p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
      
    </div>
    
      <script src="../assets/javascripts/application.6cdc17f0.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
        <script src="../javascripts/extra.js"></script>
      
    
    
      
    
  </body>
</html>